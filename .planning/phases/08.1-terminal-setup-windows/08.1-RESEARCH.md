# Phase 8.1: Terminal Setup for Windows - Research

**Researched:** 2026-02-08
**Domain:** PowerShell scripting, Windows terminal configuration, WinGet package management
**Confidence:** MEDIUM (verified with official docs, some areas depend on WinGet availability at runtime)

## Summary

This research investigates how to create `terminal-setup.ps1`, a standalone PowerShell script that mirrors the existing `terminal-setup.sh` (Unix). The script provides an interactive wizard for installing modern CLI tools, a Nerd Font, the Starship prompt, and PowerShell aliases on Windows.

The standard approach is: use WinGet for all CLI tool installation (bat, eza, fd, ripgrep, delta, zoxide, starship), download and extract the Nerd Font ZIP from GitHub releases for per-user font installation, write `starship.toml` to `~/.config/`, and inject aliases + initialization into the PowerShell `$PROFILE` script. PowerShell aliases with parameters require wrapper functions (unlike Bash aliases). The script must detect whether the user runs PowerShell 5.1 or 7+ and write to the correct profile path.

**Primary recommendation:** Use WinGet exclusively for CLI tool installation. Install the Nerd Font via direct GitHub release download + per-user font registration (no admin required). Target PowerShell 5.1 as the minimum (ships with Windows 10/11) but detect and support PowerShell 7+.

## Standard Stack

### Core

| Tool | WinGet ID | Purpose | Why Standard |
|------|-----------|---------|--------------|
| bat | `sharkdp.bat` | cat replacement with syntax highlighting | De facto modern cat, Rust-built |
| eza | `eza-community.eza` | ls replacement with git awareness | Successor to exa, actively maintained |
| fd | `sharkdp.fd` | find replacement, fast file finder | Rust-built, respects .gitignore |
| ripgrep | `BurntSushi.ripgrep.MSVC` | grep replacement, fast recursive search | Industry standard for code search |
| delta | `dandavison.delta` | git diff pager with syntax highlighting | Best-in-class diff viewer |
| zoxide | `ajeetdsouza.zoxide` | cd replacement, smart directory jumper | Learns frequently used directories |
| starship | `Starship.Starship` | Cross-shell prompt | Same config across all shells |

### Supporting

| Component | Purpose | When to Use |
|-----------|---------|-------------|
| PSReadLine | Predictive IntelliSense, history search | Equivalent of zsh-autosuggestions (ships with PS 5.1+) |
| JetBrainsMono Nerd Font | Terminal icons and glyphs | Required for starship/eza icons |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| WinGet (for tools) | Scoop | Scoop needs separate install; WinGet ships with Windows 11 and is available on Windows 10 |
| Per-user font install | WinGet font package | No official WinGet package for JetBrainsMono Nerd Font; direct download is reliable |
| Starship | Oh My Posh | Oh My Posh is Windows-native but heavier; starship matches the Unix script's config |
| PSReadLine config | oh-my-posh plugins | PSReadLine already ships with PowerShell; zero extra dependencies |

**Installation (all via WinGet):**
```powershell
winget install --id sharkdp.bat --exact --accept-source-agreements --accept-package-agreements --silent
winget install --id eza-community.eza --exact --accept-source-agreements --accept-package-agreements --silent
winget install --id sharkdp.fd --exact --accept-source-agreements --accept-package-agreements --silent
winget install --id BurntSushi.ripgrep.MSVC --exact --accept-source-agreements --accept-package-agreements --silent
winget install --id dandavison.delta --exact --accept-source-agreements --accept-package-agreements --silent
winget install --id ajeetdsouza.zoxide --exact --accept-source-agreements --accept-package-agreements --silent
winget install --id Starship.Starship --exact --accept-source-agreements --accept-package-agreements --silent
```

## Architecture Patterns

### Script Structure (mirrors terminal-setup.sh)

```
terminal-setup.ps1 (standalone, examples/ directory)
  |-- param block (--DryRun, --Interactive)
  |-- Feature flags ($DoFont, $DoTools, $DoStarship, $DoAliases)
  |-- Logging functions (Write-Info, Write-Ok, Write-Warn, Write-Error, Write-Dry)
  |-- Interactive wizard (Ask function)
  |-- WinGet detection
  |-- Install-NerdFont (download ZIP, extract, per-user install)
  |-- Install-CliTools (WinGet idempotent install)
  |-- Setup-Starship (write starship.toml to ~/.config/)
  |-- Setup-Profile (detect PS version, write to $PROFILE)
  |-- Main entry point
```

### Pattern 1: Idempotent WinGet Install

**What:** Check if package is installed before attempting install.
**When to use:** Every WinGet install call.
**Example:**
```powershell
# Source: existing winget.ps1 in repo
function Test-WinGetInstalled {
    param([string]$PackageId)
    $output = winget list --id $PackageId --exact --accept-source-agreements 2>$null
    if ($LASTEXITCODE -eq 0 -and $output -match [regex]::Escape($PackageId)) {
        return $true
    }
    return $false
}

function Install-Tool {
    param([string]$PackageId)
    if (Test-WinGetInstalled -PackageId $PackageId) {
        Write-Ok "$PackageId already installed"
        return
    }
    if ($DryRun) {
        Write-Dry "winget install --id $PackageId"
        return
    }
    winget install --id $PackageId --exact --accept-source-agreements --accept-package-agreements --silent --source winget 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Ok "Installed: $PackageId"
    } else {
        Write-Warn "Failed to install: $PackageId"
    }
}
```

### Pattern 2: Per-User Font Installation (No Admin)

**What:** Download Nerd Font ZIP, extract, copy to per-user fonts directory, register in HKCU registry.
**When to use:** Nerd Font installation on Windows 10 1809+.
**Example:**
```powershell
# Source: Microsoft docs + community patterns
function Install-NerdFont {
    $fontDir = "$env:LOCALAPPDATA\Microsoft\Windows\Fonts"
    $regPath = 'HKCU:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Fonts'

    # Check if already installed
    if (Test-Path "$fontDir\JetBrainsMonoNerdFont-Regular.ttf") {
        Write-Ok 'JetBrainsMono Nerd Font'
        return
    }

    $url = 'https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip'
    $tmpZip = Join-Path $env:TEMP 'JetBrainsMono.zip'
    $tmpDir = Join-Path $env:TEMP 'JetBrainsMono'

    Invoke-WebRequest -Uri $url -OutFile $tmpZip -UseBasicParsing
    Expand-Archive -Path $tmpZip -DestinationPath $tmpDir -Force

    if (!(Test-Path $fontDir)) { New-Item -ItemType Directory -Path $fontDir -Force | Out-Null }

    Get-ChildItem "$tmpDir\*.ttf" | ForEach-Object {
        Copy-Item $_.FullName -Destination $fontDir -Force
        $fontName = "$($_.BaseName) (TrueType)"
        New-ItemProperty -Path $regPath -Name $fontName -Value $_.Name -PropertyType String -Force | Out-Null
    }

    Remove-Item $tmpZip -Force -ErrorAction SilentlyContinue
    Remove-Item $tmpDir -Recurse -Force -ErrorAction SilentlyContinue
}
```

### Pattern 3: PowerShell Profile Detection and Writing

**What:** Detect the correct $PROFILE path (PS 5.1 vs 7+), create if missing, append configuration.
**When to use:** When adding aliases, starship init, and zoxide init.
**Example:**
```powershell
# Source: Microsoft official docs
# $PROFILE automatic variable always resolves to correct path:
#   PS 5.1: ~\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1
#   PS 7+:  ~\Documents\PowerShell\Microsoft.PowerShell_profile.ps1

function Setup-Profile {
    $profilePath = $PROFILE

    # Create profile if it doesn't exist
    if (!(Test-Path $profilePath)) {
        New-Item -ItemType File -Path $profilePath -Force | Out-Null
        Write-Info "Created profile: $profilePath"
    }

    # Check if already configured
    $marker = '# --- terminal-setup.ps1 ---'
    $content = Get-Content $profilePath -Raw -ErrorAction SilentlyContinue
    if ($content -and $content.Contains($marker)) {
        Write-Ok "Already configured in $profilePath"
        return
    }

    # Backup existing profile
    if (Test-Path $profilePath) {
        $bak = "$profilePath.bak.$(Get-Date -Format 'yyyy-MM-dd')"
        Copy-Item $profilePath $bak -Force
        Write-Info "Backed up -> $bak"
    }

    # Append configuration block
    $block = @"

$marker

# ... aliases and init commands ...

# --- end terminal-setup.ps1 ---
"@
    Add-Content -Path $profilePath -Value $block -Encoding UTF8
}
```

### Pattern 4: PowerShell Alias Functions

**What:** Wrap commands with parameters in functions, since `Set-Alias` cannot include parameters.
**When to use:** Every alias that needs arguments (which is most of them).
**Example:**
```powershell
# Source: Microsoft Set-Alias docs
# Set-Alias only maps name->cmdlet, no parameters allowed.
# Use functions for parameterized aliases.

# Simple alias (no params)
Set-Alias -Name g -Value git

# Parameterized alias (requires function)
function gs { git status $args }
function gd { git diff $args }
function ga { git add $args }
function gc { git commit $args }
function gp { git push $args }
function gpl { git pull $args }
function gl { git log --oneline -20 $args }

# Tool replacement with fallback
if (Get-Command bat -ErrorAction SilentlyContinue) {
    Remove-Item Alias:cat -ErrorAction SilentlyContinue
    function cat { bat --paging=never $args }
}
if (Get-Command rg -ErrorAction SilentlyContinue) {
    function grep { rg $args }
}
if (Get-Command fd -ErrorAction SilentlyContinue) {
    function find { fd $args }
}
if (Get-Command eza -ErrorAction SilentlyContinue) {
    function ls { eza $args }
    function ll { eza -la --git --group-directories-first $args }
    function la { eza -a $args }
    function lt { eza --tree --level=2 $args }
}
```

### Anti-Patterns to Avoid

- **System-wide font install without checking elevation:** Per-user install works on Windows 10 1809+ without admin. Do NOT attempt `C:\Windows\Fonts\` copy without elevation check.
- **Using `New-Alias` instead of `Set-Alias`:** New-Alias errors if alias exists; Set-Alias is idempotent.
- **Hardcoding profile path:** Always use `$PROFILE` variable. Never hardcode `~\Documents\WindowsPowerShell\` or `~\Documents\PowerShell\`.
- **Assuming PowerShell 7 features in PS 5.1 script:** No null-coalescing (`??`), no ternary operator, no pipeline chain operators (`&&`, `||`) in PS 5.1.
- **Not handling existing cat/ls aliases:** PowerShell has built-in aliases (cat->Get-Content, ls->Get-ChildItem). Must `Remove-Item Alias:cat` before defining function.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Font installation | Custom font file copier | Shell.Application COM or direct copy + registry | Font registration requires OS-specific paths |
| Package manager detection | Custom WinGet finder | `Get-Command winget -ErrorAction SilentlyContinue` | Standard PowerShell pattern |
| Profile path detection | Hardcoded path builder | `$PROFILE` automatic variable | Handles PS 5.1 vs 7+ automatically |
| ZIP extraction | Custom unzip | `Expand-Archive` | Built-in since PS 5.0 |
| HTTP download | Custom downloader | `Invoke-WebRequest -UseBasicParsing` | Built-in; `-UseBasicParsing` skips IE engine on PS 5.1 |
| Idempotent WinGet check | Custom version parser | `winget list --id --exact` + output match | Matches existing repo pattern (winget.ps1) |

**Key insight:** PowerShell has many built-in cmdlets for what Bash needs external tools for (downloading, extracting, path manipulation). Use them.

## Common Pitfalls

### Pitfall 1: PowerShell 5.1 Invoke-WebRequest Without -UseBasicParsing

**What goes wrong:** On PS 5.1, `Invoke-WebRequest` uses the Internet Explorer parsing engine by default, which fails on systems where IE is uninstalled or restricted.
**Why it happens:** PS 5.1 is built on .NET Framework which defaults to IE parsing. PS 7 removed this dependency.
**How to avoid:** Always pass `-UseBasicParsing` flag. It works on both PS 5.1 and 7.
**Warning signs:** Error mentioning "Internet Explorer engine" or "response content" failure.

### Pitfall 2: Encoding When Writing to $PROFILE

**What goes wrong:** Profile written with wrong encoding, PowerShell fails to parse it on next load.
**Why it happens:** PS 5.1 defaults to system locale encoding; PS 7 defaults to UTF-8 NoBOM.
**How to avoid:** Explicitly use `-Encoding UTF8` with `Add-Content`/`Set-Content`. On PS 5.1 this produces UTF-8 with BOM, which is fine for PowerShell.
**Warning signs:** Profile loads with garbled characters or parse errors.

### Pitfall 3: Built-in Alias Conflicts (cat, ls, curl, wget)

**What goes wrong:** Defining a function `cat` or `ls` fails because PowerShell has built-in aliases mapping these to cmdlets.
**Why it happens:** PowerShell ships with `cat -> Get-Content`, `ls -> Get-ChildItem`, `curl -> Invoke-WebRequest`, `wget -> Invoke-WebRequest`.
**How to avoid:** Remove the built-in alias first: `Remove-Item Alias:cat -ErrorAction SilentlyContinue` before defining the replacement function.
**Warning signs:** "Alias not allowed because an alias with the name already exists" errors.

### Pitfall 4: WinGet Not Available on Clean Windows 10

**What goes wrong:** Script fails immediately because `winget` command not found.
**Why it happens:** WinGet ships with Windows 11 by default. On Windows 10, it requires the "App Installer" package from the Microsoft Store or a manual download.
**How to avoid:** Check `Get-Command winget` early, provide clear installation instructions if missing. Match the existing `winget.ps1` pattern in the repo.
**Warning signs:** "winget: The term 'winget' is not recognized" error.

### Pitfall 5: Font File Naming Mismatch

**What goes wrong:** Font installed but not recognized by terminal applications.
**Why it happens:** The Nerd Fonts ZIP contains many variants (Regular, Bold, Italic, Light, etc.) with different naming conventions across versions.
**How to avoid:** Check for a known font file name (e.g., `JetBrainsMonoNerdFont-Regular.ttf`) as the idempotency check. Install all `.ttf` files from the ZIP.
**Warning signs:** Terminal shows squares or question marks instead of icons.

### Pitfall 6: Profile Modification Markers

**What goes wrong:** Running the script twice duplicates configuration in $PROFILE.
**Why it happens:** No idempotency check for profile content.
**How to avoid:** Use a unique marker string (`# --- terminal-setup.ps1 ---`) and check for it before appending. Match the existing `terminal-setup.sh` pattern.
**Warning signs:** Duplicate aliases, slow profile load.

## Code Examples

### Interactive Wizard (PowerShell Equivalent)

```powershell
# Source: adapted from terminal-setup.sh wizard pattern
function Ask {
    param(
        [string]$Prompt,
        [string]$Default = 'y'
    )
    if ($Default -eq 'y') {
        $hint = '[Y/n]'
    } else {
        $hint = '[y/N]'
    }
    $response = Read-Host "  ? $Prompt $hint"
    if ([string]::IsNullOrWhiteSpace($response)) { $response = $Default }
    return $response -match '^[Yy]'
}

# Usage in wizard:
if ($Interactive) {
    Write-Host 'Choose what to install:' -ForegroundColor White
    Write-Host ''
    if (!(Ask 'Nerd Font (JetBrainsMono)?' 'y')) { $DoFont = $false }
    if (!(Ask 'CLI tools (bat, eza, fd, rg, delta, zoxide, starship)?' 'y')) { $DoTools = $false }
    if (!(Ask 'Starship prompt config?' 'y')) { $DoStarship = $false }
    if (!(Ask 'Shell aliases (20+ shortcuts)?' 'y')) { $DoAliases = $false }
}
```

### Starship Config Writer

```powershell
# Source: terminal-setup.sh starship config + starship.rs official docs
function Setup-Starship {
    $configDir = Join-Path $HOME '.config'
    $configFile = Join-Path $configDir 'starship.toml'

    if (!(Test-Path $configDir)) {
        New-Item -ItemType Directory -Path $configDir -Force | Out-Null
    }

    if (Test-Path $configFile) {
        $bak = "$configFile.bak"
        Copy-Item $configFile $bak -Force
        Write-Warn "Backed up existing starship.toml -> $bak"
    }

    # Same TOML content as terminal-setup.sh
    $toml = @'
"$schema" = "https://starship.rs/config-schema.json"

format = """
$directory\
$git_branch\
$git_status\
$cmd_duration\
$line_break\
$character"""

[directory]
truncation_length = 3
truncate_to_repo = true
style = "bold cyan"

[git_branch]
format = "[$symbol$branch]($style) "
symbol = " "
style = "bold purple"

[git_status]
format = "[$all_status$ahead_behind]($style) "
style = "bold red"

[cmd_duration]
min_time = 2000
format = "[$duration]($style) "
style = "bold yellow"

[character]
success_symbol = "[>](bold green)"
error_symbol = "[>](bold red)"

[package]
disabled = true
[nodejs]
disabled = true
[python]
disabled = true
[rust]
disabled = true
[golang]
disabled = true
[java]
disabled = true
[ruby]
disabled = true
[php]
disabled = true
[docker_context]
disabled = true
[kubernetes]
disabled = true
[aws]
disabled = true
[gcloud]
disabled = true
[azure]
disabled = true
'@
    Set-Content -Path $configFile -Value $toml -Encoding UTF8
    Write-Ok "Wrote starship.toml"
}
```

### Zoxide + Starship Init in Profile

```powershell
# Source: starship.rs official docs, zoxide GitHub README
# Add to $PROFILE:

# zoxide (smarter cd)
if (Get-Command zoxide -ErrorAction SilentlyContinue) {
    Invoke-Expression (& { (zoxide init powershell | Out-String) })
}

# Starship prompt (must be last)
if (Get-Command starship -ErrorAction SilentlyContinue) {
    Invoke-Expression (&starship init powershell)
}
```

### PSReadLine Configuration (Equivalent of zsh plugins)

```powershell
# Source: PSReadLine GitHub + Microsoft docs
# PSReadLine ships with PS 5.1+, just needs configuration

# Predictive IntelliSense (like zsh-autosuggestions)
Set-PSReadLineOption -PredictionSource History
Set-PSReadLineOption -PredictionViewStyle InlineView

# History search with arrow keys (like zsh history-substring-search)
Set-PSReadLineKeyHandler -Key UpArrow -Function HistorySearchBackward
Set-PSReadLineKeyHandler -Key DownArrow -Function HistorySearchForward

# Tab completion style
Set-PSReadLineKeyHandler -Key Tab -Function MenuComplete
```

### DryRun Pattern

```powershell
# Source: matches terminal-setup.sh dry-run pattern
function Invoke-Run {
    param([string]$Description, [scriptblock]$Action)
    if ($DryRun) {
        Write-Dry $Description
    } else {
        & $Action
    }
}

# Usage:
Invoke-Run "Install bat via WinGet" {
    winget install --id sharkdp.bat --exact --accept-source-agreements --accept-package-agreements --silent
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| System-wide font install (admin) | Per-user font install (no admin) | Windows 10 1809 (2018) | Scripts can install fonts without elevation |
| Scoop for CLI tools | WinGet for CLI tools | WinGet GA 2021 | WinGet ships with Windows, no extra setup |
| Oh My Posh (PS-only) | Starship (cross-shell) | Starship 1.0 (2022) | Same config file works on Bash, Zsh, PS |
| PSReadLine 2.0 manual install | PSReadLine ships with PS 5.1+ | PS 5.1 release (2016) | Predictive IntelliSense available out-of-box |
| `Documents\WindowsPowerShell\` | `Documents\PowerShell\` (PS 7) | PS 7 release (2020) | Two separate profile directories coexist |

**Deprecated/outdated:**
- `Shell.Application.Namespace(0x14).CopyHere()` for font install: Post-1809 this installs per-user (changed behavior), direct file copy + registry is more explicit and reliable.
- `Invoke-WebRequest` without `-UseBasicParsing`: IE engine dependency removed in PS 7, but flag still needed for PS 5.1 compatibility.

## Open Questions

1. **WinGet exact ID stability**
   - What we know: IDs like `sharkdp.bat`, `BurntSushi.ripgrep.MSVC` work as of 2026
   - What's unclear: WinGet package IDs can occasionally change (e.g., ripgrep has both `BurntSushi.ripgrep.MSVC` and `BurntSushi.ripgrep.GNU`)
   - Recommendation: Use MSVC variant for ripgrep (native Windows). Add error handling for failed installs.

2. **eza on Windows maturity**
   - What we know: `eza-community.eza` exists in WinGet; eza runs on Windows
   - What's unclear: Whether all eza features (git integration, icons) work perfectly on Windows
   - Recommendation: Install it, but don't block on it. The alias fallback pattern handles missing tools gracefully.

3. **Character encoding for starship.toml symbols**
   - What we know: The Unix script uses Unicode characters (Nerd Font glyphs) in starship.toml
   - What's unclear: Whether PS 5.1's UTF-8 with BOM causes issues with starship reading the TOML file
   - Recommendation: Use ASCII-safe symbols in the Windows version (`>` instead of Unicode arrows) or test explicitly. The code examples above use `>` for safety.

## Sources

### Primary (HIGH confidence)
- [Microsoft Learn: about_Profiles](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_profiles?view=powershell-7.5) - Profile paths for PS 5.1 and 7+
- [Microsoft Learn: Set-Alias](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/set-alias?view=powershell-7.5) - Alias limitations and function pattern
- [Microsoft Learn: Differences from Windows PowerShell](https://learn.microsoft.com/en-us/powershell/scripting/whats-new/differences-from-windows-powershell?view=powershell-7.5) - PS 5.1 vs 7 compatibility
- [Starship official site](https://starship.rs/) - PowerShell init command, config location
- [Starship config docs](https://starship.rs/config/) - Default config at ~/.config/starship.toml
- [Nerd Fonts releases](https://github.com/ryanoasis/nerd-fonts/releases) - v3.4.0, JetBrainsMono.zip download URL

### Secondary (MEDIUM confidence)
- [Alkane: Installing Fonts with PowerShell](https://www.alkanesolutions.co.uk/2021/12/06/installing-fonts-with-powershell/) - Per-user font path: `$env:LOCALAPPDATA\Microsoft\Windows\Fonts`, registry: `HKCU:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Fonts`
- [GitHub Gist: Font User Installation](https://gist.github.com/anthonyeden/0088b07de8951403a643a8485af2709b) - Shell.Application per-user font install approach
- [WinGet package pages](https://winget.ragerworks.com/) - WinGet IDs for bat, delta
- [Modern Command Line tooling - Windows edition](https://www.marczinusd.dev/articles/modern-cmdline-windows-ed) - WinGet install commands for all CLI tools
- [PSReadLine GitHub](https://github.com/PowerShell/PSReadLine) - Predictive IntelliSense configuration

### Tertiary (LOW confidence)
- [PowerShell Nerd Fonts Installer discussion](https://github.com/ryanoasis/nerd-fonts/discussions/1697) - Community font install approaches (various methods, not officially endorsed)
- [Dev.to: Starship for Windows PowerShell](https://dev.to/ganmahmud/take-your-windows-powershell-to-the-next-level-by-starship-2gb2) - Blog walkthrough of Windows starship setup

## Metadata

**Confidence breakdown:**
- Standard stack (WinGet IDs): MEDIUM - IDs verified via multiple sources but WinGet repository can change
- Architecture (script structure): HIGH - Direct port of existing terminal-setup.sh, follows established repo patterns
- Font installation: MEDIUM - Per-user font install confirmed in Microsoft docs and community, but font naming varies across Nerd Font versions
- Profile detection: HIGH - $PROFILE is official PowerShell automatic variable, documented by Microsoft
- Aliases/functions: HIGH - Set-Alias limitations are official Microsoft documentation
- Pitfalls: HIGH - Based on known PS 5.1 vs 7 differences from Microsoft docs

**Research date:** 2026-02-08
**Valid until:** 2026-03-08 (30 days - stable domain, WinGet IDs may shift)
