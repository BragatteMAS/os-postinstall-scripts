---
phase: 09-terminal-blueprint
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - examples/terminal/presets/minimal.toml
  - examples/terminal/presets/powerline.toml
  - examples/terminal/presets/p10k-alike.toml
  - examples/terminal/migrate-p10k.sh
autonomous: true

must_haves:
  truths:
    - "3 Starship preset TOML files exist in examples/terminal/presets/ (minimal, powerline, p10k-alike)"
    - "minimal preset uses ASCII-safe characters only (no Unicode glyphs)"
    - "migrate-p10k.sh detects p10k installation across all known methods (oh-my-zsh, manual, zinit, zplug, antigen, zim, brew)"
    - "migrate-p10k.sh backs up .p10k.zsh and .zshrc before any modifications"
    - "migrate-p10k.sh respects DRY_RUN for all destructive operations"
    - "migrate-p10k.sh offers preset selection after migration"
  artifacts:
    - path: "examples/terminal/presets/minimal.toml"
      provides: "ASCII-safe Starship preset matching project default style"
      contains: "success_symbol"
    - path: "examples/terminal/presets/powerline.toml"
      provides: "Powerline-style preset with colored segments and palette"
      contains: "palette"
    - path: "examples/terminal/presets/p10k-alike.toml"
      provides: "p10k Lean style approximation with two-line prompt"
      contains: "username"
    - path: "examples/terminal/migrate-p10k.sh"
      provides: "Automated p10k detection, backup, deactivation, and Starship migration"
      min_lines: 150
  key_links:
    - from: "examples/terminal/migrate-p10k.sh"
      to: "examples/terminal/presets/"
      via: "preset_dir variable and select_preset function"
      pattern: "presets/"
    - from: "examples/terminal/migrate-p10k.sh"
      to: "DRY_RUN guards"
      via: "explicit DRY_RUN == true checks before rm, sed, cp"
      pattern: 'DRY_RUN.*==.*true'
---

<objective>
Create 3 curated Starship presets and the p10k-to-Starship migration script.

Purpose: Provides the core assets for terminal replication -- presets that cover the most popular p10k styles (minimal/powerline/lean) and a migration script that safely detects, backs up, and deactivates p10k before offering Starship preset selection.

Output: 4 new files in examples/terminal/ (3 presets + migration script)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-terminal-blueprint/09-RESEARCH.md
@data/dotfiles/starship/starship.toml
@examples/terminal-setup.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 3 Starship preset TOML files</name>
  <files>
    examples/terminal/presets/minimal.toml
    examples/terminal/presets/powerline.toml
    examples/terminal/presets/p10k-alike.toml
  </files>
  <action>
Create `examples/terminal/presets/` directory and 3 preset files.

**minimal.toml** -- ASCII-safe, clean, fast prompt:
- Format: directory, git_branch, git_status, cmd_duration, line_break, character
- Use ASCII `>` for character symbol (per project decision [08.1-01] -- ASCII-safe, no Unicode arrows)
- Truncate directory to 3, truncate_to_repo = true
- Disable noisy modules: package, nodejs, python, rust, golang, java, ruby, php, docker_context, kubernetes, aws, gcloud, azure
- Style matches existing `data/dotfiles/starship/starship.toml` (this IS the project default)
- Include `"$schema"` line for editor validation

**powerline.toml** -- Nerd Font required, colored segments with arrows:
- Use palette feature (`palette = "powerline"` + `[palettes.powerline]` section)
- Format with powerline segment separators using Nerd Font glyphs (`` character U+E0B0)
- Segments: directory (blue bg), git_branch+status (purple bg), cmd_duration (yellow bg)
- Two-line with character prompt on second line
- Use `>` for character (ASCII-safe per project decision, even in Nerd Font preset)
- Disable package, nodejs, python, rust, docker_context modules
- Add comment at top noting Nerd Font requirement

**p10k-alike.toml** -- Approximates p10k Lean style:
- Two-line prompt with username, hostname (SSH only), directory, git info, cmd_duration
- Explicit git_status symbols: `?` untracked, `!` modified, `+` staged, `~` renamed, `-` deleted, `*` stashed, `=` conflicted
- Include git_state section (rebase/merge progress)
- vimcmd_symbol for vi-mode indication
- Use `>` for character (ASCII-safe)
- Disable package, nodejs, python, rust modules
- Add comment noting this approximates p10k Lean (cannot replicate instant/transient prompt)

All 3 presets must include the `"$schema" = "https://starship.rs/config-schema.json"` line.

Reference the TOML examples in 09-RESEARCH.md but adjust character symbols to use ASCII `>` per project decision.
  </action>
  <verify>
    - All 3 files exist: `ls examples/terminal/presets/*.toml | wc -l` returns 3
    - minimal.toml contains `success_symbol = "[>]` (ASCII-safe, not Unicode)
    - powerline.toml contains `palette = "powerline"` and `[palettes.powerline]`
    - p10k-alike.toml contains `[username]` and `[hostname]` sections
    - All 3 contain `"$schema"` line
    - No file contains Unicode prompt characters (only Nerd Font glyphs in powerline segment separators are acceptable)
  </verify>
  <done>
    3 preset TOML files exist in examples/terminal/presets/. minimal uses only ASCII. powerline uses palette and Nerd Font segment separators. p10k-alike includes username/hostname/git_state for lean-style prompt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create p10k migration script</name>
  <files>examples/terminal/migrate-p10k.sh</files>
  <action>
Create `examples/terminal/migrate-p10k.sh` -- a standalone script that migrates from Powerlevel10k to Starship.

**Script structure** (follow project conventions):
- Shebang: `#!/usr/bin/env bash`
- `set -euo pipefail`
- SCRIPT_DIR resolution, DRY_RUN and REMOVE_P10K flags from args
- Self-contained logging functions (log_info, log_ok, log_warn, log_error, log_dry) -- standalone script, cannot source project core modules
- `run()` wrapper for dry-run-able commands
- arg parsing: `--dry-run|-n` sets DRY_RUN=true, `--remove` sets REMOVE_P10K=true (full cleanup vs deactivate-only)
- Main guard pattern: `if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then main "$@"; fi`

**detect_p10k() function:**
- Check .zshrc for `powerlevel10k|p10k` references via grep -qE
- Check ALL known installation directories (per research):
  - `${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k`
  - `$HOME/powerlevel10k`
  - `$HOME/.zinit/plugins/romkatv---powerlevel10k`
  - `$HOME/.zplug/repos/romkatv/powerlevel10k`
  - `$HOME/.antigen/bundles/romkatv/powerlevel10k`
  - `$HOME/.zim/modules/powerlevel10k`
  - Homebrew: `$(brew --prefix)/opt/powerlevel10k` (only if brew available)
- Check for `~/.p10k.zsh` config file
- Set P10K_FOUND, P10K_DIR, P10K_CONFIG variables
- Return 1 if not found

**backup_p10k() function:**
- Create backup directory: `$HOME/.p10k-backup.$(date +%Y-%m-%d)`
- Copy .p10k.zsh if exists
- Copy .zshrc if exists
- Save P10K_DIR path to backup_dir/p10k_path.txt
- All copy operations guarded by DRY_RUN
- Log backup location

**clean_zshrc_p10k() function:**
- Guard: if .zshrc doesn't exist, return 0
- DRY_RUN guard: if true, log what would be removed and return
- Use temp file approach (mktemp), NOT sed -i (portability)
- Remove: `p10k-instant-prompt` lines (instant prompt block)
- Remove: `source.*\.p10k\.zsh` lines
- Remove: `source.*powerlevel10k\.zsh-theme` lines
- Remove: `zinit.*powerlevel10k` lines
- Remove: `zplug.*powerlevel10k` lines
- Replace: `ZSH_THEME="powerlevel10k/powerlevel10k"` with `ZSH_THEME="robbyrussell"`
- Move temp file back to .zshrc

**remove_p10k_files() function** (only called when --remove flag used):
- DRY_RUN guard on all rm operations
- Remove P10K_DIR if set and exists
- Remove `~/.p10k.zsh` if exists
- Remove `~/.cache/p10k-instant-prompt-*.zsh` files
- Log each removal

**select_preset() function:**
- Detect SCRIPT_DIR for preset path resolution
- Show numbered menu: 1) minimal (ASCII-safe, recommended), 2) powerline (Nerd Font required), 3) p10k-alike (closest to p10k Lean)
- Read user choice with default=1
- Copy selected preset to `~/.config/starship.toml` (with DRY_RUN guard)
- Backup existing starship.toml if present (with .bak.YYYY-MM-DD suffix per project pattern)

**check_starship() function:**
- Check if starship is installed via `command -v starship`
- If not: warn user, suggest install methods (brew install starship / curl -sS https://starship.rs/install.sh | sh)
- Do NOT install automatically -- this script focuses on migration, not installation

**main() function:**
- Print header with script name and purpose
- Show DRY_RUN banner if active
- Call detect_p10k; if not found, log_info "p10k not detected" and exit 0
- Show what was found (P10K_DIR, P10K_CONFIG)
- Call backup_p10k
- Call clean_zshrc_p10k
- If REMOVE_P10K is true, call remove_p10k_files; else log_info "p10k deactivated (files preserved). Use --remove for full cleanup"
- Call check_starship
- Call select_preset (only if running interactively: `[[ -t 0 ]]`)
- Print completion message with "restart terminal" reminder
  </action>
  <verify>
    - File exists and is executable concept: `head -1 examples/terminal/migrate-p10k.sh` shows bash shebang
    - Contains detect_p10k function: `grep -c 'detect_p10k()' examples/terminal/migrate-p10k.sh` returns 1
    - Contains all 7 p10k paths: `grep -c 'powerlevel10k' examples/terminal/migrate-p10k.sh` returns >= 10
    - DRY_RUN guards present: `grep -c 'DRY_RUN.*==.*true' examples/terminal/migrate-p10k.sh` returns >= 5
    - Has --remove flag support: `grep -c '\-\-remove' examples/terminal/migrate-p10k.sh` returns >= 2
    - Has main guard: `grep -c 'BASH_SOURCE' examples/terminal/migrate-p10k.sh` returns >= 1
    - Script passes basic syntax: `bash -n examples/terminal/migrate-p10k.sh` exits 0
  </verify>
  <done>
    migrate-p10k.sh exists as a standalone script that: detects p10k across all installation methods, backs up configs with timestamped directory, cleans .zshrc of p10k references, optionally removes p10k files with --remove flag, offers Starship preset selection. All destructive operations are DRY_RUN guarded.
  </done>
</task>

</tasks>

<verification>
Phase 9 Plan 01 verification:
1. `ls examples/terminal/presets/` shows minimal.toml, powerline.toml, p10k-alike.toml
2. `ls examples/terminal/migrate-p10k.sh` exists
3. `bash -n examples/terminal/migrate-p10k.sh` passes syntax check
4. `grep -l 'schema.*starship' examples/terminal/presets/*.toml | wc -l` returns 3
5. No Unicode prompt symbols in minimal.toml: `grep -c '❯\|➜\|→' examples/terminal/presets/minimal.toml` returns 0
</verification>

<success_criteria>
- 4 new files created in examples/terminal/ (3 presets + migrate-p10k.sh)
- All presets are valid TOML with schema reference
- Migration script covers all 7+ p10k installation methods
- DRY_RUN mode prevents all file modifications
- Default behavior is deactivate + backup (safe), --remove for full cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/09-terminal-blueprint/09-01-SUMMARY.md`
</output>
