---
phase: 09-terminal-blueprint
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - examples/terminal/setup.sh
  - examples/terminal-setup.sh
  - examples/terminal/README.md
autonomous: true

must_haves:
  truths:
    - "examples/terminal/setup.sh is the canonical terminal setup script (code MOVED from terminal-setup.sh, not copied)"
    - "examples/terminal-setup.sh is a pure wrapper (~15 lines) that delegates to terminal/setup.sh or exits with clear error"
    - "examples/terminal/setup.sh has --migrate flag for explicit p10k migration in non-interactive mode"
    - "offer_migration() uses subprocess (bash migrate-p10k.sh), NOT source"
    - "setup_starship() has inline TOML fallback when presets/ directory is missing"
    - "examples/terminal/README.md explains p10k migration with before/after comparison"
    - "README documents all 3 presets with descriptions and Nerd Font requirements"
  artifacts:
    - path: "examples/terminal/setup.sh"
      provides: "Canonical terminal setup with preset selection and migration integration"
      min_lines: 200
    - path: "examples/terminal-setup.sh"
      provides: "Pure wrapper that delegates to terminal/setup.sh (no fallback code)"
      max_lines: 25
    - path: "examples/terminal/README.md"
      provides: "Standalone migration guide with preset comparison and usage instructions"
      min_lines: 100
  key_links:
    - from: "examples/terminal-setup.sh"
      to: "examples/terminal/setup.sh"
      via: "exec delegation, error exit if missing"
      pattern: "exec.*terminal/setup.sh"
    - from: "examples/terminal/setup.sh"
      to: "examples/terminal/presets/"
      via: "select_preset function references preset directory"
      pattern: "presets/"
    - from: "examples/terminal/setup.sh"
      to: "examples/terminal/migrate-p10k.sh"
      via: "offer_migration runs migrate-p10k.sh as subprocess"
      pattern: "bash.*migrate-p10k"
---

<objective>
Create the canonical setup.sh (code moved from terminal-setup.sh + new features), convert terminal-setup.sh to a pure wrapper, and write the standalone README.

Purpose: Establishes examples/terminal/setup.sh as the single source of truth for terminal setup logic (SSoT). The old terminal-setup.sh becomes a ~15-line wrapper. Zero code duplication.

Output: 2 new files (examples/terminal/setup.sh, examples/terminal/README.md) + 1 modified file (examples/terminal-setup.sh as pure wrapper)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-terminal-blueprint/09-RESEARCH.md
@.planning/phases/09-terminal-blueprint/09-01-SUMMARY.md
@examples/terminal-setup.sh
@data/dotfiles/starship/starship.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create canonical examples/terminal/setup.sh</name>
  <files>examples/terminal/setup.sh</files>
  <action>
Create `examples/terminal/setup.sh` -- the canonical terminal setup script. This is the code from `terminal-setup.sh` MOVED here (not copied), plus new features.

**Design: SSoT (Single Source of Truth)**
This file IS the terminal setup logic. terminal-setup.sh will become a pure wrapper.
No code duplication. All functions live here and nowhere else.

**Script structure** (standalone, self-contained):
- Shebang: `#!/usr/bin/env bash`
- `set -euo pipefail`
- SCRIPT_DIR resolution
- Color definitions (RED, GREEN, YELLOW, BLUE, BOLD, NC)
- Flag parsing: `--dry-run|-n`, `--interactive|-i`, `--migrate` (NEW)
- Feature flags: DO_FONT, DO_TOOLS, DO_STARSHIP, DO_ALIASES, DO_PLUGINS, DO_MIGRATE (default false in non-interactive, true only with --migrate flag or wizard consent)
- Self-contained logging functions (log_info, log_ok, log_warn, log_error, log_dry)
- run() wrapper for dry-run-able commands

**Functions MOVED from terminal-setup.sh (identical logic):**
- `ask()` -- interactive wizard helper
- `detect_platform()` -- OS and package manager detection
- `detect_shell()` -- zsh/bash detection
- `ensure_deps()` -- apt dependency installation
- `install_tools()` -- CLI tools installation
- `install_nerd_font()` -- Nerd Font installation
- `install_zsh_plugins()` -- zsh plugin installation
- `setup_shell()` -- shell RC configuration (alias block, plugin sourcing, starship init)

**New functions (additions):**

- `select_preset()`:
  - Resolve preset_dir from SCRIPT_DIR/presets
  - Show numbered menu: 1) minimal (ASCII-safe, recommended), 2) powerline (Nerd Font required), 3) p10k-alike (closest to p10k Lean)
  - Default to 1 (minimal)
  - Backup existing starship.toml with .bak.YYYY-MM-DD suffix before overwrite
  - Copy selected preset to ~/.config/starship.toml (DRY_RUN guarded)

- `offer_migration()` -- **subprocess, NOT source**:
  - Quick grep of ~/.zshrc for `powerlevel10k|p10k` references
  - If found AND running interactively: ask user if they want to migrate
  - If yes: `bash "${SCRIPT_DIR}/migrate-p10k.sh" ${DRY_RUN:+--dry-run}`
  - If no or not found: return 0, continue with normal setup
  - Do NOT source migrate-p10k.sh. Subprocess only. Zero coupling.

- `wizard()` (extended):
  - Same questions as original terminal-setup.sh
  - NEW: if grep finds p10k in .zshrc, ask "Migrate from Powerlevel10k?" setting DO_MIGRATE
  - Migration question only shown when p10k is detected

**setup_starship() changes:**
- If presets/ directory exists: call select_preset() (interactive) or copy minimal.toml (non-interactive)
- If presets/ directory NOT found: write inline minimal TOML config (~15 lines) as fallback insurance
- Inline fallback uses ASCII `>` for character symbol (per [08.1-01])
- Backup existing starship.toml before overwrite in all paths

**--migrate flag behavior:**
- Non-interactive: `bash setup.sh --migrate` runs migration before setup
- Non-interactive without flag: migration skipped entirely (predictable for automation)
- Interactive: wizard asks regardless of --migrate flag

**main() function:**
- Header with script name
- DRY_RUN banner if active
- detect_platform, detect_shell
- ensure_deps
- If INTERACTIVE: wizard (extended)
- If DO_MIGRATE: offer_migration (via subprocess)
- If DO_FONT: install_nerd_font
- If DO_TOOLS: install_tools
- If DO_PLUGINS: install_zsh_plugins
- If DO_STARSHIP: setup_starship (with preset selection)
- setup_shell
- Completion message

**Main guard:** `if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then main "$@"; fi`

The script must be fully standalone -- no sourcing of project core modules. Works when downloaded individually or from git clone.
  </action>
  <verify>
    - File exists: `test -f examples/terminal/setup.sh`
    - Syntax valid: `bash -n examples/terminal/setup.sh` exits 0
    - Contains select_preset: `grep -c 'select_preset()' examples/terminal/setup.sh` returns 1
    - Migration via subprocess: `grep -c 'bash.*migrate-p10k' examples/terminal/setup.sh` returns >= 1
    - Does NOT source migrate-p10k.sh: `grep -c 'source.*migrate-p10k' examples/terminal/setup.sh` returns 0
    - Contains --migrate flag: `grep -c '\-\-migrate' examples/terminal/setup.sh` returns >= 2
    - Contains inline TOML fallback: `grep -c 'schema.*starship' examples/terminal/setup.sh` returns >= 1
    - Contains all original functions: `grep -cE 'install_tools\(\)|install_nerd_font\(\)|install_zsh_plugins\(\)|setup_shell\(\)' examples/terminal/setup.sh` returns 4
    - Has main guard: `grep -c 'BASH_SOURCE' examples/terminal/setup.sh` returns >= 1
    - Has DRY_RUN support: `grep -c 'DRY_RUN' examples/terminal/setup.sh` returns >= 5
  </verify>
  <done>
    examples/terminal/setup.sh is the canonical terminal setup script with all logic from terminal-setup.sh MOVED here plus select_preset(), offer_migration() via subprocess, --migrate flag, and inline TOML fallback. Fully standalone.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert terminal-setup.sh to pure wrapper</name>
  <files>examples/terminal-setup.sh</files>
  <action>
Replace `examples/terminal-setup.sh` with a pure wrapper. NO fallback code. ~15 lines total.

**Implementation:**
```bash
#!/usr/bin/env bash
#######################################
# terminal-setup.sh
# Wrapper — delegates to terminal/setup.sh
#
# Usage:
#   bash terminal-setup.sh                # full install (everything)
#   bash terminal-setup.sh --interactive  # wizard mode (choose components)
#   bash terminal-setup.sh --dry-run      # preview changes
#   bash terminal-setup.sh --migrate      # include p10k migration
#
# From: https://github.com/BragatteMAS/os-postinstall-scripts
#######################################

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"

if [[ -f "${SCRIPT_DIR}/terminal/setup.sh" ]]; then
    exec bash "${SCRIPT_DIR}/terminal/setup.sh" "$@"
fi

echo "Error: terminal/setup.sh not found." >&2
echo "" >&2
echo "This wrapper requires the terminal/ directory." >&2
echo "Clone the full repo: git clone https://github.com/BragatteMAS/os-postinstall-scripts" >&2
echo "Then run: bash examples/terminal/setup.sh" >&2
exit 1
```

**Key design points:**
1. NO fallback code. Zero duplication. SSoT is terminal/setup.sh.
2. Clear error message with git clone hint when terminal/ is missing.
3. Error output goes to stderr (>&2).
4. All CLI flags passed through via `"$@"`.
5. `exec` replaces process — no return after delegation.
6. Total file: ~20 lines including comments.
  </action>
  <verify>
    - File contains delegation: `grep -c 'exec bash.*terminal/setup.sh' examples/terminal-setup.sh` returns 1
    - NO fallback code: `grep -c 'install_tools\|install_nerd_font\|detect_platform' examples/terminal-setup.sh` returns 0
    - Has error message: `grep -c 'Error.*terminal/setup.sh' examples/terminal-setup.sh` returns 1
    - Has git clone hint: `grep -c 'git clone' examples/terminal-setup.sh` returns 1
    - Script passes syntax: `bash -n examples/terminal-setup.sh` exits 0
    - Under 25 lines: `wc -l examples/terminal-setup.sh` returns < 25
  </verify>
  <done>
    examples/terminal-setup.sh is a pure ~20-line wrapper. Delegates to terminal/setup.sh or exits with clear error. Zero duplicated code.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create standalone README.md with migration guide</name>
  <files>examples/terminal/README.md</files>
  <action>
Create `examples/terminal/README.md` -- a standalone documentation file for the terminal blueprint.

**Structure:**

1. **Title and badge area:**
   - `# Terminal Blueprint` with one-liner description
   - Part of [os-postinstall-scripts](https://github.com/BragatteMAS/os-postinstall-scripts)

2. **Quick Start:**
   - One-command setup: `bash setup.sh` or `bash setup.sh --interactive`
   - Migration: `bash migrate-p10k.sh` or `bash setup.sh --migrate`
   - Dry run: `bash setup.sh --dry-run`

3. **What's Included:**
   - Table of components: CLI tools, Starship prompt, Nerd Font, shell aliases, zsh plugins, p10k migration
   - Each with one-liner description

4. **Starship Presets:**
   - Table comparing 3 presets:

   | Preset | Style | Nerd Font | Best For |
   |--------|-------|-----------|----------|
   | minimal | Clean, essentials only | No | Speed, compatibility |
   | powerline | Colored segments with arrows | Yes | Visual richness |
   | p10k-alike | Two-line, lean | No (recommended: Yes) | p10k users migrating |

   - How to switch: `cp presets/NAME.toml ~/.config/starship.toml`
   - How to customize: link to https://starship.rs/config/

5. **Migrating from Powerlevel10k:**
   - Why migrate: p10k is on life support, no new features, most bugs unfixed
   - What the script does (numbered steps): detect, backup, clean .zshrc, offer preset
   - What it does NOT do: install Starship (suggest brew/curl), remove oh-my-zsh (only removes p10k theme)
   - Flags: `--dry-run` preview, `--remove` full cleanup
   - Rollback: backup location (~/.p10k-backup.YYYY-MM-DD), how to restore

6. **Before/After Comparison:**
   - Text-based comparison (not images):
   ```
   # Before (p10k lean):
   ~/projects/myapp main !1 ?2                          3s
   >

   # After (Starship p10k-alike preset):
   ~/projects/myapp main !?                             3s
   >
   ```
   - Note the key differences: slightly different status symbols, same overall feel

7. **p10k Features Not Replicated:**
   - Table of what's lost: instant prompt, transient prompt, show-on-command
   - For each: why it doesn't matter much (Starship is fast enough, etc.)

8. **Standalone Usage:**
   - These scripts work independently -- download just the examples/terminal/ directory
   - No project dependencies required
   - Works on macOS (brew) and Linux (apt)

9. **Directory Structure:**
   ```
   examples/terminal/
     setup.sh           # One-command terminal setup
     migrate-p10k.sh    # p10k to Starship migration
     README.md           # This file
     presets/
       minimal.toml     # ASCII-safe, clean prompt
       powerline.toml   # Colored segments (Nerd Font)
       p10k-alike.toml  # p10k Lean approximation
   ```

Keep the README under 200 lines. Concise, no filler. Focus on actionable information.
Do NOT use emojis.
  </action>
  <verify>
    - File exists: `test -f examples/terminal/README.md`
    - Contains preset comparison: `grep -c 'minimal\|powerline\|p10k-alike' examples/terminal/README.md` returns >= 6
    - Contains migration section: `grep -c 'migrate\|migration\|Powerlevel10k' examples/terminal/README.md` returns >= 3
    - Contains before/after: `grep -c 'Before\|After' examples/terminal/README.md` returns >= 2
    - Contains directory structure: `grep -c 'setup.sh\|migrate-p10k.sh\|presets/' examples/terminal/README.md` returns >= 3
    - Under 200 lines: `wc -l examples/terminal/README.md` returns < 200
  </verify>
  <done>
    Standalone README.md exists with quick start, preset comparison table, migration guide with before/after, p10k feature gap documentation, and directory structure reference. Under 200 lines, no filler.
  </done>
</task>

</tasks>

<verification>
Phase 9 Plan 02 verification:
1. `ls examples/terminal/setup.sh examples/terminal/README.md` both exist
2. `bash -n examples/terminal/setup.sh` passes syntax check
3. `bash -n examples/terminal-setup.sh` passes syntax check (pure wrapper)
4. `grep 'exec.*terminal/setup.sh' examples/terminal-setup.sh` shows delegation
5. `grep -c 'install_tools' examples/terminal-setup.sh` returns 0 (NO fallback code)
6. `wc -l examples/terminal-setup.sh` returns < 25 (pure wrapper)
7. `grep -c 'source.*migrate-p10k' examples/terminal/setup.sh` returns 0 (subprocess, not source)
8. `grep -c 'preset' examples/terminal/README.md` returns >= 3
9. Complete directory: `ls examples/terminal/` shows setup.sh, migrate-p10k.sh, README.md, presets/
</verification>

<success_criteria>
- examples/terminal/setup.sh is the SSoT for terminal setup (all logic lives here)
- examples/terminal-setup.sh is a pure wrapper (~20 lines, zero duplication)
- offer_migration() runs migrate-p10k.sh as subprocess (no source coupling)
- setup_starship() has inline TOML fallback when presets/ is missing
- --migrate flag enables migration in non-interactive mode
- README documents migration path, presets, and standalone usage
- All scripts pass bash -n syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/09-terminal-blueprint/09-02-SUMMARY.md`
</output>
