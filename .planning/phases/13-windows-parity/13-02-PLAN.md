---
phase: 13-windows-parity
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/platforms/windows/core/logging.psm1
  - src/platforms/windows/core/errors.psm1
  - src/platforms/windows/core/packages.psm1
  - src/platforms/windows/core/idempotent.psm1
  - tests/test-windows.ps1
autonomous: true

must_haves:
  truths:
    - "All exported functions in logging.psm1 have [CmdletBinding()] (1 function)"
    - "All exported functions in errors.psm1 have [CmdletBinding()] (4 functions)"
    - "All exported functions in packages.psm1 have [CmdletBinding()] (1 function)"
    - "All exported functions in idempotent.psm1 have [CmdletBinding()] (3 functions)"
    - "Adding [CmdletBinding()] does not break existing callers (backward compatible)"
    - "-Verbose and -Debug common parameters propagate natively through module functions"
  artifacts:
    - path: "src/platforms/windows/core/logging.psm1"
      provides: "Write-Log with CmdletBinding"
      contains: "\\[CmdletBinding\\(\\)\\]"
    - path: "src/platforms/windows/core/errors.psm1"
      provides: "Add-FailedItem, Show-FailureSummary, Get-FailureCount, Clear-Failures with CmdletBinding"
      contains: "\\[CmdletBinding\\(\\)\\]"
    - path: "src/platforms/windows/core/packages.psm1"
      provides: "Read-PackageFile with CmdletBinding"
      contains: "\\[CmdletBinding\\(\\)\\]"
    - path: "src/platforms/windows/core/idempotent.psm1"
      provides: "Test-WinGetInstalled, Test-NpmInstalled, Test-CargoInstalled with CmdletBinding"
      contains: "\\[CmdletBinding\\(\\)\\]"
  key_links:
    - from: "src/platforms/windows/core/logging.psm1"
      to: "callers (errors.psm1, progress.psm1, main.ps1, setup.ps1)"
      via: "Write-Log function signature unchanged"
      pattern: "Write-Log -Level"
    - from: "[CmdletBinding()]"
      to: "-Verbose/-Debug propagation"
      via: "PowerShell common parameters"
      pattern: "\\[CmdletBinding\\(\\)\\]"
---

<objective>
Add [CmdletBinding()] to all exported functions in the 4 core PowerShell modules, enabling native -Verbose and -Debug propagation.

Purpose: WPAR-04 requires all exported PS functions use [CmdletBinding()]. This is a mechanical, backward-compatible addition that unlocks PowerShell's common parameter infrastructure without changing any function signatures or behavior.

Output: 4 modified .psm1 files + extended tests confirming CmdletBinding presence.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-windows-parity/13-RESEARCH.md
@src/platforms/windows/core/logging.psm1
@src/platforms/windows/core/errors.psm1
@src/platforms/windows/core/packages.psm1
@src/platforms/windows/core/idempotent.psm1
@tests/test-windows.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add [CmdletBinding()] to all 9 exported functions in 4 core modules</name>
  <files>
    src/platforms/windows/core/logging.psm1
    src/platforms/windows/core/errors.psm1
    src/platforms/windows/core/packages.psm1
    src/platforms/windows/core/idempotent.psm1
  </files>
  <action>
Add `[CmdletBinding()]` attribute on the line immediately before `param(` in every exported function. This is purely additive -- no parameter changes, no logic changes, no signature changes. Existing callers are 100% backward compatible.

**IMPORTANT:** Do NOT add ShouldProcess to CmdletBinding. Per STATE.md: "No ShouldProcess/WhatIf -- breaks cross-platform DRY_RUN consistency." Use bare `[CmdletBinding()]` only.

**logging.psm1** (77 lines) -- 1 function:

- **Write-Log** (line 13, param at line 28): Insert `[CmdletBinding()]` between the comment-based help closing `#>` (line 27) and `param(` (line 28).
  ```powershell
  # Before (line 28):
      param(
  # After:
      [CmdletBinding()]
      param(
  ```

**errors.psm1** (85 lines) -- 4 functions:

- **Add-FailedItem** (line 19, param at line 30): Insert `[CmdletBinding()]` between `#>` (line 29) and `param(` (line 30).
  ```powershell
  # Before (line 30):
      param(
  # After:
      [CmdletBinding()]
      param(
  ```

- **Show-FailureSummary** (line 44, no param block): This function has comment-based help closing at line 50 then blank line 51 then `$count = ...` at line 52. Since it has NO parameters, add `[CmdletBinding()]` and an empty `param()` after the help block:
  ```powershell
  # Before (after line 50 #>):
      $count = $script:FailedItems.Count
  # After:
      [CmdletBinding()]
      param()

      $count = $script:FailedItems.Count
  ```

- **Get-FailureCount** (line 65, no param block): Has comment-based help closing at line 71 then blank line 72 then `return` at line 73. Add `[CmdletBinding()]` and empty `param()`:
  ```powershell
  # Before (after line 71 #>):
      return $script:FailedItems.Count
  # After:
      [CmdletBinding()]
      param()

      return $script:FailedItems.Count
  ```

- **Clear-Failures** (line 76, no param block): Has comment-based help closing at line 80 then blank line 81 then `$script:FailedItems = @()` at line 82. Add `[CmdletBinding()]` and empty `param()`:
  ```powershell
  # Before (after line 80 #>):
      $script:FailedItems = @()
  # After:
      [CmdletBinding()]
      param()

      $script:FailedItems = @()
  ```

**packages.psm1** (68 lines) -- 1 function:

- **Read-PackageFile** (line 17, param at line 32): Insert `[CmdletBinding()]` between `#>` (line 31) and `param(` (line 32).
  ```powershell
  # Before (line 32):
      param(
  # After:
      [CmdletBinding()]
      param(
  ```

**idempotent.psm1** (74 lines) -- 3 functions:

- **Test-WinGetInstalled** (line 12, param at line 21): Insert `[CmdletBinding()]` between `#>` (line 20) and `param(` (line 21).
  ```powershell
  # Before (line 21):
      param(
  # After:
      [CmdletBinding()]
      param(
  ```

- **Test-NpmInstalled** (line 34, param at line 43): Insert `[CmdletBinding()]` between `#>` (line 42) and `param(` (line 43).
  ```powershell
  # Before (line 43):
      param(
  # After:
      [CmdletBinding()]
      param(
  ```

- **Test-CargoInstalled** (line 52, param at line 61): Insert `[CmdletBinding()]` between `#>` (line 60) and `param(` (line 61).
  ```powershell
  # Before (line 61):
      param(
  # After:
      [CmdletBinding()]
      param(
  ```

**Total: 9 functions across 4 modules.** Each gets `[CmdletBinding()]` before its `param()`. Functions without param blocks (Show-FailureSummary, Get-FailureCount, Clear-Failures) get both `[CmdletBinding()]` and `param()` added.

Note: progress.psm1 functions (created in 13-01) already have [CmdletBinding()] from creation. No modification needed there.
  </action>
  <verify>
    Count [CmdletBinding()] occurrences in each file:
    - `(Select-String -Path src/platforms/windows/core/logging.psm1 -Pattern 'CmdletBinding').Count` should be 1
    - `(Select-String -Path src/platforms/windows/core/errors.psm1 -Pattern 'CmdletBinding').Count` should be 4
    - `(Select-String -Path src/platforms/windows/core/packages.psm1 -Pattern 'CmdletBinding').Count` should be 1
    - `(Select-String -Path src/platforms/windows/core/idempotent.psm1 -Pattern 'CmdletBinding').Count` should be 3
    - Total across 4 modules: 9
    - No `ShouldProcess` anywhere: `Select-String -Path src/platforms/windows/core/*.psm1 -Pattern 'ShouldProcess' -Quiet` returns False
  </verify>
  <done>
    All 9 exported functions across 4 core modules have [CmdletBinding()] attribute. No ShouldProcess. No signature changes. Fully backward compatible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend test-windows.ps1 with CmdletBinding verification</name>
  <files>
    tests/test-windows.ps1
  </files>
  <action>
Add CmdletBinding verification tests to `tests/test-windows.ps1`.

**Location:** Append to the "Phase 13: Windows Parity" section that was added in 13-01 (after the plan-01 tests, before the Summary section).

Add these tests:

```powershell
# CmdletBinding in core modules (WPAR-04)
Assert-Contains "[CmdletBinding] in logging.psm1 Write-Log" "$ProjectRoot/src/platforms/windows/core/logging.psm1" "CmdletBinding"
Assert-Contains "[CmdletBinding] in errors.psm1 Add-FailedItem" "$ProjectRoot/src/platforms/windows/core/errors.psm1" "CmdletBinding"
Assert-Contains "[CmdletBinding] in packages.psm1 Read-PackageFile" "$ProjectRoot/src/platforms/windows/core/packages.psm1" "CmdletBinding"
Assert-Contains "[CmdletBinding] in idempotent.psm1" "$ProjectRoot/src/platforms/windows/core/idempotent.psm1" "CmdletBinding"

# Verify count: exactly 1 in logging, 4 in errors, 1 in packages, 3 in idempotent
Assert-Pass "logging.psm1 has 1 CmdletBinding" {
    $count = (Select-String -Path "$ProjectRoot/src/platforms/windows/core/logging.psm1" -Pattern 'CmdletBinding').Count
    if ($count -ne 1) { throw "expected 1, got $count" }
}
Assert-Pass "errors.psm1 has 4 CmdletBinding" {
    $count = (Select-String -Path "$ProjectRoot/src/platforms/windows/core/errors.psm1" -Pattern 'CmdletBinding').Count
    if ($count -ne 4) { throw "expected 4, got $count" }
}
Assert-Pass "packages.psm1 has 1 CmdletBinding" {
    $count = (Select-String -Path "$ProjectRoot/src/platforms/windows/core/packages.psm1" -Pattern 'CmdletBinding').Count
    if ($count -ne 1) { throw "expected 1, got $count" }
}
Assert-Pass "idempotent.psm1 has 3 CmdletBinding" {
    $count = (Select-String -Path "$ProjectRoot/src/platforms/windows/core/idempotent.psm1" -Pattern 'CmdletBinding').Count
    if ($count -ne 3) { throw "expected 3, got $count" }
}

# Anti-pattern: no ShouldProcess anywhere
Assert-NotContains "no ShouldProcess in logging.psm1" "$ProjectRoot/src/platforms/windows/core/logging.psm1" "ShouldProcess"
Assert-NotContains "no ShouldProcess in errors.psm1" "$ProjectRoot/src/platforms/windows/core/errors.psm1" "ShouldProcess"
Assert-NotContains "no ShouldProcess in packages.psm1" "$ProjectRoot/src/platforms/windows/core/packages.psm1" "ShouldProcess"
Assert-NotContains "no ShouldProcess in idempotent.psm1" "$ProjectRoot/src/platforms/windows/core/idempotent.psm1" "ShouldProcess"

# CmdletBinding in progress.psm1 (created in 13-01, should already have it)
Assert-Contains "[CmdletBinding] in progress.psm1" "$ProjectRoot/src/platforms/windows/core/progress.psm1" "CmdletBinding"

Write-Host ""
```

The Summary section must remain as the final section of the file.
  </action>
  <verify>
    - `Select-String -Path tests/test-windows.ps1 -Pattern 'CmdletBinding'` shows multiple test lines
    - `Select-String -Path tests/test-windows.ps1 -Pattern 'ShouldProcess'` shows anti-pattern checks
    - Total test count in file increased by ~13 assertions
  </verify>
  <done>
    test-windows.ps1 verifies CmdletBinding presence and count in all 4 core modules + progress.psm1, and verifies no ShouldProcess anywhere. All WPAR-04 requirements are testable.
  </done>
</task>

</tasks>

<verification>
Phase 13 plan 02 success checks (WPAR-04):

1. `Select-String -Path src/platforms/windows/core/logging.psm1 -Pattern 'CmdletBinding' -Quiet` returns True
2. `Select-String -Path src/platforms/windows/core/errors.psm1 -Pattern 'CmdletBinding' -Quiet` returns True
3. `Select-String -Path src/platforms/windows/core/packages.psm1 -Pattern 'CmdletBinding' -Quiet` returns True
4. `Select-String -Path src/platforms/windows/core/idempotent.psm1 -Pattern 'CmdletBinding' -Quiet` returns True
5. Total [CmdletBinding()] across 4 existing modules = 9 (1+4+1+3)
6. `Select-String -Path src/platforms/windows/core/*.psm1 -Pattern 'ShouldProcess' -Quiet` returns False
7. No [CmdletBinding()] in setup.ps1 or main.ps1 (scripts, not modules)
</verification>

<success_criteria>
- All 9 exported functions in 4 core modules have [CmdletBinding()]
- No ShouldProcess/WhatIf anywhere (per project decision)
- No [CmdletBinding()] in scripts (setup.ps1, main.ps1)
- progress.psm1 functions (from 13-01) already had CmdletBinding
- test-windows.ps1 validates exact CmdletBinding counts per module
- Existing callers unaffected (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/13-windows-parity/13-02-SUMMARY.md`
</output>
