---
phase: 13-windows-parity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platforms/windows/core/progress.psm1
  - setup.ps1
  - src/platforms/windows/main.ps1
  - tests/test-windows.ps1
autonomous: true

must_haves:
  truths:
    - "Running .\\setup.ps1 -DryRun shows a DRY RUN banner and sets $env:DRY_RUN=true"
    - "Running .\\setup.ps1 -Verbose sets $env:VERBOSE=true enabling timestamps"
    - "Running .\\setup.ps1 -Unattended sets $env:UNATTENDED=true"
    - "Running .\\setup.ps1 -Help shows usage with all new switches documented"
    - "Windows installation shows [Step X/Y] prefix for each dispatch step"
    - "After Windows setup completes, user sees summary with profile, platform, duration, failure count"
    - "DRY_RUN banner appears before dispatch loop starts (not after installers begin)"
  artifacts:
    - path: "src/platforms/windows/core/progress.psm1"
      provides: "Show-DryRunBanner, Get-PlatformStepCount, Show-CompletionSummary"
      exports: ["Show-DryRunBanner", "Get-PlatformStepCount", "Show-CompletionSummary"]
    - path: "setup.ps1"
      provides: "CLI switches -DryRun, -Verbose, -Unattended + env var mapping + StartTime + summary"
      contains: "param.*DryRun.*Verbose.*Unattended"
    - path: "src/platforms/windows/main.ps1"
      provides: "Step counters in Install-Profile dispatch"
      contains: "Step.*totalSteps"
  key_links:
    - from: "setup.ps1"
      to: "src/platforms/windows/core/progress.psm1"
      via: "Import-Module progress.psm1"
      pattern: "Import-Module.*progress\\.psm1"
    - from: "setup.ps1"
      to: "Show-CompletionSummary"
      via: "function call at end of setup"
      pattern: "Show-CompletionSummary.*-Profile.*-StartTime"
    - from: "src/platforms/windows/main.ps1"
      to: "src/platforms/windows/core/progress.psm1"
      via: "Import-Module progress.psm1"
      pattern: "Import-Module.*progress\\.psm1"
    - from: "src/platforms/windows/main.ps1"
      to: "Get-PlatformStepCount"
      via: "step count before dispatch loop"
      pattern: "Get-PlatformStepCount.*-ProfileFile"
    - from: "src/platforms/windows/main.ps1"
      to: "Show-DryRunBanner"
      via: "banner call before dispatch"
      pattern: "Show-DryRunBanner"
---

<objective>
Add CLI flag switches (-DryRun, -Verbose, -Unattended), step counters ([Step X/Y]), and completion summary to the Windows setup flow, matching the Unix UX parity target.

Purpose: Windows users currently see no progress feedback and must set environment variables manually for DryRun/Verbose. After this plan, Windows UX matches Unix: CLI flags, step counters during dispatch, and a rich summary at completion.

Output: New progress.psm1 module + modified setup.ps1 and main.ps1 + extended tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-windows-parity/13-RESEARCH.md
@src/core/progress.sh
@setup.ps1
@src/platforms/windows/main.ps1
@src/platforms/windows/core/logging.psm1
@src/platforms/windows/core/errors.psm1
@tests/test-windows.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create progress.psm1 module and update setup.ps1 with CLI switches + summary</name>
  <files>
    src/platforms/windows/core/progress.psm1
    setup.ps1
  </files>
  <action>
**A. Create `src/platforms/windows/core/progress.psm1`** (NEW FILE, ~80 lines)

Mirror `src/core/progress.sh` structure. Include standard header block (#Requires -Version 5.1, description, author, date).

Import logging.psm1 at top (same pattern as errors.psm1 line 13):
```powershell
Import-Module "$PSScriptRoot/logging.psm1" -Force
```

Implement three functions (all with `[CmdletBinding()]` since they are module exports -- this satisfies WPAR-04 for these new functions):

1. **Show-DryRunBanner** -- checks `$env:DRY_RUN -eq 'true'`, calls `Write-Log -Level WARN` three times matching the Bash banner format (progress.sh lines 32-36):
   ```
   =========================================
     DRY RUN MODE - No changes will be made
   =========================================
   ```
   No-op if DRY_RUN is not 'true'. No parameters needed.

2. **Get-PlatformStepCount** -- takes `[string]$ProfileFile` (mandatory), reads profile file, counts Windows-relevant entries (winget.txt, cargo.txt, npm.txt, ai-tools.txt). Returns integer. If file doesn't exist, returns 0. Pattern: read file, trim, skip blanks/comments, switch on entry name, increment counter. Do NOT add extra steps like Unix does (+2 for dev-env/rust-cli) -- Windows has no separate dev-env step.

3. **Show-CompletionSummary** -- takes `[string]$Profile = 'unknown'`, `[string]$Platform = 'Windows'`, `[datetime]$StartTime`. Computes elapsed via `(Get-Date) - $StartTime`, extracts minutes and seconds. Reads failure count from `$env:FAILURE_LOG` file (guard with Test-Path, use `-ErrorAction SilentlyContinue`). Displays: blank line, BANNER ("Dry Run Complete" or "Setup Complete" depending on `$env:DRY_RUN`), INFO for Profile/Platform/Duration, blank line, then either WARN with failure count + listed items, or OK "All sections completed successfully", then blank line. Matches progress.sh lines 96-139 structure exactly.

Export all three: `Export-ModuleMember -Function Show-DryRunBanner, Get-PlatformStepCount, Show-CompletionSummary`

**B. Modify `setup.ps1`** (74 lines currently)

1. **Replace param block** (lines 17-20): Change from `param([string]$Profile = 'developer', [switch]$Help)` to:
   ```powershell
   param(
       [string]$Profile = 'developer',
       [switch]$DryRun,
       [switch]$Verbose,
       [switch]$Unattended,
       [switch]$Help
   )
   ```
   IMPORTANT: Do NOT add [CmdletBinding()] to setup.ps1 -- it is a script, not a module function. Per STATE.md decision, CmdletBinding is for core module functions only. Adding it would conflict with the explicit -Verbose switch (Pitfall 1 from research).

2. **Add env var mapping** after `$ErrorActionPreference = 'Continue'` (after line 22): Map CLI switches to environment variables:
   ```powershell
   if ($DryRun)     { $env:DRY_RUN = 'true' }
   if ($Verbose)    { $env:VERBOSE = 'true' }
   if ($Unattended) { $env:UNATTENDED = 'true' }
   ```

3. **Add StartTime capture** right after env var mapping:
   ```powershell
   $StartTime = Get-Date
   ```

4. **Update help text** (lines 25-37): Replace the Help block to include all new switches:
   ```powershell
   if ($Help) {
       Write-Host 'Usage: .\setup.ps1 [-Profile <name>] [-DryRun] [-Verbose] [-Unattended] [-Help]'
       Write-Host ''
       Write-Host 'Options:'
       Write-Host '  -DryRun      Show what would be done without making changes'
       Write-Host '  -Verbose     Enable debug output and timestamps'
       Write-Host '  -Unattended  Skip confirmation prompts'
       Write-Host '  -Help        Show this help message'
       Write-Host ''
       Write-Host 'Profiles:'
       Write-Host '  minimal    - Essential tools only'
       Write-Host '  developer  - Development environment (default)'
       Write-Host '  full       - Everything'
       Write-Host ''
       exit 0
   }
   ```

5. **Update Usage comment** (line 6): Change from `# Usage: .\setup.ps1 [-Profile <name>] [-Help]` to `# Usage: .\setup.ps1 [-Profile <name>] [-DryRun] [-Verbose] [-Unattended] [-Help]`

6. **Update environment variables comment** (lines 12-14): Remove the VERBOSE env var line since it's now a CLI switch. Update to note DRY_RUN and UNATTENDED env vars are set automatically by switches.

7. **Add progress.psm1 import** (after existing imports at lines 40-41):
   ```powershell
   Import-Module "$PSScriptRoot/src/platforms/windows/core/progress.psm1" -Force
   ```

8. **Replace the final section** (lines 60-74): Remove the inline failure aggregation + simple banner. Replace with a call to Show-CompletionSummary which handles everything:
   ```powershell
   Show-CompletionSummary -Profile $Profile -Platform 'Windows' -StartTime $StartTime
   exit 0
   ```
   The Show-CompletionSummary function already reads FAILURE_LOG internally and displays failures. The old FAILURE_LOG cleanup (Remove-Item) should be kept after the summary call.
  </action>
  <verify>
    Verify with pattern checks:
    - `Select-String -Path setup.ps1 -Pattern 'DryRun|Verbose|Unattended'` returns matches for all 3 switches
    - `Select-String -Path setup.ps1 -Pattern 'progress\.psm1'` confirms import
    - `Select-String -Path setup.ps1 -Pattern 'Show-CompletionSummary'` confirms summary call
    - `Select-String -Path setup.ps1 -Pattern 'StartTime'` confirms timer
    - `Test-Path src/platforms/windows/core/progress.psm1` returns True
    - `Select-String -Path src/platforms/windows/core/progress.psm1 -Pattern 'Export-ModuleMember'` confirms exports
    - No `[CmdletBinding()]` in setup.ps1 (script, not module function)
  </verify>
  <done>
    setup.ps1 accepts -DryRun/-Verbose/-Unattended switches and maps them to env vars. progress.psm1 exists with Show-DryRunBanner, Get-PlatformStepCount, Show-CompletionSummary. setup.ps1 shows rich completion summary (profile, platform, duration, failures) instead of bare "Setup Complete" banner.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add step counters and DryRun banner to main.ps1 + extend tests</name>
  <files>
    src/platforms/windows/main.ps1
    tests/test-windows.ps1
  </files>
  <action>
**A. Modify `src/platforms/windows/main.ps1`** (141 lines currently)

1. **Add progress.psm1 import** (after line 23, alongside existing imports):
   ```powershell
   Import-Module "$WindowsDir/core/progress.psm1" -Force
   ```

2. **Modify Install-Profile function** (lines 53-97) to add DryRun banner and step counters:

   After the profile file existence check (after line 66), add:
   ```powershell
   # Show DRY_RUN banner if active (before any dispatch)
   Show-DryRunBanner

   # Count Windows-relevant steps from profile
   $totalSteps = Get-PlatformStepCount -ProfileFile $profileFile
   $currentStep = 0
   ```

   Then modify each dispatch case in the foreach/switch (lines 73-96) to include step counter prefix. Replace each Write-Log message:

   - Line 76 `'winget.txt'` block: change to:
     ```powershell
     $currentStep++
     Write-Log -Level INFO -Message "[Step ${currentStep}/${totalSteps}] Installing WinGet packages..."
     ```

   - Line 80 `'cargo.txt'` block: change to:
     ```powershell
     $currentStep++
     Write-Log -Level INFO -Message "[Step ${currentStep}/${totalSteps}] Installing Cargo packages..."
     ```

   - Line 84 `'npm.txt'` block: change to:
     ```powershell
     $currentStep++
     Write-Log -Level INFO -Message "[Step ${currentStep}/${totalSteps}] Installing NPM global packages..."
     ```

   - Line 88 `'ai-tools.txt'` block: change to:
     ```powershell
     $currentStep++
     Write-Log -Level INFO -Message "[Step ${currentStep}/${totalSteps}] Installing AI tools..."
     ```

   The default case (line 91-93) stays unchanged (no step counter for skipped entries).

**B. Extend `tests/test-windows.ps1`** (155 lines currently)

Add a new section **after the Anti-pattern Checks section** (after line 147, before the Summary section at line 149) with Phase 13 tests:

```powershell
#######################################
# 4. Phase 13: Windows Parity checks
#######################################
Write-Host "--- Phase 13: Windows Parity ---"

# progress.psm1 existence
Assert-Pass "progress.psm1 exists" {
    if (-not (Test-Path "$ProjectRoot/src/platforms/windows/core/progress.psm1")) { throw "missing" }
}

# setup.ps1 CLI switches
Assert-Contains "-DryRun switch in setup.ps1" "$ProjectRoot/setup.ps1" '\[switch\]\$DryRun'
Assert-Contains "-Verbose switch in setup.ps1" "$ProjectRoot/setup.ps1" '\[switch\]\$Verbose'
Assert-Contains "-Unattended switch in setup.ps1" "$ProjectRoot/setup.ps1" '\[switch\]\$Unattended'

# Environment variable mapping
Assert-Contains "DRY_RUN env mapping in setup.ps1" "$ProjectRoot/setup.ps1" "env:DRY_RUN.*=.*'true'"
Assert-Contains "VERBOSE env mapping in setup.ps1" "$ProjectRoot/setup.ps1" "env:VERBOSE.*=.*'true'"
Assert-Contains "UNATTENDED env mapping in setup.ps1" "$ProjectRoot/setup.ps1" "env:UNATTENDED.*=.*'true'"

# StartTime and summary
Assert-Contains "StartTime in setup.ps1" "$ProjectRoot/setup.ps1" "StartTime.*=.*Get-Date"
Assert-Contains "Show-CompletionSummary in setup.ps1" "$ProjectRoot/setup.ps1" "Show-CompletionSummary"

# progress.psm1 content
Assert-Contains "Show-DryRunBanner in progress.psm1" "$ProjectRoot/src/platforms/windows/core/progress.psm1" "function Show-DryRunBanner"
Assert-Contains "Get-PlatformStepCount in progress.psm1" "$ProjectRoot/src/platforms/windows/core/progress.psm1" "function Get-PlatformStepCount"
Assert-Contains "Show-CompletionSummary in progress.psm1" "$ProjectRoot/src/platforms/windows/core/progress.psm1" "function Show-CompletionSummary"
Assert-Contains "Export-ModuleMember in progress.psm1" "$ProjectRoot/src/platforms/windows/core/progress.psm1" "Export-ModuleMember"

# Step counters in main.ps1
Assert-Contains "Step counter pattern in main.ps1" "$ProjectRoot/src/platforms/windows/main.ps1" '\[Step.*totalSteps'
Assert-Contains "Get-PlatformStepCount in main.ps1" "$ProjectRoot/src/platforms/windows/main.ps1" "Get-PlatformStepCount"
Assert-Contains "Show-DryRunBanner in main.ps1" "$ProjectRoot/src/platforms/windows/main.ps1" "Show-DryRunBanner"
Assert-Contains "progress.psm1 import in main.ps1" "$ProjectRoot/src/platforms/windows/main.ps1" "progress\.psm1"

# No CmdletBinding in scripts (only in module functions)
Assert-NotContains "no CmdletBinding in setup.ps1" "$ProjectRoot/setup.ps1" "CmdletBinding"
Assert-NotContains "no CmdletBinding in main.ps1" "$ProjectRoot/src/platforms/windows/main.ps1" "CmdletBinding"

Write-Host ""
```

Ensure the Summary section (lines 149-155) remains at the end of the file.
  </action>
  <verify>
    Verify with pattern checks:
    - `Select-String -Path src/platforms/windows/main.ps1 -Pattern 'progress\.psm1'` confirms import
    - `Select-String -Path src/platforms/windows/main.ps1 -Pattern '\[Step'` confirms step counter pattern appears
    - `Select-String -Path src/platforms/windows/main.ps1 -Pattern 'Show-DryRunBanner'` confirms banner call
    - `Select-String -Path src/platforms/windows/main.ps1 -Pattern 'Get-PlatformStepCount'` confirms step count call
    - `Select-String -Path tests/test-windows.ps1 -Pattern 'Phase 13'` confirms test section added
    - Count test assertions in test-windows.ps1 increased by ~20
  </verify>
  <done>
    main.ps1 shows [Step X/Y] prefix for each dispatch step and DryRun banner before dispatch starts. test-windows.ps1 validates all Phase 13 artifacts: progress.psm1 existence, CLI switches, env var mapping, step counters, summary call, and anti-patterns (no CmdletBinding in scripts).
  </done>
</task>

</tasks>

<verification>
Phase 13 plan 01 success checks (WPAR-01, WPAR-02, WPAR-03):

1. `Select-String -Path setup.ps1 -Pattern 'DryRun|Verbose|Unattended'` -- all three switches present
2. `Test-Path src/platforms/windows/core/progress.psm1` -- new module exists
3. `Select-String -Path src/platforms/windows/main.ps1 -Pattern '\[Step'` -- step counters in dispatch
4. `Select-String -Path setup.ps1 -Pattern 'Show-CompletionSummary'` -- summary replaces bare banner
5. `Select-String -Path setup.ps1 -Pattern 'CmdletBinding' -Quiet` returns False -- script has no CmdletBinding
6. `Select-String -Path src/platforms/windows/main.ps1 -Pattern 'CmdletBinding' -Quiet` returns False -- script has no CmdletBinding
</verification>

<success_criteria>
- setup.ps1 accepts -DryRun, -Verbose, -Unattended as CLI switches and maps them to env vars
- progress.psm1 exists with 3 exported functions (Show-DryRunBanner, Get-PlatformStepCount, Show-CompletionSummary)
- main.ps1 shows [Step X/Y] prefix for each Windows dispatch step
- main.ps1 calls Show-DryRunBanner before dispatch loop
- setup.ps1 shows completion summary with profile, platform, duration, and failure count
- No [CmdletBinding()] in setup.ps1 or main.ps1 (they are scripts, not module functions)
- test-windows.ps1 validates all Phase 13 plan 01 artifacts
</success_criteria>

<output>
After completion, create `.planning/phases/13-windows-parity/13-01-SUMMARY.md`
</output>
