---
phase: 03-dotfiles-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/dotfiles.sh
autonomous: true

must_haves:
  truths:
    - "Symlinks created in $HOME point to data/dotfiles/ sources"
    - "Existing non-symlink files are backed up before replacement"
    - "Backup manifest records all backup operations"
    - "DRY_RUN mode shows what would happen without making changes"
  artifacts:
    - path: "src/core/dotfiles.sh"
      provides: "Symlink management functions"
      exports: ["create_dotfile_symlink", "unlink_dotfiles", "backup_with_manifest"]
      min_lines: 100
  key_links:
    - from: "src/core/dotfiles.sh"
      to: "src/core/logging.sh"
      via: "source"
      pattern: "source.*logging\\.sh"
    - from: "src/core/dotfiles.sh"
      to: "~/.dotfiles-backup/"
      via: "backup operations"
      pattern: "dotfiles-backup"
---

<objective>
Implement the core dotfiles symlink manager utility with backup functionality.

Purpose: Provides reusable functions for creating symlinks from $HOME to data/dotfiles/, with automatic backup of existing configs. This is the foundation for all dotfiles operations in this phase.

Output: src/core/dotfiles.sh with create_dotfile_symlink(), unlink_dotfiles(), and backup management functions.
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dotfiles-management/03-CONTEXT.md
@.planning/phases/03-dotfiles-management/03-RESEARCH.md

# Existing core utilities (patterns to follow)
@src/core/logging.sh
@src/core/idempotent.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dotfiles.sh core utility</name>
  <files>src/core/dotfiles.sh</files>
  <action>
Create src/core/dotfiles.sh with the following functions:

1. **Source guard pattern** (match existing core files):
   ```bash
   [[ -n "${_DOTFILES_SOURCED:-}" ]] && return 0
   readonly _DOTFILES_SOURCED=1
   ```

2. **Constants**:
   - BACKUP_DIR="${HOME}/.dotfiles-backup"
   - MANIFEST_FILE="${BACKUP_DIR}/backup-manifest.txt"
   - Date format: YYYY-MM-DD HH:MM:SS

3. **path_to_backup_name()** - Helper function to convert file path to backup name:
   - Algorithm:
     1. Remove $HOME prefix (e.g., /Users/foo/.config/git/ignore -> .config/git/ignore)
     2. Remove leading dots and slashes (-> config/git/ignore)
     3. Replace remaining "/" with "-" (-> config-git-ignore)
     4. Append ".bak.YYYY-MM-DD"
   - Example: ~/.config/git/ignore -> config-git-ignore.bak.2026-02-05
   - Example: ~/.zshrc -> zshrc.bak.2026-02-05
   - This implements the "flat with path prefix" pattern from CONTEXT.md
   - Implementation hint:
     ```bash
     path_to_backup_name() {
         local file="$1"
         local name="${file#$HOME/}"      # Remove $HOME/
         name="${name#.}"                  # Remove leading dot
         name="${name//\//-}"              # Replace / with -
         echo "${name}.bak.$(date +%Y-%m-%d)"
     }
     ```

4. **backup_with_manifest()**:
   - Args: source_file (what to backup)
   - Calls path_to_backup_name() to derive backup_name
   - Creates BACKUP_DIR if missing
   - Uses cp -p to preserve permissions
   - Appends to manifest: "TIMESTAMP | original -> backup"
   - Respects DRY_RUN: if set, log what would happen but don't copy
   - Returns 1 on failure (abort signal per CONTEXT.md)

5. **create_dotfile_symlink()**:
   - Args: source (absolute path in data/dotfiles/), target (absolute path in $HOME)
   - CRITICAL: If target parent dir missing: mkdir -p first (e.g., ~/.config/git/ for ~/.config/git/ignore)
   - If target exists and is NOT a symlink: call backup_with_manifest, then replace
   - If target exists and IS a symlink: replace without backup (per CONTEXT.md)
   - Uses ln -sfn (symbolic, force, no-dereference)
   - Respects DRY_RUN
   - Log summary: "Linked: ~/.config/git/ignore -> /path/to/data/dotfiles/git/gitignore"

6. **unlink_dotfiles()**:
   - Args: target (path to symlink to remove)
   - Removes symlink
   - Reads manifest to find most recent backup for this target
   - Restores backup if found, warns if multiple backups exist
   - Respects DRY_RUN

7. **show_backup_summary()**:
   - Lists all backups made in current session
   - Format matches CONTEXT.md: "Backed up: ~/.zshrc -> ~/.dotfiles-backup/zshrc.bak.2026-02-05"

Follow patterns from logging.sh and idempotent.sh:
- Source logging.sh for log_ok, log_error, log_info, log_warn
- Export all functions for subshells
- No set -e (per Phase 1 decision)
  </action>
  <verify>
    - File exists: `[[ -f src/core/dotfiles.sh ]]`
    - Source guard present: `rg '_DOTFILES_SOURCED' src/core/dotfiles.sh`
    - Functions exist: `rg 'create_dotfile_symlink|backup_with_manifest|unlink_dotfiles|path_to_backup_name' src/core/dotfiles.sh`
    - Sources logging.sh: `rg 'source.*logging' src/core/dotfiles.sh`
    - Has mkdir -p for parent: `rg 'mkdir -p.*dirname' src/core/dotfiles.sh`
    - Has path conversion: `rg 'tr.*/' src/core/dotfiles.sh` or `rg 'sed.*/' src/core/dotfiles.sh`
    - Syntax check: `bash -n src/core/dotfiles.sh`
  </verify>
  <done>
    - src/core/dotfiles.sh exists with ~100+ lines
    - Contains path_to_backup_name() that converts ~/.config/git/ignore to config-git-ignore.bak.DATE
    - Contains create_dotfile_symlink() with mkdir -p for parent directories
    - Contains backup_with_manifest(), unlink_dotfiles(), show_backup_summary()
    - Sources logging.sh and uses log_* functions
    - Respects DRY_RUN environment variable
    - bash -n passes (no syntax errors)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create integration test script</name>
  <files>tests/test-dotfiles.sh</files>
  <action>
Create tests/test-dotfiles.sh that validates the dotfiles utility:

1. Create test directory structure in /tmp/test-dotfiles-$$
2. Source src/core/dotfiles.sh
3. Test cases:
   - path_to_backup_name converts ~/.config/git/ignore to config-git-ignore.bak.DATE
   - path_to_backup_name converts ~/.zshrc to zshrc.bak.DATE
   - create_dotfile_symlink creates parent directory if needed (test with nested path)
   - create_dotfile_symlink creates symlink correctly
   - Existing file is backed up before symlink with correct naming pattern
   - Backup appears in manifest
   - Existing symlink is replaced without backup
   - DRY_RUN=true doesn't modify files
   - unlink_dotfiles removes symlink and restores backup
4. Cleanup test directory on exit (trap)
5. Exit 0 if all tests pass, exit 1 on any failure

Keep it simple - just bash assertions, no test framework.
  </action>
  <verify>
    - File exists: `[[ -f tests/test-dotfiles.sh ]]`
    - Is executable: `chmod +x tests/test-dotfiles.sh`
    - Run tests: `bash tests/test-dotfiles.sh`
  </verify>
  <done>
    - tests/test-dotfiles.sh exists and is executable
    - All test cases pass when run
    - Tests clean up after themselves
  </done>
</task>

</tasks>

<verification>
All verification automated:

```bash
# Syntax check
bash -n src/core/dotfiles.sh

# Run tests
bash tests/test-dotfiles.sh

# Verify functions are exported
source src/core/dotfiles.sh && type create_dotfile_symlink

# Verify backup naming pattern
source src/core/dotfiles.sh && path_to_backup_name "$HOME/.config/git/ignore"
# Expected: config-git-ignore.bak.YYYY-MM-DD
```
</verification>

<success_criteria>
- src/core/dotfiles.sh provides reusable symlink management
- Backup naming follows CONTEXT.md pattern: flat with path prefix (config-git-ignore.bak.DATE)
- create_dotfile_symlink creates parent directories (mkdir -p)
- DRY_RUN is respected
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-dotfiles-management/03-01-SUMMARY.md`
</output>
