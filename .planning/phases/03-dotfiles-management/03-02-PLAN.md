---
phase: 03-dotfiles-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - data/dotfiles/shared/path.sh
  - data/dotfiles/shared/env.sh
  - data/dotfiles/shared/aliases.sh
  - data/dotfiles/zsh/zshrc
  - data/dotfiles/zsh/functions.sh
  - data/dotfiles/zsh/plugins.sh
  - data/dotfiles/bash/bashrc
autonomous: true

must_haves:
  truths:
    - "Zshrc sources shared configs in correct order (path, env, aliases, functions, plugins, prompt)"
    - "Bashrc sources shared configs (path, env, aliases)"
    - "PATH has duplicate prevention"
    - "Local overrides are sourced if they exist (~/.zshrc.local, ~/.bashrc.local)"
    - "Starship prompt initializes if available"
    - "zsh-syntax-highlighting sources LAST (per pitfall)"
  artifacts:
    - path: "data/dotfiles/shared/path.sh"
      provides: "PATH management with dedup"
      contains: "add_to_path"
    - path: "data/dotfiles/shared/aliases.sh"
      provides: "Cross-shell aliases"
      min_lines: 20
    - path: "data/dotfiles/zsh/zshrc"
      provides: "Main zsh configuration"
      contains: "starship init zsh"
    - path: "data/dotfiles/zsh/plugins.sh"
      provides: "zsh plugin loading"
      contains: "zsh-syntax-highlighting"
    - path: "data/dotfiles/bash/bashrc"
      provides: "Main bash configuration"
      contains: "starship init bash"
  key_links:
    - from: "data/dotfiles/zsh/zshrc"
      to: "data/dotfiles/shared/path.sh"
      via: "source"
      pattern: "source.*shared.*path"
    - from: "data/dotfiles/zsh/zshrc"
      to: "starship"
      via: "eval init"
      pattern: "starship init zsh"
---

<objective>
Create shell configuration files (zsh and bash) with modular sourcing pattern.

Purpose: Provides the actual dotfiles that will be symlinked to $HOME. Zsh is primary with bash as fallback. Configs are modular: shared configs for cross-shell compatibility, shell-specific configs for features unique to each shell.

Output: Complete shell configurations in data/dotfiles/{shared,zsh,bash}/ ready for symlinking.
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dotfiles-management/03-CONTEXT.md
@.planning/phases/03-dotfiles-management/03-RESEARCH.md

# Reference existing bash config
@data/dotfiles/bash/bashrc.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared configuration files</name>
  <files>
    data/dotfiles/shared/path.sh
    data/dotfiles/shared/env.sh
    data/dotfiles/shared/aliases.sh
  </files>
  <action>
Create data/dotfiles/shared/ directory and files:

**path.sh** - PATH management:
```bash
# PATH management with duplicate prevention
# Sourced by both zsh and bash

add_to_path() {
    local new_path="$1"
    case ":$PATH:" in
        *":$new_path:"*) return 0 ;;
    esac
    export PATH="$new_path:$PATH"
}

# Common paths
[[ -d "$HOME/.local/bin" ]] && add_to_path "$HOME/.local/bin"
[[ -d "$HOME/.cargo/bin" ]] && add_to_path "$HOME/.cargo/bin"
[[ -d "$HOME/go/bin" ]] && add_to_path "$HOME/go/bin"
[[ -d "/opt/homebrew/bin" ]] && add_to_path "/opt/homebrew/bin"
```

**env.sh** - Environment variables:
```bash
# Environment variables
# Sourced by both zsh and bash

export EDITOR="${EDITOR:-vim}"
export VISUAL="${VISUAL:-$EDITOR}"
export PAGER="${PAGER:-less}"
export LANG="${LANG:-en_US.UTF-8}"
export LC_ALL="${LC_ALL:-en_US.UTF-8}"

# Less options
export LESS="-R -F -X"
```

**aliases.sh** - Cross-shell aliases:
```bash
# Aliases compatible with both zsh and bash

# Navigation
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."

# List (use eza if available, else ls with color)
if command -v eza &>/dev/null; then
    alias ls="eza"
    alias ll="eza -la"
    alias la="eza -a"
    alias lt="eza --tree --level=2"
else
    alias ls="ls --color=auto"
    alias ll="ls -la"
    alias la="ls -A"
fi

# Safety
alias rm="rm -i"
alias cp="cp -i"
alias mv="mv -i"

# Git shortcuts (supplement git aliases)
alias g="git"
alias gs="git status"
alias gd="git diff"
alias ga="git add"
alias gc="git commit"
alias gp="git push"
alias gl="git pull"

# Modern replacements (if available)
command -v bat &>/dev/null && alias cat="bat --paging=never"
command -v fd &>/dev/null && alias find="fd"
command -v rg &>/dev/null && alias grep="rg"
```
  </action>
  <verify>
    - Directory exists: `[[ -d data/dotfiles/shared ]]`
    - Files exist: `ls data/dotfiles/shared/`
    - path.sh has add_to_path: `rg 'add_to_path' data/dotfiles/shared/path.sh`
    - aliases.sh has eza check: `rg 'eza' data/dotfiles/shared/aliases.sh`
  </verify>
  <done>
    - data/dotfiles/shared/path.sh exists with PATH dedup function
    - data/dotfiles/shared/env.sh exists with EDITOR, PAGER, LANG
    - data/dotfiles/shared/aliases.sh exists with navigation, safety, git, modern tool aliases
  </done>
</task>

<task type="auto">
  <name>Task 2: Create zsh configuration files</name>
  <files>
    data/dotfiles/zsh/zshrc
    data/dotfiles/zsh/functions.sh
    data/dotfiles/zsh/plugins.sh
  </files>
  <action>
Create zsh configuration files (remove .gitkeep if present):

**zshrc** - Main zsh configuration:
```bash
#!/usr/bin/env zsh
# Main zsh configuration
# Symlinked to ~/.zshrc

# History configuration
HISTFILE="${HOME}/.zsh_history"
HISTSIZE=50000
SAVEHIST=50000

setopt EXTENDED_HISTORY       # Write timestamp to history
setopt HIST_EXPIRE_DUPS_FIRST # Expire duplicates first
setopt HIST_IGNORE_DUPS       # Ignore consecutive duplicates
setopt HIST_IGNORE_SPACE      # Ignore commands starting with space
setopt HIST_REDUCE_BLANKS     # Remove extra blanks
setopt SHARE_HISTORY          # Share history between sessions
setopt INC_APPEND_HISTORY     # Add commands immediately

# Completion
autoload -Uz compinit
compinit -C  # -C skips security check for faster startup

# Determine dotfiles location
# IMPORTANT: Use readlink to resolve symlink, otherwise paths break
# when ~/.zshrc is a symlink to data/dotfiles/zsh/zshrc
_zshrc_real="${(%):-%x}"
[[ -L "$_zshrc_real" ]] && _zshrc_real="$(readlink -f "$_zshrc_real" 2>/dev/null || readlink "$_zshrc_real")"
DOTFILES_DIR="${DOTFILES_DIR:-$(cd "$(dirname "$_zshrc_real")/.." && pwd)}"
unset _zshrc_real
DOTFILES_SHARED="${DOTFILES_DIR}/shared"
DOTFILES_ZSH="${DOTFILES_DIR}/zsh"

# Source order: path, env, aliases, functions, plugins, prompt
# (per CONTEXT.md decision)
[[ -f "${DOTFILES_SHARED}/path.sh" ]] && source "${DOTFILES_SHARED}/path.sh"
[[ -f "${DOTFILES_SHARED}/env.sh" ]] && source "${DOTFILES_SHARED}/env.sh"
[[ -f "${DOTFILES_SHARED}/aliases.sh" ]] && source "${DOTFILES_SHARED}/aliases.sh"
[[ -f "${DOTFILES_ZSH}/functions.sh" ]] && source "${DOTFILES_ZSH}/functions.sh"
[[ -f "${DOTFILES_ZSH}/plugins.sh" ]] && source "${DOTFILES_ZSH}/plugins.sh"

# fzf integration (if installed)
[[ -f ~/.fzf.zsh ]] && source ~/.fzf.zsh

# Starship prompt (if available)
command -v starship &>/dev/null && eval "$(starship init zsh)"

# Local overrides (last, so user can override anything)
[[ -f "${HOME}/.zshrc.local" ]] && source "${HOME}/.zshrc.local"
```

**functions.sh** - zsh-specific functions:
```bash
# zsh-specific functions

# mkcd - create directory and cd into it
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# extract - universal archive extractor
extract() {
    if [[ -f "$1" ]]; then
        case "$1" in
            *.tar.bz2) tar xjf "$1" ;;
            *.tar.gz)  tar xzf "$1" ;;
            *.tar.xz)  tar xJf "$1" ;;
            *.bz2)     bunzip2 "$1" ;;
            *.gz)      gunzip "$1" ;;
            *.tar)     tar xf "$1" ;;
            *.tbz2)    tar xjf "$1" ;;
            *.tgz)     tar xzf "$1" ;;
            *.zip)     unzip "$1" ;;
            *.Z)       uncompress "$1" ;;
            *.7z)      7z x "$1" ;;
            *)         echo "'$1' cannot be extracted" ;;
        esac
    else
        echo "'$1' is not a valid file"
    fi
}
```

**plugins.sh** - Plugin loading (MUST source zsh-syntax-highlighting LAST):
```bash
# zsh plugin loading
# NOTE: zsh-syntax-highlighting MUST be sourced LAST (per RESEARCH.md pitfall)

ZSH_PLUGINS_DIR="${HOME}/.zsh"

# zsh-autosuggestions (first)
if [[ -f "${ZSH_PLUGINS_DIR}/zsh-autosuggestions/zsh-autosuggestions.zsh" ]]; then
    source "${ZSH_PLUGINS_DIR}/zsh-autosuggestions/zsh-autosuggestions.zsh"
    ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=8"
    ZSH_AUTOSUGGEST_STRATEGY=(history completion)
fi

# zsh-syntax-highlighting (MUST BE LAST)
if [[ -f "${ZSH_PLUGINS_DIR}/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]]; then
    source "${ZSH_PLUGINS_DIR}/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
fi
```
  </action>
  <verify>
    - Files exist: `ls data/dotfiles/zsh/`
    - zshrc sources shared: `rg 'DOTFILES_SHARED' data/dotfiles/zsh/zshrc`
    - plugins.sh has syntax-highlighting last: `tail -5 data/dotfiles/zsh/plugins.sh | rg 'syntax-highlighting'`
    - Starship init: `rg 'starship init zsh' data/dotfiles/zsh/zshrc`
  </verify>
  <done>
    - data/dotfiles/zsh/zshrc exists with history, sourcing, starship
    - data/dotfiles/zsh/functions.sh exists with mkcd, extract
    - data/dotfiles/zsh/plugins.sh exists with syntax-highlighting sourced LAST
    - .gitkeep removed if it existed
  </done>
</task>

<task type="auto">
  <name>Task 3: Update bash configuration</name>
  <files>data/dotfiles/bash/bashrc</files>
  <action>
Create data/dotfiles/bash/bashrc (rename/consolidate with existing bashrc.sh):

**bashrc** - Main bash configuration:
```bash
#!/usr/bin/env bash
# Main bash configuration
# Symlinked to ~/.bashrc

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

# History configuration
HISTFILE="${HOME}/.bash_history"
HISTSIZE=50000
HISTFILESIZE=50000
HISTCONTROL=ignoreboth:erasedups
shopt -s histappend

# Shell options
shopt -s checkwinsize  # Update LINES/COLUMNS after each command
shopt -s globstar      # ** matches all files and subdirectories
shopt -s cdspell       # Autocorrect typos in cd

# Determine dotfiles location
# IMPORTANT: Use readlink to resolve symlink, otherwise paths break
# when ~/.bashrc is a symlink to data/dotfiles/bash/bashrc
_bashrc_real="${BASH_SOURCE[0]}"
[[ -L "$_bashrc_real" ]] && _bashrc_real="$(readlink -f "$_bashrc_real" 2>/dev/null || readlink "$_bashrc_real")"
DOTFILES_DIR="${DOTFILES_DIR:-$(cd "$(dirname "$_bashrc_real")/.." && pwd)}"
unset _bashrc_real
DOTFILES_SHARED="${DOTFILES_DIR}/shared"

# Source shared configs (path, env, aliases)
[[ -f "${DOTFILES_SHARED}/path.sh" ]] && source "${DOTFILES_SHARED}/path.sh"
[[ -f "${DOTFILES_SHARED}/env.sh" ]] && source "${DOTFILES_SHARED}/env.sh"
[[ -f "${DOTFILES_SHARED}/aliases.sh" ]] && source "${DOTFILES_SHARED}/aliases.sh"

# Starship prompt (if available)
command -v starship &>/dev/null && eval "$(starship init bash)"

# fzf integration (if installed)
[[ -f ~/.fzf.bash ]] && source ~/.fzf.bash

# Local overrides
[[ -f "${HOME}/.bashrc.local" ]] && source "${HOME}/.bashrc.local"
```

NOTE: Create `bashrc` as a NEW file. Keep existing `bashrc.sh` and `.bashrc_example` untouched as reference. Only `bashrc` (without .sh extension) gets symlinked to ~/.bashrc.
  </action>
  <verify>
    - File exists: `[[ -f data/dotfiles/bash/bashrc ]]`
    - Sources shared: `rg 'DOTFILES_SHARED' data/dotfiles/bash/bashrc`
    - Starship init: `rg 'starship init bash' data/dotfiles/bash/bashrc`
    - Interactive check: `rg '\$- != \*i\*' data/dotfiles/bash/bashrc`
  </verify>
  <done>
    - data/dotfiles/bash/bashrc exists with history, sourcing, starship
    - Sources shared configs (path, env, aliases)
    - Has interactive check at start
    - Local overrides sourced at end
  </done>
</task>

</tasks>

<verification>
```bash
# Structure check
ls -la data/dotfiles/{shared,zsh,bash}/

# Key patterns present
rg 'add_to_path' data/dotfiles/shared/path.sh
rg 'starship init' data/dotfiles/*/
rg 'zsh-syntax-highlighting' data/dotfiles/zsh/plugins.sh
```
</verification>

<success_criteria>
- All config files created in data/dotfiles/
- Zsh and bash both source shared configs
- Source order matches CONTEXT.md decision
- Starship prompt integration in both shells
- zsh-syntax-highlighting sourced LAST
</success_criteria>

<output>
After completion, create `.planning/phases/03-dotfiles-management/03-02-SUMMARY.md`
</output>
