---
phase: 03-dotfiles-management
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - src/installers/dotfiles-install.sh
  - setup.sh
autonomous: false

must_haves:
  truths:
    - "Running setup.sh with dotfiles action creates symlinks in $HOME"
    - "User can run setup.sh unlink to remove symlinks and restore backups"
    - "Git user config is prompted during first install (name, email)"
    - "All expected symlinks exist after installation"
    - "Essential zsh plugins are installed to ~/.zsh/ if not present"
  artifacts:
    - path: "src/installers/dotfiles-install.sh"
      provides: "Dotfiles installation orchestration"
      exports: ["install_dotfiles", "unlink_dotfiles", "setup_git_user", "install_zsh_plugins"]
    - path: "setup.sh"
      provides: "Entry point with dotfiles integration"
      contains: "dotfiles"
  key_links:
    - from: "src/installers/dotfiles-install.sh"
      to: "src/core/dotfiles.sh"
      via: "source"
      pattern: "source.*dotfiles\\.sh"
    - from: "setup.sh"
      to: "src/installers/dotfiles-install.sh"
      via: "source or call"
      pattern: "dotfiles-install"
    - from: "src/installers/dotfiles-install.sh"
      to: "~/.zsh/"
      via: "git clone"
      pattern: "git clone.*zsh"
---

<objective>
Integrate dotfiles into setup.sh and create installation orchestration.

Purpose: Connects the dotfiles system to the main entry point. Users can run `./setup.sh` to install dotfiles and `./setup.sh unlink` to remove them. Includes git user setup prompting and essential zsh plugin installation.

Output: Functional dotfiles installation integrated into setup.sh.
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dotfiles-management/03-CONTEXT.md
@.planning/phases/03-dotfiles-management/03-RESEARCH.md
@.planning/phases/03-dotfiles-management/03-01-SUMMARY.md

# Entry point to integrate with
@setup.sh
@config.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dotfiles installer with plugin support</name>
  <files>src/installers/dotfiles-install.sh</files>
  <action>
Create src/installers/ directory if needed and dotfiles-install.sh:

**dotfiles-install.sh** - Orchestrates dotfiles installation:
```bash
#!/usr/bin/env bash
#######################################
# Script: dotfiles-install.sh
# Description: Installs/uninstalls dotfiles symlinks
# Author: Bragatte
# Date: 2026-02-05
#######################################

# Prevent multiple sourcing
[[ -n "${_DOTFILES_INSTALL_SOURCED:-}" ]] && return 0
readonly _DOTFILES_INSTALL_SOURCED=1

# Determine paths
if [[ -z "${SCRIPT_DIR:-}" ]]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
fi
REPO_ROOT="$(cd "${SCRIPT_DIR}/../.." && pwd -P)"

# Source dependencies
source "${REPO_ROOT}/src/core/logging.sh"
source "${REPO_ROOT}/src/core/dotfiles.sh"

# Dotfiles locations
DOTFILES_DATA="${REPO_ROOT}/data/dotfiles"

# Plugin locations (per CONTEXT.md: git clone to ~/.zsh/)
ZSH_PLUGINS_DIR="${HOME}/.zsh"

#######################################
# install_zsh_plugins()
# Installs essential zsh plugins via git clone
# Per CONTEXT.md: zsh-autosuggestions + zsh-syntax-highlighting
#######################################
install_zsh_plugins() {
    log_info "Installing essential zsh plugins..."

    # Create plugins directory if needed
    if [[ "${DRY_RUN:-}" == "true" ]]; then
        log_info "[DRY_RUN] Would create $ZSH_PLUGINS_DIR"
    else
        mkdir -p "$ZSH_PLUGINS_DIR"
    fi

    # Essential plugins per CONTEXT.md
    # NOTE: Using indexed array (not associative) for bash 3.2 compatibility (macOS)
    local plugins=(
        "zsh-autosuggestions https://github.com/zsh-users/zsh-autosuggestions.git"
        "zsh-syntax-highlighting https://github.com/zsh-users/zsh-syntax-highlighting.git"
    )

    for plugin_entry in "${plugins[@]}"; do
        local plugin_name="${plugin_entry%% *}"
        local plugin_url="${plugin_entry#* }"
        local plugin_path="${ZSH_PLUGINS_DIR}/${plugin_name}"

        if [[ -d "$plugin_path" ]]; then
            log_info "Plugin already installed: $plugin_name"
            continue
        fi

        if [[ "${DRY_RUN:-}" == "true" ]]; then
            log_info "[DRY_RUN] Would clone $plugin_name to $plugin_path"
        else
            log_info "Installing plugin: $plugin_name"
            if git clone --depth 1 "$plugin_url" "$plugin_path" 2>/dev/null; then
                log_ok "Installed: $plugin_name"
            else
                log_warn "Failed to install $plugin_name (git clone failed)"
            fi
        fi
    done

    log_ok "Plugin installation complete"
}

#######################################
# setup_git_user()
# Prompts for and sets git user.name and user.email in ~/.gitconfig.local
#######################################
setup_git_user() {
    local gitconfig_local="${HOME}/.gitconfig.local"

    # Skip if already configured
    if [[ -f "$gitconfig_local" ]] && grep -q '^\[user\]' "$gitconfig_local"; then
        log_info "Git user already configured in ~/.gitconfig.local"
        return 0
    fi

    # Skip if non-interactive
    if [[ ! -t 0 ]]; then
        log_warn "Non-interactive mode - skipping git user setup"
        log_info "Run 'git config --global user.name \"Your Name\"' manually"
        return 0
    fi

    log_info "Setting up git user configuration..."

    local name email

    # Prompt for name
    read -rp "Enter your git user.name: " name
    if [[ -z "$name" ]]; then
        log_warn "No name provided - skipping git user setup"
        return 0
    fi

    # Prompt for email
    read -rp "Enter your git user.email: " email
    if [[ -z "$email" ]]; then
        log_warn "No email provided - skipping git user setup"
        return 0
    fi

    # Respect DRY_RUN
    if [[ "${DRY_RUN:-}" == "true" ]]; then
        log_info "[DRY_RUN] Would create ~/.gitconfig.local with:"
        log_info "  user.name = $name"
        log_info "  user.email = $email"
        return 0
    fi

    # Write to gitconfig.local
    cat > "$gitconfig_local" << EOF
# Local git configuration
# Generated by os-postinstall-scripts

[user]
    name = $name
    email = $email
EOF

    log_ok "Created ~/.gitconfig.local with your git identity"
}

#######################################
# install_dotfiles()
# Creates symlinks for all dotfiles
#######################################
install_dotfiles() {
    log_banner "Dotfiles Installation"

    # Symlink mappings: source -> target
    # Format: "relative_path_in_data/dotfiles:target_in_HOME"
    # NOTE: create_dotfile_symlink handles mkdir -p for parent dirs (e.g., ~/.config/git/)
    local -a symlink_map=(
        "zsh/zshrc:${HOME}/.zshrc"
        "bash/bashrc:${HOME}/.bashrc"
        "git/gitconfig:${HOME}/.gitconfig"
        "git/gitignore:${HOME}/.config/git/ignore"
        "starship/starship.toml:${HOME}/.config/starship.toml"
    )

    local failed=0

    for mapping in "${symlink_map[@]}"; do
        local source_rel="${mapping%%:*}"
        local target="${mapping##*:}"
        local source="${DOTFILES_DATA}/${source_rel}"

        # Skip if source doesn't exist
        if [[ ! -f "$source" ]]; then
            log_warn "Source not found, skipping: $source"
            continue
        fi

        # Create symlink (function handles backup AND parent directory creation)
        if ! create_dotfile_symlink "$source" "$target"; then
            log_error "Failed to link: $target"
            ((failed++))
        fi
    done

    # Show backup summary
    show_backup_summary

    # Install essential zsh plugins
    install_zsh_plugins

    # Setup git user if gitconfig was linked
    if [[ -L "${HOME}/.gitconfig" ]]; then
        setup_git_user
    fi

    if ((failed > 0)); then
        log_error "Dotfiles installation completed with $failed errors"
        return 1
    fi

    log_ok "Dotfiles installation complete"
    return 0
}

#######################################
# remove_dotfiles()
# Removes symlinks and optionally restores backups
#######################################
remove_dotfiles() {
    log_banner "Dotfiles Removal"

    local -a targets=(
        "${HOME}/.zshrc"
        "${HOME}/.bashrc"
        "${HOME}/.gitconfig"
        "${HOME}/.config/git/ignore"
        "${HOME}/.config/starship.toml"
    )

    for target in "${targets[@]}"; do
        if [[ -L "$target" ]]; then
            unlink_dotfiles "$target"
        fi
    done

    log_ok "Dotfiles removal complete"
}

# Export functions
export -f setup_git_user install_dotfiles remove_dotfiles install_zsh_plugins
```
  </action>
  <verify>
    - File exists: `[[ -f src/installers/dotfiles-install.sh ]]`
    - Sources dotfiles.sh: `rg 'source.*dotfiles.sh' src/installers/dotfiles-install.sh`
    - Has install_dotfiles: `rg 'install_dotfiles\(\)' src/installers/dotfiles-install.sh`
    - Has setup_git_user: `rg 'setup_git_user\(\)' src/installers/dotfiles-install.sh`
    - Has install_zsh_plugins: `rg 'install_zsh_plugins\(\)' src/installers/dotfiles-install.sh`
    - Has git clone for plugins: `rg 'git clone.*zsh-autosuggestions' src/installers/dotfiles-install.sh`
    - Has comment about mkdir -p in symlink_map: `rg 'mkdir -p' src/installers/dotfiles-install.sh`
    - Syntax check: `bash -n src/installers/dotfiles-install.sh`
  </verify>
  <done>
    - src/installers/dotfiles-install.sh exists
    - Contains install_dotfiles(), remove_dotfiles(), setup_git_user(), install_zsh_plugins()
    - Sources core/dotfiles.sh
    - Symlink mappings for all dotfiles defined with note about parent directory creation
    - Installs zsh-autosuggestions and zsh-syntax-highlighting to ~/.zsh/
    - bash -n passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate into setup.sh</name>
  <files>setup.sh</files>
  <action>
Update setup.sh to include dotfiles functionality:

1. Add 'dotfiles' and 'unlink' to available actions/commands
2. Source dotfiles-install.sh when action is dotfiles
3. Handle `./setup.sh dotfiles` to install
4. Handle `./setup.sh unlink` to remove

Look at existing setup.sh structure and add dotfiles handling in the appropriate place.

The integration should be minimal - just calling the installer functions when the right action is requested.

If setup.sh uses a case statement for actions, add:
```bash
dotfiles)
    source "${SCRIPT_DIR}/src/installers/dotfiles-install.sh"
    install_dotfiles
    ;;
unlink)
    source "${SCRIPT_DIR}/src/installers/dotfiles-install.sh"
    remove_dotfiles
    ;;
```
  </action>
  <verify>
    - setup.sh mentions dotfiles: `rg 'dotfiles' setup.sh`
    - setup.sh mentions unlink: `rg 'unlink' setup.sh`
    - Sources installer: `rg 'dotfiles-install' setup.sh`
  </verify>
  <done>
    - setup.sh handles 'dotfiles' action
    - setup.sh handles 'unlink' action
    - Actions source installer and call appropriate function
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete dotfiles management system:
- src/core/dotfiles.sh (symlink manager with backup, correct naming pattern, mkdir -p for parents)
- data/dotfiles/{shared,zsh,bash,git,starship}/ (configuration files)
- src/installers/dotfiles-install.sh (orchestration with plugin installation)
- setup.sh integration (dotfiles, unlink commands)
  </what-built>
  <how-to-verify>
1. **Test symlink creation (with DRY_RUN first)**:
   ```bash
   cd /Users/bragatte/Documents/GitHub/os-postinstall-scripts
   DRY_RUN=true ./setup.sh dotfiles
   ```
   Expected: Shows what would be linked without making changes, shows plugin clone messages

2. **Test actual installation**:
   ```bash
   ./setup.sh dotfiles
   ```
   Expected:
   - Prompts for git user.name and user.email (if not already set)
   - Creates symlinks in $HOME (including ~/.config/git/ignore with parent dir created)
   - Shows backup summary if files were backed up (format: config-git-ignore.bak.2026-02-05)
   - Installs zsh-autosuggestions and zsh-syntax-highlighting to ~/.zsh/

3. **Verify symlinks exist**:
   ```bash
   ls -la ~/.zshrc ~/.bashrc ~/.gitconfig ~/.config/starship.toml ~/.config/git/ignore
   ```
   Expected: All show as symlinks pointing to data/dotfiles/

4. **Verify plugins installed**:
   ```bash
   ls -la ~/.zsh/
   ```
   Expected: zsh-autosuggestions/ and zsh-syntax-highlighting/ directories exist

5. **Check backup directory** (if you had existing configs):
   ```bash
   ls -la ~/.dotfiles-backup/
   cat ~/.dotfiles-backup/backup-manifest.txt
   ```
   Expected: Backups follow naming pattern like config-git-ignore.bak.2026-02-05

6. **Test unlink**:
   ```bash
   ./setup.sh unlink
   ```
   Expected: Removes symlinks, restores backups if they existed

7. **Test shell config** (if you want to try it):
   ```bash
   # Start new zsh
   zsh
   # Should see starship prompt (if starship installed)
   # Type partial command, should see autosuggestions (if plugin installed)
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if working, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Automated checks before human verification:
```bash
# File existence
[[ -f src/installers/dotfiles-install.sh ]] && echo "OK: installer exists"
[[ -f src/core/dotfiles.sh ]] && echo "OK: core dotfiles exists"

# Syntax
bash -n src/installers/dotfiles-install.sh && echo "OK: installer syntax"
bash -n setup.sh && echo "OK: setup.sh syntax"

# Integration
rg 'dotfiles' setup.sh && echo "OK: setup.sh has dotfiles"

# Plugin installation
rg 'zsh-autosuggestions' src/installers/dotfiles-install.sh && echo "OK: has plugin support"
```
</verification>

<success_criteria>
- ./setup.sh dotfiles creates all expected symlinks (including nested paths like ~/.config/git/ignore)
- ./setup.sh unlink removes symlinks and restores backups
- Git user prompting works in interactive mode
- Essential zsh plugins are installed to ~/.zsh/
- DRY_RUN mode works correctly
- Backup naming follows pattern: config-git-ignore.bak.2026-02-05
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-dotfiles-management/03-04-SUMMARY.md`
</output>
