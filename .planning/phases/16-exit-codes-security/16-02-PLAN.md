---
phase: 16-exit-codes-security
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/core/errors.sh
  - src/platforms/linux/install/cargo.sh
  - src/install/fnm.sh
  - src/install/uv.sh
  - src/install/ai-tools.sh
  - .planning/adrs/ADR-009-curl-trust-model.md
  - tests/test-core-errors.bats
autonomous: true

must_haves:
  truths:
    - "curl|sh patterns download to temp file before executing (no partial download risk)"
    - "All 5 curl|sh call sites use safe_curl_sh() instead of piping"
    - "ADR-009 documents the HTTPS-only trust model with explicit risk acknowledgment"
    - "safe_curl_sh() returns the exit code of the downloaded script"
    - "safe_curl_sh() cleans up the temp file even on failure"
  artifacts:
    - path: "src/core/errors.sh"
      provides: "safe_curl_sh() function"
      contains: "safe_curl_sh"
    - path: ".planning/adrs/ADR-009-curl-trust-model.md"
      provides: "Trust model documentation for curl|sh usage"
      contains: "HTTPS"
    - path: "tests/test-core-errors.bats"
      provides: "Test for safe_curl_sh function existence"
      contains: "safe_curl_sh"
  key_links:
    - from: "src/platforms/linux/install/cargo.sh"
      to: "safe_curl_sh()"
      via: "replaces curl|sh for rustup and cargo-binstall"
      pattern: "safe_curl_sh"
    - from: "src/install/fnm.sh"
      to: "safe_curl_sh()"
      via: "replaces curl|bash for fnm installer"
      pattern: "safe_curl_sh"
    - from: "src/install/ai-tools.sh"
      to: "safe_curl_sh()"
      via: "replaces curl|sh for ollama installer"
      pattern: "safe_curl_sh"
    - from: "src/install/uv.sh"
      to: "safe_curl_sh()"
      via: "replaces curl|sh for uv installer"
      pattern: "safe_curl_sh"
---

<objective>
Add safe_curl_sh() download-then-execute helper to prevent partial download execution, migrate all 5 curl|sh call sites, and document the trust model in ADR-009.

Purpose: The curl|sh pipe pattern risks executing a partially downloaded script if the connection drops mid-transfer. Downloading to a temp file first ensures the script is complete before execution. ADR-009 makes the trust model explicit (HTTPS-only, no checksum -- industry standard for install scripts).

Output: safe_curl_sh() function in errors.sh, 5 call sites migrated, ADR-009 created, tests extended.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-exit-codes-security/16-RESEARCH.md
@.planning/phases/16-exit-codes-security/16-01-SUMMARY.md
@src/core/errors.sh
@src/platforms/linux/install/cargo.sh
@src/install/fnm.sh
@src/install/uv.sh
@src/install/ai-tools.sh
@tests/test-core-errors.bats
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add safe_curl_sh() to errors.sh and migrate all 5 curl|sh call sites</name>
  <files>
    src/core/errors.sh
    src/platforms/linux/install/cargo.sh
    src/install/fnm.sh
    src/install/uv.sh
    src/install/ai-tools.sh
  </files>
  <action>
**In `src/core/errors.sh`:**

Add `safe_curl_sh()` function BEFORE the export section (before `export -f`). Use the KISS version -- URL as first arg, remaining args passed to the downloaded script:

```bash
# safe_curl_sh -- Download installer to temp file before executing.
# Prevents partial download execution (the most practical curl|sh risk).
# Usage: safe_curl_sh URL [script_args...]
# Returns: exit code of the downloaded script, or 1 on download failure
safe_curl_sh() {
    local url="$1"
    shift

    if [[ -z "$url" ]]; then
        log_error "safe_curl_sh: no URL provided"
        return 1
    fi

    local tmp
    tmp=$(mktemp "${TMPDIR:-/tmp}/installer-XXXXXX.sh")

    if ! curl -fsSL "$url" -o "$tmp"; then
        rm -f "$tmp"
        log_error "Failed to download: $url"
        return 1
    fi

    local rc=0
    bash "$tmp" "$@" || rc=$?

    rm -f "$tmp"
    return "$rc"
}
```

Add to the export line: `export -f safe_curl_sh`

**Migrate 5 curl|sh call sites:**

1. `src/platforms/linux/install/cargo.sh` -- rustup install (around line 56):
   - BEFORE: `curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y`
   - AFTER: `safe_curl_sh "https://sh.rustup.rs" -- -y`
   - Note: The `--proto` and `--tlsv1.2` flags on the outer curl are belt-and-suspenders. rustup-init.sh itself enforces TLS when downloading the toolchain binary. safe_curl_sh uses `-fsSL` which follows redirects and fails on HTTP errors. The HTTPS URL provides transport security.

2. `src/platforms/linux/install/cargo.sh` -- cargo-binstall install (around line 127-128):
   - BEFORE: `curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash`
   - AFTER: `safe_curl_sh "https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh"`

3. `src/install/fnm.sh` (around line 52):
   - BEFORE: `curl -fsSL https://fnm.vercel.app/install | bash -s -- --skip-shell`
   - AFTER: `safe_curl_sh "https://fnm.vercel.app/install" -- --skip-shell`

4. `src/install/uv.sh` (around line 52):
   - BEFORE: `curl -LsSf https://astral.sh/uv/install.sh | sh`
   - AFTER: `safe_curl_sh "https://astral.sh/uv/install.sh"`

5. `src/install/ai-tools.sh` -- ollama install (around line 115):
   - BEFORE: `curl -fsSL https://ollama.com/install.sh | sh`
   - AFTER: `safe_curl_sh "https://ollama.com/install.sh"`

IMPORTANT: These call sites are inside DRY_RUN guard blocks. The existing DRY_RUN checks in each caller function handle this -- do NOT add DRY_RUN logic to safe_curl_sh() itself. Verify the DRY_RUN guard exists around each call site before making changes.

IMPORTANT: Preserve context around each call site (surrounding comments, error handling, PATH updates that follow the install). Only replace the curl|sh line itself.
  </action>
  <verify>
Manual checks:
- `grep -r 'curl.*|.*sh\|curl.*|.*bash' src/platforms/linux/install/cargo.sh src/install/fnm.sh src/install/uv.sh src/install/ai-tools.sh` returns NO matches (all pipe patterns replaced).
- `grep -c 'safe_curl_sh' src/platforms/linux/install/cargo.sh` returns 2 (rustup + cargo-binstall).
- `grep -c 'safe_curl_sh' src/install/fnm.sh` returns 1.
- `grep -c 'safe_curl_sh' src/install/uv.sh` returns 1.
- `grep -c 'safe_curl_sh' src/install/ai-tools.sh` returns 1.
- `bash -n src/core/errors.sh` -- syntax OK.
- `bash -n src/platforms/linux/install/cargo.sh` -- syntax OK.
- `bash -n src/install/fnm.sh` -- syntax OK.
- `bash -n src/install/uv.sh` -- syntax OK.
- `bash -n src/install/ai-tools.sh` -- syntax OK.
  </verify>
  <done>
safe_curl_sh() function exists in errors.sh and is exported. All 5 curl|sh pipe patterns replaced with safe_curl_sh() calls. No curl|sh pipes remain in the codebase. All scripts pass bash -n syntax check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ADR-009 and add safe_curl_sh tests</name>
  <files>
    .planning/adrs/ADR-009-curl-trust-model.md
    tests/test-core-errors.bats
  </files>
  <action>
**Create `.planning/adrs/ADR-009-curl-trust-model.md`:**

```markdown
# ADR-009: curl|sh Trust Model - HTTPS-Only, Download-Then-Execute

**Status:** Accepted
**Date:** 2026-02-21
**Phase:** 16

## Context

The project uses `curl URL | sh` to install several tools that do not publish packages in system package managers: rustup (Rust toolchain), cargo-binstall, fnm (Node version manager), uv (Python package manager), and ollama (local AI models). This is a widely discussed security pattern.

The primary risk is **partial download execution**: if the connection drops mid-transfer, bash may execute a truncated script. Secondary risks (MITM, supply chain compromise) are mitigated by HTTPS transport security and are accepted as industry-standard practice.

## Decision

1. **Download-then-execute:** All curl|sh call sites use `safe_curl_sh()` which downloads to a temp file before executing. This eliminates partial download risk.

2. **HTTPS-only:** All URLs use HTTPS. No HTTP fallback.

3. **No checksum verification:** None of the upstream projects (rustup, cargo-binstall, fnm, uv, ollama) publish stable checksums for their install scripts. Scripts change with every release. Implementing verification the upstreams do not support would be security theater.

4. **No GPG verification:** Would require shipping and maintaining a GPG keyring. Key rotation, revocation, and binary distribution add complexity with minimal security gain for install scripts that run once.

## Call Sites

| Tool | URL | Installer |
|------|-----|-----------|
| rustup | https://sh.rustup.rs | cargo.sh |
| cargo-binstall | https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | cargo.sh |
| fnm | https://fnm.vercel.app/install | fnm.sh |
| uv | https://astral.sh/uv/install.sh | uv.sh |
| ollama | https://ollama.com/install.sh | ai-tools.sh |

## Alternatives Considered

### Checksum verification
- **Pros:** Detects script tampering
- **Cons:** No upstream publishes stable checksums. Scripts change on every release. Would require maintaining a checksum database that drifts immediately.

### GPG signature verification
- **Pros:** Cryptographic proof of origin
- **Cons:** Requires gpg binary, keyring management, key rotation handling. Only rustup offers GPG signatures (for the toolchain, not the install script).

### Vendor each installer script
- **Pros:** Full control over what executes
- **Cons:** Scripts are 200-500 lines each. They change frequently. Vendoring 5 scripts means maintaining 5 forks. Platform-specific logic makes this impractical.

### System package managers only
- **Pros:** Avoids curl|sh entirely
- **Cons:** rustup, cargo-binstall, and fnm are not available in apt/brew. uv's apt package lags significantly behind releases.

## Consequences

- **Positive:** No partial download execution. Explicit, documented risk acknowledgment. Matches industry practice (homebrew, rustup, nvm, asdf all use this pattern).
- **Negative:** Still trusts upstream HTTPS endpoints. A compromised upstream could serve a malicious script. This risk is accepted as inherent to the tool ecosystem.

## References

- [thoughtbot/laptop](https://github.com/thoughtbot/laptop) -- curl|sh with no verification
- [rustup.rs](https://rustup.rs/) -- official installation method is curl|sh
- [Homebrew](https://brew.sh/) -- installs via curl|bash
- [nvm](https://github.com/nvm-sh/nvm) -- installs via curl|bash
```

**In `tests/test-core-errors.bats`:**

Add 2 new tests at the end of the file:

```bash
@test "safe_curl_sh function is exported" {
    declare -F safe_curl_sh
}

@test "safe_curl_sh fails gracefully with no URL" {
    run safe_curl_sh
    assert_failure
}
```
  </action>
  <verify>
Run: `cd /Users/bragatte/Documents/GitHub/os-postinstall-scripts && bats tests/test-core-errors.bats`
All tests pass (14 from Plan 01 + 2 new = 16 total).

Manual checks:
- `test -f .planning/adrs/ADR-009-curl-trust-model.md` -- file exists.
- `grep 'Download-Then-Execute' .planning/adrs/ADR-009-curl-trust-model.md` -- title present.
- `grep 'safe_curl_sh' .planning/adrs/ADR-009-curl-trust-model.md` -- function referenced.
- `ls .planning/adrs/` shows ADR-001 through ADR-009 (9 total).
  </verify>
  <done>
ADR-009 exists documenting HTTPS-only trust model, download-then-execute pattern, and explicit reasoning for no checksum/GPG. Tests verify safe_curl_sh function exists and handles missing URL gracefully. 16 total bats tests pass.
  </done>
</task>

</tasks>

<verification>
1. `bats tests/test-core-errors.bats` -- all 16 tests pass
2. `grep -r 'curl.*|.*sh\|curl.*|.*bash' src/` -- no pipe patterns remain in installer scripts
3. `grep 'safe_curl_sh' src/core/errors.sh` -- function defined and exported
4. `test -f .planning/adrs/ADR-009-curl-trust-model.md` -- ADR exists
5. `bash -n src/core/errors.sh` -- syntax OK
6. All 5 call sites use safe_curl_sh() with correct URL and arguments
</verification>

<success_criteria>
- safe_curl_sh() function exists in errors.sh, is exported, downloads to temp file before executing
- All 5 curl|sh pipe patterns replaced (0 remaining in codebase)
- ADR-009 documents trust model: HTTPS-only, download-then-execute, no checksum
- safe_curl_sh() returns the downloaded script's exit code
- safe_curl_sh() cleans up temp file on both success and failure
- 16 bats tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-exit-codes-security/16-02-SUMMARY.md`
</output>
