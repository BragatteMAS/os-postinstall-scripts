---
phase: 02-consolidation-data-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/logging.sh
  - src/core/platform.sh
  - src/core/idempotent.sh
  - src/core/errors.sh
  - src/core/packages.sh
  - data/packages/.gitkeep
  - data/packages/profiles/.gitkeep
  - data/dotfiles/.gitkeep
autonomous: true

must_haves:
  truths:
    - "src/core/ directory exists with all Phase 1 utilities"
    - "data/packages/ and data/dotfiles/ directories exist"
    - "packages.sh provides load_packages() function"
  artifacts:
    - path: "src/core/logging.sh"
      provides: "Logging utilities"
      contains: "_LOGGING_SOURCED"
    - path: "src/core/platform.sh"
      provides: "Platform detection"
      contains: "detect_platform"
    - path: "src/core/idempotent.sh"
      provides: "Idempotency utilities"
      contains: "is_installed"
    - path: "src/core/errors.sh"
      provides: "Error handling"
      contains: "FAILED_ITEMS"
    - path: "src/core/packages.sh"
      provides: "Package loading from .txt files"
      contains: "load_packages"
  key_links:
    - from: "src/core/packages.sh"
      to: "data/packages/"
      via: "DATA_DIR variable"
      pattern: "DATA_DIR.*data"
---

<objective>
Create the new directory structure and migrate Phase 1 core utilities to src/core/

Purpose: Establish the foundation for the new project layout. Move core utilities first since all other code depends on them.
Output: src/ and data/ directories with working core utilities
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-consolidation-data-migration/02-CONTEXT.md
@.planning/phases/02-consolidation-data-migration/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory structure and migrate core utilities</name>
  <files>
    src/core/logging.sh
    src/core/platform.sh
    src/core/idempotent.sh
    src/core/errors.sh
    data/packages/.gitkeep
    data/packages/profiles/.gitkeep
    data/dotfiles/.gitkeep
  </files>
  <action>
    1. Create new directory structure:
       - mkdir -p src/core src/platforms/linux src/platforms/macos src/platforms/windows
       - mkdir -p data/packages/profiles data/dotfiles
       - touch data/packages/.gitkeep data/packages/profiles/.gitkeep data/dotfiles/.gitkeep

    2. Move Phase 1 utilities using git mv (preserves history):
       - git mv scripts/utils/logging.sh src/core/logging.sh
       - git mv scripts/utils/platform.sh src/core/platform.sh
       - git mv scripts/utils/idempotent.sh src/core/idempotent.sh
       - git mv scripts/utils/errors.sh src/core/errors.sh

    3. Update SCRIPT_DIR references in moved files to use the new path pattern.
       Each file should have: SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
  </action>
  <verify>
    - ls -la src/core/ shows 4 .sh files
    - ls -la data/packages/ shows .gitkeep
    - bash -n src/core/logging.sh (syntax check)
    - bash -n src/core/platform.sh
    - bash -n src/core/idempotent.sh
    - bash -n src/core/errors.sh
  </verify>
  <done>
    src/core/ contains all Phase 1 utilities, data/ directories exist with .gitkeep files
  </done>
</task>

<task type="auto">
  <name>Task 2: Create packages.sh module with load_packages()</name>
  <files>src/core/packages.sh</files>
  <action>
    Create src/core/packages.sh with the following:

    1. Source guard pattern: [[ -n "${_PACKAGES_SOURCED:-}" ]] && return 0

    2. SCRIPT_DIR and DATA_DIR setup:
       SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
       DATA_DIR="$(cd "${SCRIPT_DIR}/../../data" && pwd -P)"

    3. load_packages() function:
       - Takes $1 = filename (relative to data/packages/) or absolute path
       - Resolves relative paths to DATA_DIR/packages/
       - Reads file line by line, skipping empty lines and comments (#)
       - Trims whitespace from lines
       - Populates global PACKAGES array
       - Returns 0 on success, 1 if file not found

    4. load_profile() function:
       - Takes $1 = profile name (e.g., "developer")
       - Reads data/packages/profiles/{name}.txt
       - Each line is a package file to include
       - Calls load_packages() for each file
       - Combines all packages into PACKAGES array

    5. get_packages_for_manager() function:
       - Takes $1 = manager name (apt, brew, cargo, npm, winget)
       - Loads data/packages/{manager}.txt
       - Sets PACKAGES array

    6. Export all functions

    Use the implementation from RESEARCH.md as reference.
  </action>
  <verify>
    - bash -n src/core/packages.sh (syntax check)
    - source src/core/packages.sh succeeds
    - rg "load_packages" src/core/packages.sh returns matches
    - rg "load_profile" src/core/packages.sh returns matches
  </verify>
  <done>
    packages.sh exists with load_packages(), load_profile(), get_packages_for_manager() functions
  </done>
</task>

</tasks>

<verification>
1. All directories exist: src/core/, src/platforms/, data/packages/, data/dotfiles/
2. All Phase 1 utilities exist in src/core/
3. packages.sh provides package loading functions
4. All scripts pass bash -n syntax check
5. Source guards prevent multiple sourcing
</verification>

<success_criteria>
- src/core/ contains: logging.sh, platform.sh, idempotent.sh, errors.sh, packages.sh
- data/packages/profiles/ exists with .gitkeep
- data/dotfiles/ exists with .gitkeep
- All shell scripts pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/02-consolidation-data-migration/02-01-SUMMARY.md`
</output>
