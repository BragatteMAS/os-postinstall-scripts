---
phase: 02-consolidation-data-migration
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - setup.sh
  - config.sh
autonomous: true

must_haves:
  truths:
    - "setup.sh exists in project root as main entry point"
    - "setup.sh detects platform and dispatches to correct handler"
    - "config.sh provides user customization options"
  artifacts:
    - path: "setup.sh"
      provides: "Main entry point"
      contains: "detect_platform"
      min_lines: 30
    - path: "config.sh"
      provides: "User configuration"
      contains: "DEFAULT_PROFILE"
  key_links:
    - from: "setup.sh"
      to: "src/core/platform.sh"
      via: "source statement"
      pattern: "source.*core/platform.sh"
    - from: "setup.sh"
      to: "src/platforms/linux/main.sh"
      via: "conditional dispatch"
      pattern: "linux.*main.sh"
---

<objective>
Create new entry point (setup.sh) and configuration file (config.sh) in project root

Purpose: Provide single entry point that detects platform and routes to correct handler. Replace the current symlink setup.sh with a real script.
Output: Working setup.sh that can run the full installation
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-consolidation-data-migration/02-CONTEXT.md
@.planning/phases/02-consolidation-data-migration/02-RESEARCH.md
@.planning/phases/02-consolidation-data-migration/02-01-SUMMARY.md
@.planning/phases/02-consolidation-data-migration/02-02-SUMMARY.md
@.planning/phases/02-consolidation-data-migration/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config.sh with user configuration options</name>
  <files>config.sh</files>
  <action>
    Create config.sh in project root with user-editable configuration:

    ```bash
    #!/usr/bin/env bash
    # config.sh - User configuration for os-postinstall-scripts
    # Edit this file to customize your installation

    # Prevent multiple sourcing
    [[ -n "${_CONFIG_SOURCED:-}" ]] && return 0
    readonly _CONFIG_SOURCED=1

    #===============================================
    # INSTALLATION PROFILE
    #===============================================
    # Options: minimal, developer, full
    # - minimal: Essential system packages only
    # - developer: System + development tools (cargo, npm)
    # - full: Everything including AI/MCP tools
    DEFAULT_PROFILE="${DEFAULT_PROFILE:-developer}"

    #===============================================
    # BEHAVIOR FLAGS
    #===============================================
    # Set to "true" to show what would be done without making changes
    DRY_RUN="${DRY_RUN:-false}"

    # Set to "true" for verbose output with timestamps
    VERBOSE="${VERBOSE:-false}"

    # Set to "true" to skip confirmation prompts
    UNATTENDED="${UNATTENDED:-false}"

    #===============================================
    # CUSTOMIZATION
    #===============================================
    # Add packages to this array to install additional packages
    # These are appended to the profile's package list
    EXTRA_PACKAGES=()

    # Skip these packages even if they're in the profile
    SKIP_PACKAGES=()

    #===============================================
    # PATHS (usually no need to change)
    #===============================================
    # Base directory (auto-detected)
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
    readonly PROJECT_ROOT="${SCRIPT_DIR}"
    readonly SRC_DIR="${PROJECT_ROOT}/src"
    readonly DATA_DIR="${PROJECT_ROOT}/data"
    readonly CORE_DIR="${SRC_DIR}/core"

    # Export for use by other scripts
    export PROJECT_ROOT SRC_DIR DATA_DIR CORE_DIR
    export DEFAULT_PROFILE DRY_RUN VERBOSE UNATTENDED
    ```

    This file is meant to be edited by users to customize their installation.
  </action>
  <verify>
    - bash -n config.sh
    - source config.sh && echo "$DEFAULT_PROFILE" prints "developer"
    - source config.sh && echo "$PROJECT_ROOT" prints absolute path
  </verify>
  <done>
    config.sh exists with user configuration options and path setup
  </done>
</task>

<task type="auto">
  <name>Task 2: Create setup.sh entry point</name>
  <files>setup.sh</files>
  <action>
    1. Remove existing setup.sh symlink:
       rm setup.sh (it's currently a symlink to scripts/setup/main.sh)

    2. Create new setup.sh script:

    ```bash
    #!/usr/bin/env bash
    #===============================================
    # os-postinstall-scripts - Setup Entry Point
    #===============================================
    # Usage: ./setup.sh [profile]
    # Profiles: minimal, developer, full
    #
    # This script detects your platform and runs the appropriate installer.
    #
    # Environment variables:
    #   DRY_RUN=true    - Show what would be done
    #   VERBOSE=true    - Enable debug output
    #   UNATTENDED=true - Skip confirmation prompts
    #===============================================

    set -o pipefail

    # Get script directory
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
    readonly SCRIPT_DIR

    # Load configuration
    source "${SCRIPT_DIR}/config.sh"

    # Load core utilities
    source "${CORE_DIR}/logging.sh"
    source "${CORE_DIR}/platform.sh"
    source "${CORE_DIR}/errors.sh"

    # Setup colors and error handling
    setup_colors
    setup_error_handling

    #-----------------------------------------------
    # Main
    #-----------------------------------------------
    main() {
        local profile="${1:-$DEFAULT_PROFILE}"

        log_banner "OS Post-Install Scripts"
        log_info "Profile: $profile"

        # Detect platform
        detect_platform
        log_ok "Detected: ${DETECTED_OS} ${DETECTED_VERSION:-} (${DETECTED_PKG:-unknown})"

        # Run verification sequence
        verify_all

        # Dispatch to platform-specific handler
        case "${DETECTED_OS}" in
            linux)
                local linux_main="${SRC_DIR}/platforms/linux/main.sh"
                if [[ -f "$linux_main" ]]; then
                    log_info "Running Linux setup..."
                    bash "$linux_main" "$profile"
                else
                    log_error "Linux platform handler not found: $linux_main"
                    return 1
                fi
                ;;
            darwin)
                local macos_main="${SRC_DIR}/platforms/macos/main.sh"
                if [[ -f "$macos_main" ]]; then
                    log_info "Running macOS setup..."
                    bash "$macos_main" "$profile"
                else
                    log_warn "macOS platform handler not yet implemented"
                    log_info "See: .planning/ROADMAP.md Phase 4"
                    return 1
                fi
                ;;
            *)
                log_error "Unsupported platform: ${DETECTED_OS}"
                return 1
                ;;
        esac

        # Show summary
        show_failure_summary
        log_banner "Setup Complete"
    }

    # Run main with all arguments
    main "$@"
    ```
  </action>
  <verify>
    - bash -n setup.sh
    - ls -la setup.sh shows it's a regular file (not symlink)
    - ./setup.sh --help or source setup.sh errors gracefully if deps missing
    - head -20 setup.sh shows proper header and usage
  </verify>
  <done>
    setup.sh is a real script (not symlink) that dispatches to platform handlers
  </done>
</task>

</tasks>

<verification>
1. setup.sh exists as regular file (not symlink)
2. config.sh exists with DEFAULT_PROFILE, DRY_RUN, etc.
3. setup.sh sources config.sh and core utilities
4. Platform detection and dispatch work correctly
5. Both scripts pass syntax validation
</verification>

<success_criteria>
- setup.sh is project entry point (./setup.sh runs installation)
- config.sh provides user-editable configuration
- Platform detection routes to correct handler
- All scripts pass bash -n syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/02-consolidation-data-migration/02-04-SUMMARY.md`
</output>
