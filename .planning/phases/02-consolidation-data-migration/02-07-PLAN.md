---
phase: 02-consolidation-data-migration
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platforms/linux/post_install.sh
  - data/packages/apt-post.txt
  - data/packages/snap-post.txt
  - data/packages/flatpak-post.txt
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "post_install.sh uses load_packages() for APT packages"
    - "post_install.sh uses load_packages() for Snap packages"
    - "post_install.sh uses load_packages() for Flatpak packages"
    - "No hardcoded package arrays exist in post_install.sh"
  artifacts:
    - path: "data/packages/apt-post.txt"
      provides: "APT packages for post-install"
    - path: "data/packages/snap-post.txt"
      provides: "Snap packages for post-install"
    - path: "data/packages/flatpak-post.txt"
      provides: "Flatpak packages for post-install"
    - path: "src/platforms/linux/post_install.sh"
      provides: "Refactored post-install script using data files"
  key_links:
    - from: "src/platforms/linux/post_install.sh"
      to: "data/packages/apt-post.txt"
      via: "load_packages call"
      pattern: "load_packages.*apt-post"
    - from: "src/platforms/linux/post_install.sh"
      to: "src/core/packages.sh"
      via: "source statement"
      pattern: "source.*packages\\.sh"
---

<objective>
Refactor post_install.sh to use load_packages() instead of hardcoded APT_INSTALL, SNAP_INSTALL, FLAT_INSTALL arrays

Purpose: Close Gap 2 from VERIFICATION.md - post_install.sh violates PKG-04 (data separation)
Output: post_install.sh uses data/packages/*.txt files via load_packages() pattern established in apt.sh and cargo.sh
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-consolidation-data-migration/02-VERIFICATION.md
@src/platforms/linux/install/apt.sh
@src/core/packages.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract hardcoded arrays to data/packages/ files</name>
  <files>
    data/packages/apt-post.txt
    data/packages/snap-post.txt
    data/packages/flatpak-post.txt
  </files>
  <action>
1. Create `data/packages/apt-post.txt` with APT_INSTALL array contents from post_install.sh lines 96-126:
   - One package per line
   - Convert inline comments to # prefix comments
   - Remove array syntax (`synaptic    #System|...` becomes `# System - program manager` then `synaptic`)
   - Preserve categorization as comments

2. Create `data/packages/snap-post.txt` with SNAP_INSTALL array contents from lines 130-142:
   - Same format: one package per line with category comments
   - Skip commented-out packages (like `#bing-wall`)

3. Create `data/packages/flatpak-post.txt` with FLAT_INSTALL array contents from lines 146-209:
   - Same format
   - Use app IDs as-is (com.bitwarden.desktop, etc.)

Follow existing format in data/packages/apt.txt for consistency.
  </action>
  <verify>
    - `wc -l data/packages/apt-post.txt` shows ~40 lines (30 packages + comments)
    - `wc -l data/packages/snap-post.txt` shows ~15 lines
    - `wc -l data/packages/flatpak-post.txt` shows ~70 lines
    - Each file starts with `# ` header comment
  </verify>
  <done>Package lists extracted to data files following established format</done>
</task>

<task type="auto">
  <name>Task 2: Refactor post_install.sh to use load_packages()</name>
  <files>src/platforms/linux/post_install.sh</files>
  <action>
1. Add source statement for packages.sh after existing sources (around line 31):
   ```bash
   source "${SCRIPT_DIR}/../../core/packages.sh" || {
       log_error "Failed to load packages.sh"
       exit 1
   }
   ```

2. Remove entire APT_INSTALL array declaration (lines 96-126)

3. Remove entire SNAP_INSTALL array declaration (lines 130-142)

4. Remove entire FLAT_INSTALL array declaration (lines 146-209)

5. Replace APT installation loop (lines 237-251) with:
   ```bash
   log_section "Installing APT packages"
   if load_packages "apt-post.txt"; then
       total_packages=${#PACKAGES[@]}
       current_package=0
       for apt_program in "${PACKAGES[@]}"; do
           current_package=$((current_package + 1))
           log_progress $current_package $total_packages "Installing APT packages"
           if ! safe_apt_install "$apt_program"; then
               log_warning "Failed to install $apt_program, continuing..."
           fi
       done
   else
       log_warning "Could not load apt-post.txt, skipping APT packages"
   fi
   ```

6. Replace SNAP installation loop (lines 254-258) with similar pattern using load_packages "snap-post.txt"

7. Replace FLATPAK installation loop (lines 261-265) with similar pattern using load_packages "flatpak-post.txt"

Reference apt.sh for the exact pattern of load_packages() usage.
  </action>
  <verify>
    - `rg "APT_INSTALL=\(" src/platforms/linux/post_install.sh` returns empty
    - `rg "SNAP_INSTALL=\(" src/platforms/linux/post_install.sh` returns empty
    - `rg "FLAT_INSTALL=\(" src/platforms/linux/post_install.sh` returns empty
    - `rg "load_packages" src/platforms/linux/post_install.sh` shows 3 calls
    - `rg "packages\.sh" src/platforms/linux/post_install.sh` shows source statement
    - `bash -n src/platforms/linux/post_install.sh` exits 0 (syntax valid)
  </verify>
  <done>post_install.sh refactored to use load_packages() for all package types</done>
</task>

</tasks>

<verification>
After both tasks:
1. No hardcoded arrays in post_install.sh: `rg "_INSTALL=\(" src/platforms/linux/post_install.sh` returns empty
2. Package files exist: `ls data/packages/apt-post.txt data/packages/snap-post.txt data/packages/flatpak-post.txt`
3. post_install.sh sources packages.sh and calls load_packages 3 times
4. Syntax valid: `bash -n src/platforms/linux/post_install.sh`
</verification>

<success_criteria>
- post_install.sh has zero hardcoded package arrays
- Package lists are in data/packages/*.txt files
- load_packages() pattern used consistently (matches apt.sh and cargo.sh)
- Gap 2 (hardcoded arrays) fully closed
- PKG-04 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-consolidation-data-migration/02-07-SUMMARY.md`
</output>
