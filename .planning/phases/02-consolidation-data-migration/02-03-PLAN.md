---
phase: 02-consolidation-data-migration
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/platforms/linux/main.sh
  - src/platforms/linux/install/apt.sh
  - src/platforms/linux/install/cargo.sh
  - src/platforms/linux/post_install.sh
autonomous: true

must_haves:
  truths:
    - "Linux platform code exists under src/platforms/linux/"
    - "Scripts use load_packages() instead of hardcoded arrays"
    - "All source statements point to src/core/"
  artifacts:
    - path: "src/platforms/linux/main.sh"
      provides: "Linux entry point"
      contains: "src/core/platform.sh"
    - path: "src/platforms/linux/install/apt.sh"
      provides: "APT installer using data files"
      contains: "load_packages"
  key_links:
    - from: "src/platforms/linux/install/apt.sh"
      to: "src/core/packages.sh"
      via: "source statement"
      pattern: "source.*core/packages.sh"
    - from: "src/platforms/linux/install/apt.sh"
      to: "data/packages/apt.txt"
      via: "load_packages call"
      pattern: "load_packages.*apt"
---

<objective>
Migrate Linux platform code to src/platforms/linux/ and update to use data-driven package loading

Purpose: Consolidate platforms/linux/ into src/platforms/linux/, updating scripts to use src/core/ utilities and data/packages/ files.
Output: Working Linux platform code under new structure
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-consolidation-data-migration/02-CONTEXT.md
@.planning/phases/02-consolidation-data-migration/02-RESEARCH.md
@.planning/phases/02-consolidation-data-migration/02-01-SUMMARY.md
@.planning/phases/02-consolidation-data-migration/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Linux platform code to src/platforms/linux/</name>
  <files>
    src/platforms/linux/main.sh
    src/platforms/linux/post_install.sh
    src/platforms/linux/install/apt.sh
  </files>
  <action>
    1. Analyze platforms/linux/ to identify key files:
       - main.sh (entry point)
       - post_install.sh (post-installation tasks)
       - install/*.sh (individual installers)

    2. Move essential Linux files using git mv:
       - git mv platforms/linux/main.sh src/platforms/linux/main.sh
       - git mv platforms/linux/post_install.sh src/platforms/linux/post_install.sh
       - mkdir -p src/platforms/linux/install

    3. Migrate specific install scripts (explicit list):
       MANDATORY: git mv platforms/linux/install/apt.sh src/platforms/linux/install/apt.sh
       OPTIONAL (if exists): git mv platforms/linux/install/cargo.sh src/platforms/linux/install/cargo.sh
       DEFER to Phase 5: Other install scripts (will be evaluated during cleanup phase)

    4. For each moved file, update source statements:
       OLD: source "${SCRIPT_DIR}/../utils/logging.sh"
       NEW: source "${SCRIPT_DIR}/../../core/logging.sh"

       OLD: source "${SCRIPT_DIR}/../auto/logging.sh"
       NEW: source "${SCRIPT_DIR}/../../core/logging.sh"

    5. Remove any symlinks that were pointing to old locations.
       Check platforms/linux/utils/ for symlinks.

    6. Evaluate duplicate files between scripts/utils/ and platforms/linux/utils/:
       - If platforms/linux/utils/ had symlinks to scripts/utils/, they're now invalid
       - Use src/core/ as the single source
  </action>
  <verify>
    - ls src/platforms/linux/ shows main.sh, post_install.sh
    - ls src/platforms/linux/install/ shows installer scripts
    - bash -n src/platforms/linux/main.sh (syntax check)
    - rg "scripts/utils" src/platforms/ returns no matches (all updated)
  </verify>
  <done>
    Linux platform code migrated to src/platforms/linux/ with updated source paths
  </done>
</task>

<task type="auto">
  <name>Task 2: Update apt.sh to use data-driven package loading</name>
  <files>src/platforms/linux/install/apt.sh</files>
  <action>
    Refactor src/platforms/linux/install/apt.sh (or create if not migrated):

    1. Remove hardcoded package arrays (APT_INSTALL, APT_PACKAGES, etc.)

    2. Add source for packages.sh:
       ```bash
       source "${SCRIPT_DIR}/../../../core/packages.sh"
       ```

    3. Replace hardcoded installation with:
       ```bash
       # Load packages from data file
       if ! load_packages "apt.txt"; then
           log_error "Failed to load apt packages"
           exit 1
       fi

       log_info "Installing ${#PACKAGES[@]} APT packages..."

       for pkg in "${PACKAGES[@]}"; do
           if is_apt_installed "$pkg"; then
               log_debug "Already installed: $pkg"
               continue
           fi

           log_info "Installing: $pkg"
           if ! apt_install "$pkg"; then
               record_failure "$pkg"
           fi
       done
       ```

    4. Update all source statements to use src/core/:
       - logging.sh, platform.sh, idempotent.sh, errors.sh, packages.sh
  </action>
  <verify>
    - bash -n src/platforms/linux/install/apt.sh
    - rg "APT_INSTALL=" src/platforms/linux/install/apt.sh returns no match
    - rg "load_packages" src/platforms/linux/install/apt.sh returns match
    - rg "PACKAGES\[@\]" src/platforms/linux/install/apt.sh returns match
  </verify>
  <done>
    apt.sh uses load_packages() to read from data/packages/apt.txt
  </done>
</task>

<task type="auto">
  <name>Task 3: Update remaining Linux installers to use data files</name>
  <files>
    src/platforms/linux/install/cargo.sh
    src/platforms/linux/main.sh
  </files>
  <action>
    1. For cargo installer (if exists in platforms/linux/install/):
       - Update to use load_packages("cargo.txt")
       - Remove hardcoded RUST_TOOLS array
       - Source src/core/packages.sh

    2. Update main.sh entry point:
       - Source path: source "${SCRIPT_DIR}/../../core/platform.sh"
       - Source path: source "${SCRIPT_DIR}/../../core/logging.sh"
       - Optionally source packages.sh if it handles profile selection

    3. If scripts/install/rust-tools.sh has unique functionality:
       - Migrate unique parts to src/platforms/linux/install/cargo.sh
       - Data goes to data/packages/cargo.txt (already done in 02-02)

    4. Update any scripts that reference old paths.
  </action>
  <verify>
    - bash -n src/platforms/linux/install/cargo.sh (if exists)
    - bash -n src/platforms/linux/main.sh
    - rg "RUST_TOOLS=" src/platforms/ returns no match
    - All source statements point to src/core/
  </verify>
  <done>
    All Linux installers use data-driven package loading
  </done>
</task>

</tasks>

<verification>
1. src/platforms/linux/ contains: main.sh, post_install.sh, install/
2. No hardcoded package arrays in Linux platform code
3. All scripts source from src/core/
4. load_packages() is used for package loading
5. All scripts pass syntax validation
</verification>

<success_criteria>
- Linux platform code exists under src/platforms/linux/
- All installers use load_packages() instead of hardcoded arrays
- Source statements point to src/core/ (not scripts/utils/ or platforms/*/utils/)
- main.sh can be executed as entry point for Linux
</success_criteria>

<output>
After completion, create `.planning/phases/02-consolidation-data-migration/02-03-SUMMARY.md`
</output>
