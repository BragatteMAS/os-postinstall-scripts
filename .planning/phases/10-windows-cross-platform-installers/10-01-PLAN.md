---
phase: 10-windows-cross-platform-installers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platforms/windows/install/cargo.ps1
  - src/platforms/windows/install/npm.ps1
  - src/platforms/windows/install/ai-tools.ps1
autonomous: true

must_haves:
  truths:
    - "cargo.ps1 installs cargo.txt packages via WinGet-first strategy with cargo-install fallback"
    - "npm.ps1 installs npm.txt packages via npm install -g with idempotent checks"
    - "ai-tools.ps1 installs ai-tools.txt entries via prefix-based dispatch (npm/curl/npx/uv)"
    - "All three scripts follow the exact winget.ps1 pattern (imports, error handling, exit 0)"
    - "DRY_RUN support in all three scripts"
  artifacts:
    - path: "src/platforms/windows/install/cargo.ps1"
      provides: "WinGet-first cargo package installer with cargo fallback"
      min_lines: 80
      contains: "WinGetMap"
    - path: "src/platforms/windows/install/npm.ps1"
      provides: "npm global package installer"
      min_lines: 50
      contains: "npm install -g"
    - path: "src/platforms/windows/install/ai-tools.ps1"
      provides: "Prefix-based AI tools installer"
      min_lines: 70
      contains: "switch.*prefix"
  key_links:
    - from: "src/platforms/windows/install/cargo.ps1"
      to: "src/platforms/windows/core/packages.psm1"
      via: "Import-Module + Read-PackageFile"
      pattern: "Read-PackageFile.*cargo\\.txt"
    - from: "src/platforms/windows/install/npm.ps1"
      to: "src/platforms/windows/core/packages.psm1"
      via: "Import-Module + Read-PackageFile"
      pattern: "Read-PackageFile.*npm\\.txt"
    - from: "src/platforms/windows/install/ai-tools.ps1"
      to: "src/platforms/windows/core/packages.psm1"
      via: "Import-Module + Read-PackageFile"
      pattern: "Read-PackageFile.*ai-tools\\.txt"
---

<objective>
Create three PowerShell installer scripts for Windows: cargo.ps1, npm.ps1, and ai-tools.ps1.

Purpose: Close the v2.1 audit gap where Windows main.ps1 WARN-skips cargo.txt, npm.txt, and ai-tools.txt instead of dispatching to working installers. These three scripts provide the actual installation logic.

Output: Three new files in src/platforms/windows/install/ following the established winget.ps1 pattern.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-windows-cross-platform-installers/10-RESEARCH.md

# Reference pattern (THE template to follow for all three scripts)
@src/platforms/windows/install/winget.ps1

# Core module APIs used by all three scripts
@src/platforms/windows/core/logging.psm1
@src/platforms/windows/core/packages.psm1
@src/platforms/windows/core/errors.psm1

# Data files consumed by the new scripts
@data/packages/cargo.txt
@data/packages/npm.txt
@data/packages/ai-tools.txt

# Unix equivalent for ai-tools prefix dispatch pattern
@src/install/ai-tools.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cargo.ps1 - WinGet-first Cargo package installer</name>
  <files>src/platforms/windows/install/cargo.ps1</files>
  <action>
Create `src/platforms/windows/install/cargo.ps1` following the EXACT structure of `winget.ps1`:

1. **Header:** `#Requires -Version 5.1`, description comment block, `$ErrorActionPreference = 'Continue'`
2. **Imports:** Same three `Import-Module` lines as winget.ps1 (logging, packages, errors)
3. **WinGet mapping hashtable** (`$script:WinGetMap`): Map cargo package names to WinGet IDs. Use the mapping from 10-RESEARCH.md:
   - `bat` = `sharkdp.bat`, `eza` = `eza-community.eza`, `fd-find` = `sharkdp.fd`
   - `lsd` = `lsd-rs.lsd`, `ripgrep` = `BurntSushi.ripgrep.MSVC`, `dust` = `bootandy.dust`
   - `bottom` = `Clement.bottom`, `procs` = `dalance.procs`, `tokei` = `XAMPPRocky.tokei`
   - `hyperfine` = `sharkdp.hyperfine`, `zoxide` = `ajeetdsouza.zoxide`
   - `git-delta` = `dandavison.delta`, `gitui` = `Extrawurst.gitui`
   - `starship` = `Starship.Starship`, `nu` = `Nushell.Nushell`
   - `helix` = `Helix.Helix`, `atuin` = `atuinsh.atuin`
   - All others (sd, bacon, xsv, jql, htmlq, cargo-*) = `$null` (cargo-install fallback)
   - Do NOT add zellij to WinGetMap (handled by SkipOnWindows â€” different semantic: "no Windows support" vs "no WinGet package")
4. **Skip list:** `$script:SkipOnWindows = @('zellij')` -- zellij has no Windows support
5. **`Test-WinGetInstalled` function:** Exact copy from winget.ps1 (winget list --id --exact + output match)
6. **`Test-CargoInstalled` function:** Run `cargo install --list 2>$null`, match `^packagename ` regex
7. **`Install-CargoPackage` function** with three-tier logic:
   - Check `$script:SkipOnWindows` -- skip with DEBUG log
   - Check `$script:WinGetMap[$PackageName]`:
     - If value is non-null: idempotent check via `Test-WinGetInstalled`, then `winget install` with DRY_RUN guard. If WinGet fails, fall through to cargo.
     - If value is `$null`: go to cargo fallback.
   - Cargo fallback: check `Get-Command cargo` availability. If no cargo, WARN + Add-FailedItem + return. If cargo available, `Test-CargoInstalled` idempotent check, then `cargo install $PackageName` with DRY_RUN guard.
8. **Main section:** Write-Log BANNER, WinGet availability check (not fatal -- cargo might still work), `Read-PackageFile -FileName 'cargo.txt'`, foreach loop, `Show-FailureSummary`, `exit 0`

**DRY_RUN pattern:** Check `$env:DRY_RUN -eq 'true'` AFTER idempotent check, BEFORE mutation. Log with `[DRY_RUN]` prefix per established pattern.

**Do NOT:** Auto-install Rust/rustup (per research decision). Do NOT require MSVC. Do NOT add interactive menus (Windows installers are unattended-only, called from main.ps1).
  </action>
  <verify>
Verify file structure:
- File starts with `#Requires -Version 5.1`
- Contains `Import-Module` for all three core modules
- Contains `$script:WinGetMap` with at least 15 entries
- Contains `$script:SkipOnWindows` with `zellij`
- Contains `Test-WinGetInstalled`, `Test-CargoInstalled`, `Install-CargoPackage` functions
- Contains `Read-PackageFile -FileName 'cargo.txt'`
- Contains `$env:DRY_RUN` check
- Contains `Show-FailureSummary`
- Ends with `exit 0`
  </verify>
  <done>cargo.ps1 exists with WinGet-first strategy, cargo-install fallback, zellij skip, DRY_RUN support, and follows winget.ps1 structure exactly</done>
</task>

<task type="auto">
  <name>Task 2: Create npm.ps1 - npm global package installer</name>
  <files>src/platforms/windows/install/npm.ps1</files>
  <action>
Create `src/platforms/windows/install/npm.ps1` following the EXACT structure of `winget.ps1`:

1. **Header:** `#Requires -Version 5.1`, description comment block, `$ErrorActionPreference = 'Continue'`
2. **Imports:** Same three `Import-Module` lines as winget.ps1
3. **`Test-NpmInstalled` function:** Run `npm list -g $PackageName 2>$null | Out-Null`, return `($LASTEXITCODE -eq 0)`. This handles both scoped (`@anthropic-ai/claude-code`) and unscoped packages per Phase 5 decision.
4. **`Install-NpmPackage` function:**
   - Idempotent check via `Test-NpmInstalled`
   - DRY_RUN guard (`$env:DRY_RUN -eq 'true'`) with `[DRY_RUN]` prefix log
   - `npm install -g $PackageName 2>$null`
   - Check `$LASTEXITCODE` for success/failure
   - On failure: `Add-FailedItem`
5. **Main section:**
   - Write-Log BANNER 'NPM Global Package Installer'
   - Node.js availability check: `Get-Command node -ErrorAction SilentlyContinue`. If not found, WARN log with guidance message ("Install Node.js via WinGet (winget.txt includes Schniz.fnm) or download from nodejs.org"), then `exit 0` (graceful, not fatal).
   - Also check npm specifically: `Get-Command npm -ErrorAction SilentlyContinue`
   - `Read-PackageFile -FileName 'npm.txt'`
   - Count check (if 0 packages, WARN + exit 0)
   - foreach loop calling `Install-NpmPackage`
   - `Show-FailureSummary`
   - `exit 0`

**Do NOT:** Install Node.js inside npm.ps1. Do NOT add interactive menus.
  </action>
  <verify>
Verify file structure:
- File starts with `#Requires -Version 5.1`
- Contains `Import-Module` for all three core modules
- Contains `Test-NpmInstalled` function using `npm list -g`
- Contains `Install-NpmPackage` function with `npm install -g`
- Contains `Get-Command node` availability check
- Contains `Read-PackageFile -FileName 'npm.txt'`
- Contains `$env:DRY_RUN` check
- Contains `Show-FailureSummary`
- Ends with `exit 0`
  </verify>
  <done>npm.ps1 exists with npm global install, idempotent check via npm list -g, Node.js availability guard, DRY_RUN support, and follows winget.ps1 structure exactly</done>
</task>

<task type="auto">
  <name>Task 3: Create ai-tools.ps1 - prefix-based AI tools installer</name>
  <files>src/platforms/windows/install/ai-tools.ps1</files>
  <action>
Create `src/platforms/windows/install/ai-tools.ps1` following the EXACT structure of `winget.ps1`, porting the prefix dispatch logic from `src/install/ai-tools.sh`:

1. **Header:** `#Requires -Version 5.1`, description comment block, `$ErrorActionPreference = 'Continue'`
2. **Imports:** Same three `Import-Module` lines as winget.ps1
3. **Helper: `Test-NpmInstalled`** (same function as npm.ps1 -- each script is self-contained, called in separate process): `npm list -g $PackageName 2>$null | Out-Null`, return `($LASTEXITCODE -eq 0)`
4. **Helper: `Test-WinGetInstalled`** (same as winget.ps1 -- needed for ollama WinGet check): `winget list --id --exact` + output match
5. **`Install-AiTool` function** with prefix-based dispatch:
   - Parse prefix: if entry doesn't contain ':', skip with DEBUG log (bare word)
   - Split on first ':': `$parts = $Entry.Split(':', 2)`, `$prefix = $parts[0]`, `$tool = $parts[1]`
   - `switch ($prefix)`:
     - `'npm'`: Check `Get-Command node`. If missing, WARN + Add-FailedItem + return. Else: `Test-NpmInstalled` idempotent check, DRY_RUN guard, `npm install -g $tool`, check `$LASTEXITCODE`, Add-FailedItem on failure.
     - `'curl'`: Inner switch on `$tool`:
       - `'ollama'`: Check `Test-WinGetInstalled -PackageId 'Ollama.Ollama'` for idempotent check. If not installed, DRY_RUN guard, `winget install --id Ollama.Ollama --exact --accept-source-agreements --accept-package-agreements --silent --source winget`. On Windows, `curl:ollama` maps to WinGet (per research).
       - `default`: DEBUG skip unknown curl tool
     - `'npx'`: DEBUG skip "runs on demand"
     - `'uv'`: DEBUG skip "runs on demand"
     - `default`: DEBUG skip unknown prefix
6. **`Show-AiSummary` function** (ported from ai-tools.sh): Display API key configuration info (ANTHROPIC_API_KEY, OPENAI_API_KEY, GEMINI_API_KEY)
7. **Main section:**
   - Write-Log BANNER 'AI Coding Tools'
   - `Read-PackageFile -FileName 'ai-tools.txt'`
   - Count check
   - foreach loop calling `Install-AiTool`
   - Call `Show-AiSummary`
   - `Show-FailureSummary`
   - `exit 0`

**Do NOT:** Add interactive menus or ollama model download (Windows version is unattended-only). Do NOT use curl for ollama on Windows (use WinGet per research).
  </action>
  <verify>
Verify file structure:
- File starts with `#Requires -Version 5.1`
- Contains `Import-Module` for all three core modules
- Contains `Install-AiTool` function with `switch ($prefix)` dispatch
- Contains `npm`, `curl`, `npx`, `uv` cases in the switch
- Contains `Ollama.Ollama` WinGet ID for curl:ollama mapping
- Contains `Read-PackageFile -FileName 'ai-tools.txt'`
- Contains `$env:DRY_RUN` check
- Contains `Show-AiSummary` function with API key info
- Contains `Show-FailureSummary`
- Ends with `exit 0`
  </verify>
  <done>ai-tools.ps1 exists with prefix-based dispatch (npm/curl/npx/uv), ollama via WinGet on Windows, API key summary, DRY_RUN support, and follows winget.ps1 structure exactly</done>
</task>

</tasks>

<verification>
All three scripts:
1. Follow winget.ps1 structure (header, imports, helpers, main, exit 0)
2. Import logging.psm1, packages.psm1, errors.psm1
3. Use Read-PackageFile to load from data/packages/
4. Have idempotent checks before every install operation
5. Support DRY_RUN via $env:DRY_RUN check
6. Track failures via Add-FailedItem
7. Call Show-FailureSummary before exit
8. Exit 0 always (per Phase 1 convention)
</verification>

<success_criteria>
- cargo.ps1 loads cargo.txt, maps most packages to WinGet IDs, falls back to cargo install, skips zellij
- npm.ps1 loads npm.txt, checks Node.js availability, installs via npm install -g
- ai-tools.ps1 loads ai-tools.txt, dispatches by prefix (npm/curl/npx/uv), maps ollama to WinGet
- All three scripts have DRY_RUN support and follow winget.ps1 pattern exactly
</success_criteria>

<output>
After completion, create `.planning/phases/10-windows-cross-platform-installers/10-01-SUMMARY.md`
</output>
