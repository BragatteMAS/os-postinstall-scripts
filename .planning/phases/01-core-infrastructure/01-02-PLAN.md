---
phase: 01-core-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/utils/idempotent.sh
autonomous: true

must_haves:
  truths:
    - "Running any installer twice produces identical system state"
    - "Already-installed packages are skipped with log message"
    - "PATH does not accumulate duplicate entries on re-run"
    - "Dotfiles backup uses date-stamped suffix"
  artifacts:
    - path: "scripts/utils/idempotent.sh"
      provides: "Idempotency helper functions"
      exports: ["is_installed", "ensure_line_in_file", "ensure_dir", "ensure_symlink", "add_to_path", "backup_and_copy"]
  key_links:
    - from: "scripts/utils/idempotent.sh"
      to: "command, grep, ln"
      via: "shell builtins and utilities"
      pattern: "command -v|grep -qF|ln -sfn"
---

<objective>
Create idempotency utilities module that ensures scripts can run multiple times safely.

Purpose: Prevent duplicate installations, PATH pollution, and dotfile overwrites without backup.
Output: `scripts/utils/idempotent.sh` with guard functions for safe repeated execution.
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-infrastructure/01-CONTEXT.md
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create idempotency utilities module</name>
  <files>scripts/utils/idempotent.sh</files>
  <action>
Create `scripts/utils/idempotent.sh` implementing:

1. **Command check functions:**
   - is_installed(): Check if command exists via `command -v`
   - is_apt_installed(): Check if apt package installed via `dpkg -s` (fallback)
   - is_brew_installed(): Check if brew package installed via `brew list`

2. **File manipulation guards:**
   - ensure_line_in_file(line, file): Add line only if not already present (use grep -qF)
   - ensure_dir(path): Create directory if not exists (mkdir -p)
   - ensure_symlink(source, target): Create/update symlink (ln -sfn)

3. **PATH management:**
   - add_to_path(path): Add to PATH only if not already present
   - Pattern: `case ":$PATH:" in *":$1:"*) return 0 ;; esac`

4. **Backup utilities:**
   - backup_and_copy(source, dest): Backup existing file with .bak.YYYY-MM-DD suffix before copying
   - backup_if_exists(file): Create backup of file if it exists

5. **Header requirements:**
   - Prevent multiple sourcing: `[[ -n "${_IDEMPOTENT_SOURCED:-}" ]] && return 0`
   - NO set -e (per CONTEXT decision)

Per CONTEXT: No version checking (let apt upgrade handle it). Just check presence.
  </action>
  <verify>
Run test sequence:
```bash
source scripts/utils/idempotent.sh
# Test is_installed
is_installed bash && echo "bash found"
is_installed nonexistent_command || echo "nonexistent not found"
# Test add_to_path idempotency
PATH_BEFORE="$PATH"
add_to_path "/test/path"
add_to_path "/test/path"  # Should not duplicate
[[ $(echo "$PATH" | grep -o "/test/path" | wc -l) -eq 1 ]] && echo "No PATH duplication"
```
  </verify>
  <done>
- is_installed correctly detects command presence
- ensure_line_in_file does not duplicate lines
- add_to_path prevents PATH duplication
- backup_and_copy creates date-stamped backup
- No set -e in file
  </done>
</task>

<task type="auto">
  <name>Task 2: Test idempotency patterns</name>
  <files>scripts/utils/idempotent.sh</files>
  <action>
Manually test all idempotency functions work as expected:

1. **is_installed tests:**
   - is_installed bash -> should return 0
   - is_installed curl -> should return 0
   - is_installed fake_command_xyz -> should return 1

2. **ensure_line_in_file test:**
   - Create temp file
   - Add line twice
   - Verify line appears only once

3. **add_to_path test:**
   - Add path twice
   - Verify appears only once in $PATH

4. **backup_and_copy test:**
   - Create temp file with content
   - Run backup_and_copy
   - Verify .bak.YYYY-MM-DD file exists
   - Verify original replaced

Run tests and document results.
  </action>
  <verify>
All tests pass:
- Command detection works
- Line deduplication works
- PATH deduplication works
- Backup creates dated file
  </verify>
  <done>
- All 4 test categories pass
- Module is safe for repeated execution
  </done>
</task>

</tasks>

<verification>
1. `bash -c 'source scripts/utils/idempotent.sh'` - No errors on source
2. `bash -c 'source scripts/utils/idempotent.sh && is_installed bash'` - Returns 0
3. `bash -c 'source scripts/utils/idempotent.sh && is_installed nonexistent_xyz'` - Returns 1
4. File does NOT contain `set -e`
</verification>

<success_criteria>
1. scripts/utils/idempotent.sh exists and is sourceable
2. is_installed correctly detects command presence
3. ensure_line_in_file prevents duplicate lines
4. add_to_path prevents PATH pollution
5. backup_and_copy creates .bak.YYYY-MM-DD backups
6. No set -e in the file
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-02-SUMMARY.md`
</output>
