---
phase: 01-core-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lib/platform.sh
autonomous: true

must_haves:
  truths:
    - "Running ./setup.sh correctly identifies macOS vs Linux"
    - "Running ./setup.sh on Linux shows distro name and version"
    - "Unsupported distro shows warning and asks to continue"
    - "Missing package manager exits with clear error"
    - "Bash < 4.0 shows upgrade instructions and exits"
  artifacts:
    - path: "scripts/lib/platform.sh"
      provides: "Platform detection and verification functions"
      exports: ["detect_platform", "verify_all", "DETECTED_OS", "DETECTED_DISTRO", "DETECTED_PKG", "DETECTED_ARCH", "DETECTED_BASH"]
  key_links:
    - from: "scripts/lib/platform.sh"
      to: "uname, /etc/os-release"
      via: "system calls"
      pattern: "uname -s|/etc/os-release"
---

<objective>
Create platform detection module that identifies OS, distro, package manager, architecture, and Bash version.

Purpose: All other scripts depend on knowing which platform they're running on. This module provides DETECTED_* variables and verification functions.
Output: `scripts/lib/platform.sh` with detect_platform() and verify_all() functions.
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-infrastructure/01-CONTEXT.md
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform detection module</name>
  <files>scripts/lib/platform.sh</files>
  <action>
Create `scripts/lib/platform.sh` implementing:

1. **detect_platform() function** that sets:
   - DETECTED_OS: "macos", "linux", "windows", or "unknown" (via uname -s)
   - DETECTED_ARCH: "x86_64" or "arm64" (via uname -m)
   - DETECTED_DISTRO: Linux distro ID from /etc/os-release (ubuntu, debian, pop, linuxmint, elementary, zorin)
   - DETECTED_VERSION: Distro version from /etc/os-release
   - DETECTED_PKG: "apt", "brew", or "winget" (via command -v)
   - DETECTED_BASH: Bash version from BASH_VERSINFO

2. **Verification functions** (per CONTEXT decisions):
   - verify_bash_version(): Exit with instructions if < 4.0
   - verify_supported_distro(): Warn + prompt if not in supported list
   - verify_package_manager(): Exit with error if unsupported
   - check_internet(): curl with 5s timeout, warn + prompt if no connection
   - request_sudo(): Request once upfront, skip if DRY_RUN=true

3. **verify_all() function** that runs in order: OS -> Bash -> Net -> Sudo
   - Print one-line detection output: "Detected: Pop!_OS 22.04 (apt)"
   - Return non-zero if any verification fails

4. **Header requirements:**
   - Prevent multiple sourcing: `[[ -n "${_PLATFORM_SOURCED:-}" ]] && return 0`
   - NO set -e (per CONTEXT decision)
   - Export all DETECTED_* variables

Supported distros list: ubuntu debian pop linuxmint elementary zorin
  </action>
  <verify>
Run: `bash -c 'source scripts/lib/platform.sh && detect_platform && echo "OS=$DETECTED_OS DISTRO=$DETECTED_DISTRO PKG=$DETECTED_PKG ARCH=$DETECTED_ARCH BASH=$DETECTED_BASH"'`
Should output variables with correct values for current system.
  </verify>
  <done>
- detect_platform() sets all 6 DETECTED_* variables
- verify_all() runs verification sequence
- Bash version check shows upgrade instructions on failure
- Unsupported distro prompts user
- No set -e in file
  </done>
</task>

<task type="auto">
  <name>Task 2: Test platform detection on current system</name>
  <files>scripts/lib/platform.sh</files>
  <action>
Create a simple test that sources the module and verifies it works:

1. Source scripts/lib/platform.sh
2. Call detect_platform
3. Verify DETECTED_OS matches current OS (should be "macos" on macOS, "linux" on Linux)
4. Verify DETECTED_PKG is set (brew on macOS, apt on Debian-based Linux)
5. Verify DETECTED_BASH shows 4.x or 5.x
6. Test verify_all() runs without error on current system

Run this test manually and document output.
  </action>
  <verify>
Run: `bash scripts/lib/platform.sh` (should not output anything when sourced)
Run: `bash -c 'source scripts/lib/platform.sh && verify_all'`
Should output detection line and complete without error.
  </verify>
  <done>
- Module loads without error
- detect_platform sets correct values for current system
- verify_all completes successfully on current system
  </done>
</task>

</tasks>

<verification>
1. `bash -c 'source scripts/lib/platform.sh'` - No errors on source
2. `bash -c 'source scripts/lib/platform.sh && detect_platform && [[ -n "$DETECTED_OS" ]]'` - Variables exported
3. `bash -c 'source scripts/lib/platform.sh && verify_bash_version'` - Returns 0 on Bash 4+
4. File does NOT contain `set -e`
</verification>

<success_criteria>
1. scripts/lib/platform.sh exists and is sourceable
2. All 6 DETECTED_* variables are exported after detect_platform()
3. verify_all() prints detection output and runs verification sequence
4. Bash version check provides upgrade instructions on failure
5. No set -e in the file
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-01-SUMMARY.md`
</output>
