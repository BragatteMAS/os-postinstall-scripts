---
phase: 12-structure-dry-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platforms/windows/core/idempotent.psm1
  - src/platforms/windows/install/winget.ps1
  - src/platforms/windows/install/cargo.ps1
  - src/platforms/windows/install/npm.ps1
  - src/platforms/windows/install/ai-tools.ps1
autonomous: true

must_haves:
  truths:
    - "Test-WinGetInstalled exists in exactly one file (windows/core/idempotent.psm1), not in any installer script"
    - "Test-NpmInstalled exists in exactly one file (windows/core/idempotent.psm1), not in any installer script"
    - "Test-CargoInstalled exists in exactly one file (windows/core/idempotent.psm1), not in any installer script"
    - "Every PS1 installer that calls Test-WinGetInstalled or Test-NpmInstalled has its own Import-Module line for idempotent.psm1"
  artifacts:
    - path: "src/platforms/windows/core/idempotent.psm1"
      provides: "Shared idempotent check functions for Windows installers"
      exports: ["Test-WinGetInstalled", "Test-NpmInstalled", "Test-CargoInstalled"]
  key_links:
    - from: "src/platforms/windows/install/winget.ps1"
      to: "src/platforms/windows/core/idempotent.psm1"
      via: "Import-Module with -Force"
      pattern: 'Import-Module.*idempotent\.psm1'
    - from: "src/platforms/windows/install/cargo.ps1"
      to: "src/platforms/windows/core/idempotent.psm1"
      via: "Import-Module with -Force"
      pattern: 'Import-Module.*idempotent\.psm1'
    - from: "src/platforms/windows/install/npm.ps1"
      to: "src/platforms/windows/core/idempotent.psm1"
      via: "Import-Module with -Force"
      pattern: 'Import-Module.*idempotent\.psm1'
    - from: "src/platforms/windows/install/ai-tools.ps1"
      to: "src/platforms/windows/core/idempotent.psm1"
      via: "Import-Module with -Force"
      pattern: 'Import-Module.*idempotent\.psm1'
---

<objective>
Extract duplicated PowerShell idempotent check functions (Test-WinGetInstalled, Test-NpmInstalled, Test-CargoInstalled) from four installer scripts into a single shared module (idempotent.psm1), then rewire each installer to import from that module.

Purpose: DRY-01 -- Eliminate triple-duplication of Test-WinGetInstalled and double-duplication of Test-NpmInstalled across Windows installers. Single source of truth for idempotent checks.
Output: New `idempotent.psm1` module + 4 modified installer scripts with local function definitions removed and Import-Module added.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-structure-dry-cleanup/12-RESEARCH.md
@src/platforms/windows/core/logging.psm1
@src/platforms/windows/install/winget.ps1
@src/platforms/windows/install/cargo.ps1
@src/platforms/windows/install/npm.ps1
@src/platforms/windows/install/ai-tools.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create idempotent.psm1 shared module</name>
  <files>src/platforms/windows/core/idempotent.psm1</files>
  <action>
Create NEW file `src/platforms/windows/core/idempotent.psm1` with three exported functions:

1. **Test-WinGetInstalled** -- Takes `[string]$PackageId` (Mandatory). Runs `winget list --id $PackageId --exact --accept-source-agreements 2>$null`. Returns `$true` if `$LASTEXITCODE -eq 0` AND output matches the package ID via `[regex]::Escape($PackageId)`. Returns `$false` otherwise.

2. **Test-NpmInstalled** -- Takes `[string]$PackageName` (Mandatory). Runs `npm list -g $PackageName 2>$null | Out-Null`. Returns `($LASTEXITCODE -eq 0)`.

3. **Test-CargoInstalled** -- Takes `[string]$PackageName` (Mandatory). Runs `cargo install --list 2>$null`. Returns `$true` if output matches `"^$([regex]::Escape($PackageName)) "`. Returns `$false` otherwise.

Follow the exact code from 12-RESEARCH.md "Code Examples > DRY-01: New idempotent.psm1" section. Include:
- `#Requires -Version 5.1` header
- Comment block matching existing module style (see `logging.psm1` for format)
- Each function with `<# .SYNOPSIS ... #>` help comment
- `Export-ModuleMember -Function Test-WinGetInstalled, Test-NpmInstalled, Test-CargoInstalled` at the end

Do NOT include anything beyond these three functions. No logging imports, no color definitions.
  </action>
  <verify>
Confirm the file exists and contains exactly three function definitions and one Export-ModuleMember statement:
```bash
grep -c "^function " src/platforms/windows/core/idempotent.psm1  # expect 3
grep "Export-ModuleMember" src/platforms/windows/core/idempotent.psm1  # expect one line with all three names
```
  </verify>
  <done>idempotent.psm1 exists in src/platforms/windows/core/ with Test-WinGetInstalled, Test-NpmInstalled, and Test-CargoInstalled exported</done>
</task>

<task type="auto">
  <name>Task 2: Rewire all PS1 installers to import from idempotent.psm1</name>
  <files>
    src/platforms/windows/install/winget.ps1
    src/platforms/windows/install/cargo.ps1
    src/platforms/windows/install/npm.ps1
    src/platforms/windows/install/ai-tools.ps1
  </files>
  <action>
For each of the four installer scripts, make two changes:

**A) ADD Import-Module line** -- Add `Import-Module "$PSScriptRoot/../core/idempotent.psm1" -Force` after the existing Import-Module lines (each file already imports logging.psm1, packages.psm1, and/or errors.psm1). Place the new import alongside them, not at the top of the file.

**B) REMOVE local function definitions** -- Delete the locally-defined check functions:

- **winget.ps1**: Remove `Test-WinGetInstalled` function (approx lines 24-44). This function is called later in the same file -- confirm the call still works via the imported module.
- **cargo.ps1**: Remove `Test-WinGetInstalled` function (approx lines 66-86) AND `Test-CargoInstalled` function (approx lines 88-108).
- **npm.ps1**: Remove `Test-NpmInstalled` function (approx lines 24-43).
- **ai-tools.ps1**: Remove `Test-NpmInstalled` function (approx lines 28-47) AND `Test-WinGetInstalled` function (approx lines 49-72).

**Critical:** Do NOT remove any code beyond the function definitions themselves. Preserve all other logic (package installation loops, error handling, logging calls).

**Why Import-Module per file:** Each PS1 is invoked via `& "$WindowsDir/install/winget.ps1"` (separate process). Module state does not propagate between processes. Each file MUST import independently.
  </action>
  <verify>
Confirm no local Test-* definitions remain and import lines exist:
```bash
# No local definitions in any installer:
grep -rn "^function Test-WinGetInstalled" src/platforms/windows/install/  # expect 0 matches
grep -rn "^function Test-NpmInstalled" src/platforms/windows/install/     # expect 0 matches
grep -rn "^function Test-CargoInstalled" src/platforms/windows/install/   # expect 0 matches

# All four files import the module:
grep -l "idempotent.psm1" src/platforms/windows/install/*.ps1  # expect 4 files

# Functions still exist in the module:
grep -c "^function Test-" src/platforms/windows/core/idempotent.psm1  # expect 3
```
  </verify>
  <done>All four PS1 installers import Test-* functions from idempotent.psm1 instead of defining them locally. Zero duplicate function definitions remain in src/platforms/windows/install/.</done>
</task>

</tasks>

<verification>
Overall DRY-01 verification:
1. `grep -rn "function Test-WinGetInstalled" src/platforms/windows/` -- expect exactly 1 match (in idempotent.psm1)
2. `grep -rn "function Test-NpmInstalled" src/platforms/windows/` -- expect exactly 1 match (in idempotent.psm1)
3. `grep -rn "function Test-CargoInstalled" src/platforms/windows/` -- expect exactly 1 match (in idempotent.psm1)
4. `grep -l "Import-Module.*idempotent" src/platforms/windows/install/*.ps1` -- expect 4 files
</verification>

<success_criteria>
- Test-WinGetInstalled defined in exactly one file (idempotent.psm1)
- Test-NpmInstalled defined in exactly one file (idempotent.psm1)
- Test-CargoInstalled defined in exactly one file (idempotent.psm1)
- All four installer scripts import from idempotent.psm1
- No other code changes in the installer scripts beyond removing local definitions and adding import
</success_criteria>

<output>
After completion, create `.planning/phases/12-structure-dry-cleanup/12-01-SUMMARY.md`
</output>
