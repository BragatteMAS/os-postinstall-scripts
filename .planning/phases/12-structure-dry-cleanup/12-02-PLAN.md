---
phase: 12-structure-dry-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/install/dotfiles-install.sh
  - setup.sh
  - tests/test_harness.sh
  - README.md
  - src/core/platform.sh
  - src/core/packages.sh
autonomous: true

must_haves:
  truths:
    - "Only one install directory exists under src/ (src/install/), not both src/install/ and src/installers/"
    - "Color and format variables are defined only in logging.sh; platform.sh has no independent color definitions"
    - "Running ./setup.sh twice does not hit a readonly DATA_DIR collision error"
    - "All _platform_info/_platform_ok/_platform_warn/_platform_error calls in platform.sh are replaced with log_info/log_ok/log_warn/log_error"
  artifacts:
    - path: "src/install/dotfiles-install.sh"
      provides: "Dotfiles installer (moved from src/installers/)"
    - path: "src/core/platform.sh"
      provides: "Platform detection without duplicate color definitions"
      contains: "log_info|log_ok|log_warn|log_error"
    - path: "src/core/packages.sh"
      provides: "Package loading with guarded DATA_DIR readonly"
      contains: 'if \[\[ -z "\$\{DATA_DIR:-\}"'
  key_links:
    - from: "setup.sh"
      to: "src/install/dotfiles-install.sh"
      via: "source path reference"
      pattern: 'src/install/dotfiles-install\.sh'
    - from: "src/core/platform.sh"
      to: "src/core/logging.sh"
      via: "uses log_info/log_ok/log_warn/log_error (sourced by caller before platform.sh)"
      pattern: 'log_(info|ok|warn|error)'
---

<objective>
Consolidate the duplicate install directory, eliminate duplicate color definitions in platform.sh, and guard against readonly DATA_DIR collision -- three independent Bash-side DRY fixes.

Purpose: DRY-02 (single install directory), DRY-03 (logging.sh as color SSoT), DRY-04 (safe re-source of packages.sh). Each fix eliminates a distinct duplication or collision.
Output: Merged directory structure, cleaner platform.sh, safer packages.sh.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-structure-dry-cleanup/12-RESEARCH.md
@src/core/platform.sh
@src/core/logging.sh
@src/core/packages.sh
@setup.sh
@tests/test_harness.sh
@src/installers/dotfiles-install.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge src/installers/ into src/install/ (DRY-02)</name>
  <files>
    src/install/dotfiles-install.sh
    setup.sh
    tests/test_harness.sh
    README.md
  </files>
  <action>
Three-step directory consolidation:

**Step 1: Move the file**
```bash
git mv src/installers/dotfiles-install.sh src/install/dotfiles-install.sh
```
This preserves git blame history. The file's internal `REPO_ROOT` computation (`"$(cd "${_INSTALLER_DIR}/../.." && pwd -P)"`) still resolves correctly because both `src/installers/` and `src/install/` are at the same depth under `src/`.

**Step 2: Update path references in setup.sh**
Replace ALL occurrences of `src/installers/dotfiles-install.sh` with `src/install/dotfiles-install.sh`. Research identifies 3 occurrences (approx lines 144, 149, 201). Grep to confirm exact count before editing -- Phase 11 may have shifted line numbers.

Search pattern: `src/installers/dotfiles-install.sh`
Replace with: `src/install/dotfiles-install.sh`

**Step 3: Update README.md**
Replace `src/installers/dotfiles-install.sh` with `src/install/dotfiles-install.sh` on line 445 (the symlink_map customization instruction). Grep to confirm exact location before editing.

**Step 4: Update tests/test_harness.sh**
Remove the line `test_directory_exists "src/installers"` (approx line 133). The directory no longer exists. Line 132 already validates `src/install/`.

**Step 5: Delete leftover directory**
Delete `src/installers/CLAUDE.md` and remove the now-empty `src/installers/` directory. `src/install/CLAUDE.md` already exists -- no need to migrate.

```bash
rm src/installers/CLAUDE.md
rmdir src/installers/
```
  </action>
  <verify>
```bash
# File exists in new location:
ls src/install/dotfiles-install.sh  # must exist

# Old directory gone:
ls src/installers/ 2>&1  # must fail (No such file or directory)

# No remaining references to old path:
grep -rn "src/installers" setup.sh tests/test_harness.sh README.md  # expect 0 matches

# setup.sh references new path:
grep -c "src/install/dotfiles-install.sh" setup.sh  # expect 3
```
  </verify>
  <done>src/installers/ directory eliminated. dotfiles-install.sh lives in src/install/. All path references updated. test_harness.sh no longer checks for the removed directory.</done>
</task>

<task type="auto">
  <name>Task 2: Remove duplicate colors from platform.sh (DRY-03)</name>
  <files>src/core/platform.sh</files>
  <action>
Remove duplicate color definitions and logging helpers from `platform.sh`, then replace all callsites with `logging.sh` equivalents.

**Part A: Remove the color variable block**
Remove the entire color definition block (approx lines 32-48). This includes:
- The `if [[ -t 1 ]]; then ... fi` block that defines `readonly _RED`, `readonly _GREEN`, `readonly _YELLOW`, `readonly _BLUE`, `readonly _NC`
- And the `else` branch with empty string assignments

**Part B: Remove the helper function definitions**
Remove the four `_platform_*` function definitions (approx lines 50-64):
- `_platform_info() { ... }`
- `_platform_ok() { ... }`
- `_platform_warn() { ... }`
- `_platform_error() { ... }`

**Part C: Replace all callsites**
Search the ENTIRE `platform.sh` file and replace every call. Complete callsite inventory from research:

| Old Call | New Call |
|----------|---------|
| `_platform_info "..."` | `log_info "..."` |
| `_platform_ok "..."`   | `log_ok "..."` |
| `_platform_warn "..."`  | `log_warn "..."` |
| `_platform_error "..."` | `log_error "..."` |

Research identifies ~15 callsites across the file. Grep for `_platform_` to find all of them -- do not rely solely on the line numbers from research as Phase 11 may have shifted them.

**Safety note:** All three entry points (setup.sh, linux/main.sh, macos/main.sh) already source `logging.sh` BEFORE `platform.sh`. The log_* functions are guaranteed to be available. Do NOT add a `source logging.sh` inside platform.sh.
  </action>
  <verify>
```bash
# No color definitions remain:
grep -n "_RED\|_GREEN\|_YELLOW\|_BLUE\|_NC" src/core/platform.sh  # expect 0 matches

# No _platform_* function definitions remain:
grep -n "^_platform_" src/core/platform.sh  # expect 0 matches

# No _platform_* calls remain:
grep -n "_platform_info\|_platform_ok\|_platform_warn\|_platform_error" src/core/platform.sh  # expect 0 matches

# Uses logging.sh functions instead:
grep -c "log_info\|log_ok\|log_warn\|log_error" src/core/platform.sh  # expect ~15 matches
```
  </verify>
  <done>platform.sh contains zero independent color definitions and zero _platform_* helper functions. All logging goes through log_info/log_ok/log_warn/log_error from logging.sh.</done>
</task>

<task type="auto">
  <name>Task 3: Guard DATA_DIR readonly in packages.sh (DRY-04)</name>
  <files>src/core/packages.sh</files>
  <action>
Wrap the `DATA_DIR` assignment and `readonly` declaration (approx lines 26-27) with a `-z` guard to prevent collision when `config.sh` has already set `DATA_DIR`.

**Before** (current code):
```bash
DATA_DIR="$(cd "${_PACKAGES_DIR}/../../data" 2>/dev/null && pwd -P)"
readonly DATA_DIR
```

**After** (guarded):
```bash
if [[ -z "${DATA_DIR:-}" ]]; then
    DATA_DIR="$(cd "${_PACKAGES_DIR}/../../data" 2>/dev/null && pwd -P)"
    readonly DATA_DIR
fi
```

This is a 2-line-to-4-line change. Nothing else in the file changes.

**Context:** `config.sh` (line 52) declares `readonly DATA_DIR="${PROJECT_ROOT}/data"`. The source guard in `packages.sh` (`[[ -n "${_PACKAGES_SOURCED:-}" ]] && return 0`) normally prevents the collision. But unit tests that reset `_PACKAGES_SOURCED` to re-source packages.sh hit the double-readonly error. The `-z` guard resolves this.
  </action>
  <verify>
```bash
# Guard exists:
grep -A2 'if \[\[ -z "${DATA_DIR:-}"' src/core/packages.sh  # expect the if block

# No unguarded readonly DATA_DIR:
grep -n "^readonly DATA_DIR" src/core/packages.sh  # expect 0 matches (it's now inside the if)
grep -n "readonly DATA_DIR" src/core/packages.sh   # expect 1 match (inside the if block)

# Simulate the scenario: source config.sh (sets DATA_DIR), then source packages.sh (should not crash)
# This is a manual verification: bash -c 'source config.sh && unset _PACKAGES_SOURCED && source src/core/packages.sh && echo OK'
```
  </verify>
  <done>packages.sh DATA_DIR declaration is guarded with `[[ -z "${DATA_DIR:-}" ]]`. Re-sourcing after config.sh no longer triggers readonly collision.</done>
</task>

</tasks>

<verification>
Overall plan verification:
1. `ls src/installers/ 2>&1` -- must fail (directory gone, DRY-02)
2. `ls src/install/dotfiles-install.sh` -- must succeed (file moved, DRY-02)
3. `grep -rn "src/installers" setup.sh tests/ README.md` -- expect 0 matches (DRY-02)
4. `grep -c "_platform_info\|_platform_ok\|_platform_warn\|_platform_error\|_RED\|_GREEN\|_YELLOW\|_BLUE\|_NC" src/core/platform.sh` -- expect 0 (DRY-03)
5. `grep -c "log_info\|log_ok\|log_warn\|log_error" src/core/platform.sh` -- expect ~15 (DRY-03)
6. `grep "DATA_DIR:-" src/core/packages.sh` -- expect the `-z` guard (DRY-04)
</verification>

<success_criteria>
- Only src/install/ exists (src/installers/ deleted)
- setup.sh references src/install/dotfiles-install.sh (3 occurrences)
- README.md references src/install/dotfiles-install.sh (not src/installers/)
- test_harness.sh does not check for src/installers
- platform.sh has zero color definitions and zero _platform_* functions
- platform.sh uses log_info/log_ok/log_warn/log_error exclusively
- packages.sh DATA_DIR is wrapped in -z guard
</success_criteria>

<output>
After completion, create `.planning/phases/12-structure-dry-cleanup/12-02-SUMMARY.md`
</output>
