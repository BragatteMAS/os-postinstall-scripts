---
phase: 05-linux-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platforms/linux/install/apt.sh
autonomous: true

must_haves:
  truths:
    - "APT packages install with automatic dpkg lock handling (no manual fuser loops)"
    - "Failed network requests retry 3 times with exponential backoff before giving up"
    - "Non-interactive mode uses --force-confold to keep existing config files"
    - "Two-pass install: apt.txt first, then apt-post.txt when --post flag passed"
    - "No autoclean/autoremove runs (setup script, not maintenance)"
  artifacts:
    - path: "src/platforms/linux/install/apt.sh"
      provides: "Hardened APT installer with lock handling, retry, two-pass support"
      contains: "DPkg::Lock::Timeout=60"
  key_links:
    - from: "src/platforms/linux/install/apt.sh"
      to: "src/core/packages.sh"
      via: "load_packages()"
      pattern: "load_packages"
    - from: "src/platforms/linux/install/apt.sh"
      to: "src/core/errors.sh"
      via: "record_failure()"
      pattern: "record_failure"
---

<objective>
Harden the existing APT installer with dpkg lock handling, network retry with exponential backoff, DEBIAN_FRONTEND conditional, two-pass install (apt.txt + apt-post.txt), and remove autoclean/autoremove.

Purpose: Make APT installation reliable on systems where dpkg locks contend (unattended-upgrades) and network is unreliable.
Output: Improved `src/platforms/linux/install/apt.sh` that handles real-world failure modes.
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-linux-enhancements/05-CONTEXT.md
@.planning/phases/05-linux-enhancements/05-RESEARCH.md

Key reference files:
@src/platforms/linux/install/apt.sh (MODIFY - current file)
@src/platforms/macos/install/brew.sh (PATTERN REFERENCE - data-driven installer)
@src/core/packages.sh (load_packages)
@src/core/errors.sh (record_failure, FAILED_ITEMS)
@src/core/logging.sh (log_info, log_ok, log_warn, log_error, log_debug, log_banner)
@src/core/idempotent.sh (is_apt_installed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retry_with_backoff() and harden safe_apt_update()</name>
  <files>src/platforms/linux/install/apt.sh</files>
  <action>
  Modify the existing apt.sh file. Preserve the overall structure (header, sourcing, helpers, cleanup, main).

  1. `retry_with_backoff()` is provided by `src/core/errors.sh` (already sourced).
     Do NOT define it locally â€” use the core version directly.

  2. Rewrite `safe_apt_update()`:
     - Replace the `sudo fuser /var/lib/dpkg/lock-frontend` loop with `apt-get -o DPkg::Lock::Timeout=60`
     - Wrap the update command with `retry_with_backoff`
     - Full command: `retry_with_backoff sudo apt-get update -y -o DPkg::Lock::Timeout=60`
     - Keep the log_info message before the call

  3. Add DEBIAN_FRONTEND conditional at top of main section (after FAILED_ITEMS declaration):
     - If `NONINTERACTIVE=true`: `export DEBIAN_FRONTEND=noninteractive`
     - Store `APT_NONINTERACTIVE_OPTS=(-o Dpkg::Options::="--force-confold")` for use in install

  4. Rewrite `apt_install()` to be `apt_hardened_install()`:
     - Keep `is_apt_installed` check at top
     - Build apt command array: `local apt_cmd=(sudo apt-get install -y -o DPkg::Lock::Timeout=60)`
     - If NONINTERACTIVE: append `"${APT_NONINTERACTIVE_OPTS[@]}"` to array
     - Append package name
     - Wrap with `retry_with_backoff "${apt_cmd[@]}"`
     - On failure: `log_warn "Package not found or install failed: $pkg"` (warn, not error -- script continues)

  5. Remove lines 137-139 (autoclean + autoremove). Replace with a comment: `# No cleanup (setup script, not maintenance tool)`
  </action>
  <verify>Run `bash -n src/platforms/linux/install/apt.sh` -- must pass syntax check with exit 0</verify>
  <done>apt.sh has retry_with_backoff(), DPkg::Lock::Timeout=60 in both update and install, DEBIAN_FRONTEND conditional, no autoclean/autoremove</done>
</task>

<task type="auto">
  <name>Task 2: Add two-pass install support (--post flag)</name>
  <files>src/platforms/linux/install/apt.sh</files>
  <action>
  Continue modifying apt.sh main section to support two-pass installation:

  1. After the log_banner line, add argument parsing:
     ```
     # Determine which package file to use
     local pkg_file="apt.txt"
     if [[ "${1:-}" == "--post" ]]; then
         pkg_file="apt-post.txt"
     fi
     ```

  2. Update the `load_packages` call to use `$pkg_file` instead of hardcoded "apt.txt"

  3. Update the log message to reflect which file: `log_info "Loaded ${#PACKAGES[@]} packages from $pkg_file"`

  4. Update the install loop to use `apt_hardened_install` (the renamed function from Task 1)

  5. Verify the complete main section flow:
     - log_banner
     - Parse --post arg
     - DEBIAN_FRONTEND conditional
     - load_packages with dynamic file name
     - safe_apt_update with retry
     - Install loop with apt_hardened_install + record_failure
     - No cleanup section (removed in Task 1)
     - Summary log
     - exit 0

  NOTE: The `local` keyword cannot be used outside a function. Since the main section is not inside a function, use plain variable assignment: `pkg_file="apt.txt"` (not `local pkg_file`).
  </action>
  <verify>Run `bash -n src/platforms/linux/install/apt.sh` -- must pass. Grep for "apt-post.txt" in the file to confirm two-pass support exists. Grep for "autoclean" to confirm it was removed.</verify>
  <done>apt.sh accepts `--post` flag to install from apt-post.txt. No autoclean/autoremove. Syntax valid.</done>
</task>

</tasks>

<verification>
- `bash -n src/platforms/linux/install/apt.sh` exits 0
- File contains `DPkg::Lock::Timeout=60` in both safe_apt_update and apt_hardened_install
- File uses `retry_with_backoff` from core/errors.sh (NOT defined locally)
- File contains `DEBIAN_FRONTEND` conditional block
- File contains `--post` argument handling with apt-post.txt
- File does NOT contain `autoclean` or `autoremove`
- File does NOT contain `fuser`
</verification>

<success_criteria>
APT installer handles dpkg locks via built-in timeout, retries network failures 3 times with backoff, respects NONINTERACTIVE mode with --force-confold, supports two-pass install via --post flag, and has no cleanup operations.
</success_criteria>

<output>
After completion, create `.planning/phases/05-linux-enhancements/05-01-SUMMARY.md`
</output>
