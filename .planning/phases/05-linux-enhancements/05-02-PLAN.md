---
phase: 05-linux-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platforms/linux/install/flatpak.sh
  - src/platforms/linux/install/snap.sh
autonomous: true

must_haves:
  truths:
    - "Flatpak packages install idempotently using flatpak list --app check"
    - "Snap packages install idempotently using snap list check"
    - "Snap classic confinement handled via classic: prefix in data files"
    - "Flathub remote is added with --if-not-exists before any flatpak installs"
    - "Both installers support --post flag for post-install package files"
    - "Legacy scripts at platforms/linux/install/ are removed"
  artifacts:
    - path: "src/platforms/linux/install/flatpak.sh"
      provides: "Data-driven Flatpak installer"
      contains: "load_packages"
    - path: "src/platforms/linux/install/snap.sh"
      provides: "Data-driven Snap installer with classic confinement support"
      contains: "load_packages"
  key_links:
    - from: "src/platforms/linux/install/flatpak.sh"
      to: "data/packages/flatpak.txt"
      via: "load_packages()"
      pattern: "load_packages.*flatpak"
    - from: "src/platforms/linux/install/snap.sh"
      to: "data/packages/snap.txt"
      via: "load_packages()"
      pattern: "load_packages.*snap"
---

<objective>
Create data-driven Flatpak and Snap installers following the established apt.sh pattern, replacing the legacy hardcoded scripts. Include retry logic, idempotency checks, classic confinement support for Snap, Flathub remote setup for Flatpak, and --post flag for two-pass install. Remove legacy scripts.

Purpose: Bring Flatpak/Snap installation to parity with the hardened APT installer pattern.
Output: Two new installer scripts at `src/platforms/linux/install/` and removal of legacy scripts at `platforms/linux/install/`.
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-linux-enhancements/05-CONTEXT.md
@.planning/phases/05-linux-enhancements/05-RESEARCH.md

Key reference files:
@src/platforms/linux/install/apt.sh (PATTERN REFERENCE - data-driven installer with retry)
@src/platforms/linux/install/cargo.sh (PATTERN REFERENCE - existing Linux installer)
@src/core/packages.sh (load_packages)
@src/core/errors.sh (record_failure, FAILED_ITEMS)
@src/core/logging.sh (log_info, log_ok, log_warn, log_error, log_debug, log_banner)
@data/packages/flatpak.txt (main flatpak packages)
@data/packages/flatpak-post.txt (post-install flatpak packages)
@data/packages/snap.txt (main snap packages)
@data/packages/snap-post.txt (post-install snap packages)
@platforms/linux/install/flatpak.sh (LEGACY - to be deleted after replacement)
@platforms/linux/install/snap.sh (LEGACY - to be deleted after replacement)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data-driven Flatpak installer</name>
  <files>src/platforms/linux/install/flatpak.sh</files>
  <action>
  Create `src/platforms/linux/install/flatpak.sh` following the exact apt.sh structure:

  1. Header: same pattern as apt.sh (shebang, description, NOTE about no set -e)
  2. SCRIPT_NAME + SCRIPT_DIR constants
  3. Source core utilities: logging.sh, idempotent.sh, errors.sh, packages.sh (path: `${SCRIPT_DIR}/../../../core/`)

  4. `retry_with_backoff()` is provided by `src/core/errors.sh` (already sourced in step 3).
     Do NOT define it locally — use the core version directly.

  5. Add `ensure_flathub_remote()`:
     - `flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo`
     - Log: `log_info "Ensuring Flathub remote is configured..."`

  6. Add `is_flatpak_installed()`:
     - `flatpak list --app --columns=application 2>/dev/null | grep -q "^${app_id}$"`
     - Return 0 if found, 1 if not

  7. Add `flatpak_install()`:
     - Check `is_flatpak_installed` first, log_debug and return 0 if already installed
     - log_info "Installing: $app_id"
     - Use retry_with_backoff: `retry_with_backoff flatpak install flathub "$app_id" -y --noninteractive`
     - On success: log_ok, return 0
     - On failure: log_warn (not error), return 1

  8. Cleanup trap: same pattern as apt.sh (show FAILED_ITEMS on exit)

  9. Main section:
     - log_banner "Flatpak Package Installer"
     - Parse --post arg: `pkg_file="flatpak.txt"` / `pkg_file="flatpak-post.txt"` if `$1 == "--post"`
     - Check `command -v flatpak`: if missing, `log_warn "flatpak not found, skipping..."` and exit 0
     - Call `ensure_flathub_remote`
     - `load_packages "$pkg_file"` (fail with log_error if can't load)
     - Install loop: `flatpak_install` + `record_failure` on failure
     - Summary log
     - exit 0
  </action>
  <verify>Run `bash -n src/platforms/linux/install/flatpak.sh` -- must pass syntax check</verify>
  <done>flatpak.sh is data-driven, idempotent, has retry logic, ensures Flathub remote, supports --post flag</done>
</task>

<task type="auto">
  <name>Task 2: Create data-driven Snap installer and remove legacy scripts</name>
  <files>src/platforms/linux/install/snap.sh</files>
  <action>
  Create `src/platforms/linux/install/snap.sh` following the same structure:

  1. Header, SCRIPT_NAME, SCRIPT_DIR, source core utilities (same pattern as flatpak.sh)

  2. `retry_with_backoff()` is provided by `src/core/errors.sh` (already sourced in step 1).
     Do NOT define it locally — use the core version directly.

  3. Add `is_snap_installed()`:
     - `snap list 2>/dev/null | grep -q "^${pkg} "`
     - Note the trailing space to avoid partial matches
     - Return 0 if found, 1 if not

  4. Add `snap_install()`:
     - Parse `classic:` prefix: if package starts with `classic:`, strip prefix and set `classic_flag="--classic"`, else `classic_flag=""`
     - Check `is_snap_installed` (using stripped name), log_debug and return 0 if installed
     - log_info "Installing: $pkg"
     - Run: `retry_with_backoff sudo snap install "$pkg" $classic_flag`
     - Do NOT auto-detect classic need on failure (can mask real errors like permission/network issues)
     - If a snap requires classic confinement, it MUST be prefixed with `classic:` in the data file
     - On success: log_ok (include "(classic)" if classic flag was used), return 0
     - On failure: log_warn, return 1

  5. Cleanup trap (same pattern)

  6. Main section:
     - log_banner "Snap Package Installer"
     - Parse --post arg: `pkg_file="snap.txt"` / `pkg_file="snap-post.txt"` if `$1 == "--post"`
     - Check `command -v snap`: if missing, `log_warn "snap not found, skipping..."` and exit 0
     - `load_packages "$pkg_file"`
     - Install loop: `snap_install` + `record_failure` on failure
     - Summary log
     - exit 0

  7. Remove legacy scripts:
     - Delete `platforms/linux/install/flatpak.sh`
     - Delete `platforms/linux/install/snap.sh`
     - Keep `platforms/linux/install/desktop-environments.sh` (deferred, out of Phase 5 scope)
  </action>
  <verify>Run `bash -n src/platforms/linux/install/snap.sh` -- must pass syntax check. Verify legacy files are deleted: `ls platforms/linux/install/` should show only desktop-environments.sh and CLAUDE.md.</verify>
  <done>snap.sh is data-driven with classic confinement support. Legacy flatpak.sh and snap.sh removed. Only desktop-environments.sh remains in legacy dir.</done>
</task>

</tasks>

<verification>
- `bash -n src/platforms/linux/install/flatpak.sh` exits 0
- `bash -n src/platforms/linux/install/snap.sh` exits 0
- Both files contain `load_packages`, `record_failure`, and call `retry_with_backoff` from core/errors.sh (NOT defined locally)
- flatpak.sh contains `ensure_flathub_remote` with `--if-not-exists`
- snap.sh handles `classic:` prefix from data files
- Neither file contains `set -e`
- `platforms/linux/install/flatpak.sh` does NOT exist
- `platforms/linux/install/snap.sh` does NOT exist
- `platforms/linux/install/desktop-environments.sh` still exists
</verification>

<success_criteria>
Both Flatpak and Snap have data-driven installers with retry logic, correct idempotency checks (flatpak list / snap list, NOT dpkg), classic confinement support for Snap, Flathub remote setup for Flatpak, and two-pass install via --post flag. Legacy scripts are removed.
</success_criteria>

<output>
After completion, create `.planning/phases/05-linux-enhancements/05-02-SUMMARY.md`
</output>
