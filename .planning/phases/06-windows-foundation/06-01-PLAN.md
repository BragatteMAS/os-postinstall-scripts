---
phase: 06-windows-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - setup.ps1
  - src/platforms/windows/core/logging.psm1
  - src/platforms/windows/core/packages.psm1
  - src/platforms/windows/core/errors.psm1
autonomous: true

must_haves:
  truths:
    - "setup.ps1 exists at project root and can be invoked with .\\setup.ps1"
    - "Colored logging output uses [OK]/[ERROR]/[WARN]/[INFO]/[DEBUG] format matching Bash"
    - "Package loading reads winget.txt skipping comments and blank lines"
    - "Failure tracking collects failed items and shows summary at end"
    - "All scripts use #Requires -Version 5.1 and no PS7-only features"
  artifacts:
    - path: "setup.ps1"
      provides: "Windows entry point that dispatches to main.ps1"
      contains: "#Requires -Version 5.1"
    - path: "src/platforms/windows/core/logging.psm1"
      provides: "Write-LogOk, Write-LogError, Write-LogWarn, Write-LogInfo, Write-LogDebug, Write-LogBanner"
      exports: "Write-LogOk, Write-LogError, Write-LogWarn, Write-LogInfo, Write-LogDebug, Write-LogBanner"
    - path: "src/platforms/windows/core/packages.psm1"
      provides: "Read-PackageFile, Read-Profile"
      exports: "Read-PackageFile, Read-Profile"
    - path: "src/platforms/windows/core/errors.psm1"
      provides: "Add-FailedItem, Show-FailureSummary, Get-FailureCount, Clear-Failures"
      exports: "Add-FailedItem, Show-FailureSummary, Get-FailureCount, Clear-Failures"
  key_links:
    - from: "setup.ps1"
      to: "src/platforms/windows/main.ps1"
      via: "& $MainScript invocation"
      pattern: "main\\.ps1"
    - from: "src/platforms/windows/core/packages.psm1"
      to: "data/packages/"
      via: "Get-Content file path"
      pattern: "Get-Content.*packages"
---

<objective>
Create the PowerShell entry point (setup.ps1) and three core utility modules (logging, packages, errors) that mirror the Bash core infrastructure established in Phase 1.

Purpose: These modules provide the foundation for all Windows-specific scripts. Every subsequent PowerShell script will Import-Module these. Without them, the WinGet installer (Plan 02) has no logging, no package loading, and no failure tracking.

Output: setup.ps1 at project root + 3 .psm1 modules in src/platforms/windows/core/
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-windows-foundation/06-RESEARCH.md

# Existing patterns to mirror in PowerShell
@src/core/logging.sh
@src/core/packages.sh
@src/core/errors.sh
@config.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PowerShell core modules (logging, packages, errors)</name>
  <files>
    src/platforms/windows/core/logging.psm1
    src/platforms/windows/core/packages.psm1
    src/platforms/windows/core/errors.psm1
  </files>
  <action>
    Create three PowerShell modules that mirror the Bash core utilities 1:1 in behavior.

    **logging.psm1** - Mirror src/core/logging.sh:
    - Add `#Requires -Version 5.1` at top
    - `$script:NoColor` check: respect `$env:NO_COLOR` environment variable (same as Bash NO_COLOR standard)
    - `Write-LogOk` — green "[OK] message" via `Write-Host -ForegroundColor Green`
    - `Write-LogError` — red "[ERROR] message" via `Write-Host -ForegroundColor Red` (write to stderr via `[Console]::Error.WriteLine` is NOT needed — Write-Host goes to console directly, match Bash behavior)
    - `Write-LogWarn` — yellow "[WARN] message" via `Write-Host -ForegroundColor Yellow`
    - `Write-LogInfo` — blue "[INFO] message" via `Write-Host -ForegroundColor Cyan` (PowerShell has no "Blue" that's readable on dark terminals; use Cyan instead)
    - `Write-LogDebug` — gray "[DEBUG] message" via `Write-Host -ForegroundColor DarkGray`, only when `$env:VERBOSE -eq 'true'`
    - `Write-LogBanner` — takes Name and optional Version params, writes "=== Name vVersion ===" in Cyan
    - Timestamp prefix when `$env:VERBOSE -eq 'true'` using `Get-Date -Format 'yyyy-MM-dd HH:mm:ss'`
    - If `$env:NO_COLOR` is set, use `Write-Host` without `-ForegroundColor` (plain text)
    - Export all functions via `Export-ModuleMember -Function Write-LogOk, Write-LogError, Write-LogWarn, Write-LogInfo, Write-LogDebug, Write-LogBanner`

    **packages.psm1** - Mirror src/core/packages.sh:
    - Add `#Requires -Version 5.1` at top
    - `$script:DataDir` — resolve to `$PSScriptRoot/../../../../data` (from src/platforms/windows/core/ up to root, then into data/)
    - `Read-PackageFile` — takes `[string]$FileName` parameter. If not absolute path, resolve relative to `$script:DataDir/packages/`. Read file with `Get-Content`, trim whitespace, skip blank lines and lines starting with `#`. Return string array of package names. If file not found, write warning and return empty array.
    - `Read-Profile` — takes `[string]$ProfileName` parameter. Reads `$script:DataDir/packages/profiles/$ProfileName.txt`, iterates each listed file, calls `Read-PackageFile` for each. Returns hashtable: `@{ FileName = @(packages...) }` so the caller can dispatch per file type. If profile not found, write error and return `$null`.
    - Export: `Read-PackageFile, Read-Profile`

    **errors.psm1** - Mirror src/core/errors.sh:
    - Add `#Requires -Version 5.1` at top
    - `$script:FailedItems = [System.Collections.ArrayList]::new()` — module-level failure tracking list
    - `Add-FailedItem` — takes `[string]$Item`, adds to list, calls `Write-LogError "Failed: $Item"` (import logging module)
    - `Show-FailureSummary` — if count is 0, `Write-LogOk "All operations completed successfully"`. If count > 0, `Write-LogWarn "Summary: N item(s) failed"` then list each item with `"    - $item"` prefix.
    - `Get-FailureCount` — returns `$script:FailedItems.Count`
    - `Clear-Failures` — clears the list
    - Import logging module at top: `Import-Module "$PSScriptRoot/logging.psm1" -Force`
    - Export: `Add-FailedItem, Show-FailureSummary, Get-FailureCount, Clear-Failures`

    **CONSTRAINTS:**
    - PowerShell 5.1 ONLY: Do NOT use `??` (null-coalescing), `?:` (ternary), `ForEach-Object -Parallel`, or `Clean` block
    - Do NOT use `$ErrorActionPreference = 'Stop'` — match Bash "continue on failure" strategy
    - Use `[System.Collections.ArrayList]` not `[System.Collections.Generic.List[string]]` (5.1 compat)
    - NO external modules (no Microsoft.WinGet.Client)
  </action>
  <verify>
    Run PowerShell syntax check on each module:
    `pwsh -NoProfile -Command "Get-Content 'src/platforms/windows/core/logging.psm1' | Out-Null; Write-Host 'logging.psm1 syntax OK'"` (or use `[System.Management.Automation.Language.Parser]::ParseFile()` for proper syntax validation)
    Verify each file starts with `#Requires -Version 5.1`
    Verify Export-ModuleMember is present in each module
  </verify>
  <done>
    Three .psm1 files exist in src/platforms/windows/core/ with:
    - logging.psm1 exports 6 functions (Write-LogOk, Write-LogError, Write-LogWarn, Write-LogInfo, Write-LogDebug, Write-LogBanner)
    - packages.psm1 exports 2 functions (Read-PackageFile, Read-Profile)
    - errors.psm1 exports 4 functions (Add-FailedItem, Show-FailureSummary, Get-FailureCount, Clear-Failures)
    - All files have #Requires -Version 5.1
    - No PS7-only syntax used
  </done>
</task>

<task type="auto">
  <name>Task 2: Create setup.ps1 Windows entry point</name>
  <files>
    setup.ps1
  </files>
  <action>
    Create `setup.ps1` at the project root as the Windows equivalent of `setup.sh`.

    Structure (mirror setup.sh behavior):
    ```
    #Requires -Version 5.1
    # setup.ps1 - Windows Post-Installation Entry Point
    ```

    - `param` block at top: `[string]$Profile = 'developer'`, `[switch]$Help`
    - If `$Help`, print usage (mirror setup.sh -h output adapted for Windows) and `exit 0`
    - Resolve `$ScriptRoot` via `$PSScriptRoot` (automatic variable, always correct)
    - Import core modules:
      ```powershell
      Import-Module "$PSScriptRoot/src/platforms/windows/core/logging.psm1" -Force
      Import-Module "$PSScriptRoot/src/platforms/windows/core/errors.psm1" -Force
      ```
    - Call `Write-LogBanner -Name "OS Post-Install Scripts (Windows)"`
    - Call `Write-LogInfo "Profile: $Profile"`
    - Check WinGet availability: `Get-Command winget -ErrorAction SilentlyContinue`
      - If NOT available: `Write-LogError "WinGet not found"`, then print guidance:
        ```
        WinGet is required but not installed.
        Install options:
          1. Update 'App Installer' from Microsoft Store
          2. Download from: https://aka.ms/getwinget
          3. Windows 11 includes WinGet by default
        ```
        Then `exit 0` (always exit 0 per project convention)
    - Resolve path to main.ps1: `$MainScript = Join-Path $PSScriptRoot 'src/platforms/windows/main.ps1'`
    - If main.ps1 exists: `& $MainScript -Profile $Profile`
    - If not: `Write-LogError "Windows platform handler not found: $MainScript"` and `exit 0`
    - At end: `Show-FailureSummary`, `Write-LogBanner -Name "Setup Complete"`, `exit 0`

    **CONSTRAINTS:**
    - Do NOT use `Set-ExecutionPolicy` inside the script (permanent system change)
    - Add a comment at top: `# Run with: powershell -ExecutionPolicy Bypass -File .\setup.ps1`
    - Always `exit 0` (match Bash convention)
    - No PS7-only syntax
  </action>
  <verify>
    Verify setup.ps1 exists at project root
    Verify it contains `#Requires -Version 5.1`
    Verify it contains `param(` block
    Verify it contains `Get-Command winget` check
    Verify it references `main.ps1`
    Verify it ends with `exit 0`
  </verify>
  <done>
    setup.ps1 exists at project root with:
    - Help flag support (-Help)
    - Profile parameter (default: developer)
    - WinGet availability detection with user guidance
    - Dispatch to src/platforms/windows/main.ps1
    - Failure summary at end
    - Always exit 0
  </done>
</task>

</tasks>

<verification>
1. All 4 files exist: setup.ps1, logging.psm1, packages.psm1, errors.psm1
2. All files start with `#Requires -Version 5.1`
3. No PS7-only syntax: search for `??`, `?:`, `ForEach-Object -Parallel`, `Clean {`
4. Module exports match expected function counts
5. setup.ps1 contains WinGet detection logic
6. packages.psm1 resolves data/ directory correctly relative to its location
</verification>

<success_criteria>
- 3 PowerShell modules in src/platforms/windows/core/ with proper exports
- setup.ps1 at project root with WinGet detection and profile parameter
- All files PowerShell 5.1 compatible (no modern syntax)
- Logging format matches Bash: [OK], [ERROR], [WARN], [INFO], [DEBUG]
- Package loading reads from data/packages/ (shared with Bash)
</success_criteria>

<output>
After completion, create `.planning/phases/06-windows-foundation/06-01-SUMMARY.md`
</output>
