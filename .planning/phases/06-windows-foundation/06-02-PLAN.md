---
phase: 06-windows-foundation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/platforms/windows/install/winget.ps1
  - src/platforms/windows/main.ps1
  - data/packages/profiles/minimal.txt
  - data/packages/profiles/developer.txt
  - data/packages/profiles/full.txt
autonomous: true

must_haves:
  truths:
    - "WinGet installer reads winget.txt and installs each package idempotently"
    - "Already-installed packages are skipped with debug log"
    - "Failed installations are tracked and shown in summary"
    - "Windows orchestrator dispatches to winget.ps1 when profile contains winget.txt"
    - "User can select profile interactively or pass as parameter"
    - "Profile files list winget.txt so Windows gets packages"
  artifacts:
    - path: "src/platforms/windows/install/winget.ps1"
      provides: "Data-driven WinGet package installer"
      contains: "winget install"
    - path: "src/platforms/windows/main.ps1"
      provides: "Windows orchestrator with profile dispatch and interactive menu"
      contains: "param"
    - path: "data/packages/profiles/minimal.txt"
      provides: "Updated minimal profile with winget.txt"
      contains: "winget.txt"
    - path: "data/packages/profiles/developer.txt"
      provides: "Updated developer profile with winget.txt"
      contains: "winget.txt"
    - path: "data/packages/profiles/full.txt"
      provides: "Updated full profile with winget.txt"
      contains: "winget.txt"
  key_links:
    - from: "src/platforms/windows/main.ps1"
      to: "src/platforms/windows/install/winget.ps1"
      via: "& $WingetScript invocation on winget.txt match"
      pattern: "winget\\.ps1"
    - from: "src/platforms/windows/install/winget.ps1"
      to: "data/packages/winget.txt"
      via: "Read-PackageFile 'winget.txt'"
      pattern: "Read-PackageFile.*winget"
    - from: "src/platforms/windows/main.ps1"
      to: "data/packages/profiles/"
      via: "Read-Profile for profile dispatch"
      pattern: "Read-Profile"
---

<objective>
Create the data-driven WinGet installer and the Windows orchestrator (main.ps1) with profile dispatch, completing the Windows Foundation phase.

Purpose: This plan wires the core modules from Plan 01 into a working installer pipeline. After this plan, running `.\setup.ps1` on Windows will install all packages from winget.txt via the selected profile.

Output: winget.ps1 installer + main.ps1 orchestrator + updated profile files
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-windows-foundation/06-RESEARCH.md
@.planning/phases/06-windows-foundation/06-01-SUMMARY.md

# Existing patterns to mirror
@src/platforms/linux/main.sh
@src/platforms/linux/install/apt.sh
@src/platforms/macos/main.sh
@data/packages/winget.txt
@data/packages/profiles/minimal.txt
@data/packages/profiles/developer.txt
@data/packages/profiles/full.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data-driven WinGet installer</name>
  <files>
    src/platforms/windows/install/winget.ps1
  </files>
  <action>
    Create the WinGet package installer, mirroring the apt.sh pattern.

    Structure:
    ```
    #Requires -Version 5.1
    # winget.ps1 - Install WinGet packages (data-driven)
    ```

    - Import core modules at top (relative to script location):
      ```powershell
      Import-Module "$PSScriptRoot/../core/logging.psm1" -Force
      Import-Module "$PSScriptRoot/../core/packages.psm1" -Force
      Import-Module "$PSScriptRoot/../core/errors.psm1" -Force
      ```

    - `Test-WinGetInstalled` function:
      - Takes `[string]$PackageId` parameter
      - Runs `winget list --id $PackageId --exact --accept-source-agreements` and captures output
      - Check `$LASTEXITCODE -eq 0` AND output contains the package ID (winget list returns 0 even when no match on some versions, so check both)
      - Returns `$true` if installed, `$false` otherwise
      - Use `2>$null` to suppress stderr noise from winget

    - `Install-WinGetPackage` function:
      - Takes `[string]$PackageId` parameter
      - First call `Test-WinGetInstalled $PackageId` — if true, `Write-LogDebug "Already installed: $PackageId"` and return
      - `Write-LogInfo "Installing: $PackageId"`
      - Run: `winget install --id $PackageId --exact --accept-source-agreements --accept-package-agreements --silent --source winget 2>$null`
      - If `$LASTEXITCODE -eq 0`: `Write-LogOk "Installed: $PackageId"`
      - Else: `Write-LogWarn "Failed to install: $PackageId"` and `Add-FailedItem $PackageId`
      - Do NOT use `--force` (respect existing installations)

    - Main section (at bottom, outside functions):
      - `Write-LogBanner -Name "WinGet Package Installer"`
      - Load packages: `$Packages = Read-PackageFile 'winget.txt'`
      - If `$Packages.Count -eq 0`: `Write-LogWarn "No packages to install"` and `exit 0`
      - `Write-LogInfo "Loaded $($Packages.Count) packages from winget.txt"`
      - Loop: `foreach ($pkg in $Packages) { Install-WinGetPackage -PackageId $pkg }`
      - Summary: if `(Get-FailureCount) -gt 0` then `Write-LogWarn "Completed with $(Get-FailureCount) failures"` else `Write-LogOk "All packages installed successfully"`
      - `exit 0` (always exit 0)

    **CONSTRAINTS:**
    - Do NOT use `Microsoft.WinGet.Client` module (external dependency)
    - Do NOT use `try/catch` with `$ErrorActionPreference = 'Stop'` — handle errors via `$LASTEXITCODE`
    - WinGet flags: always `--id --exact` for precision, `--accept-source-agreements --accept-package-agreements` for non-interactive, `--silent` for quiet, `--source winget` for explicit source
    - Do NOT use `--force` flag
    - No PS7-only syntax
  </action>
  <verify>
    Verify winget.ps1 exists
    Verify it starts with `#Requires -Version 5.1`
    Verify it contains `winget install` with `--id` and `--exact` flags
    Verify it contains `winget list` for idempotent check
    Verify it imports all 3 core modules
    Verify it calls `Read-PackageFile 'winget.txt'`
    Verify it ends with `exit 0`
  </verify>
  <done>
    winget.ps1 exists in src/platforms/windows/install/ with:
    - Idempotent check via `winget list --id --exact` before each install
    - Silent, non-interactive install flags
    - Failure tracking via Add-FailedItem
    - Data-driven from winget.txt via Read-PackageFile
    - Always exit 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Windows orchestrator and update profiles</name>
  <files>
    src/platforms/windows/main.ps1
    data/packages/profiles/minimal.txt
    data/packages/profiles/developer.txt
    data/packages/profiles/full.txt
  </files>
  <action>
    **Part A: Create main.ps1 — Windows orchestrator**

    Mirror the dual-mode pattern from src/platforms/linux/main.sh and src/platforms/macos/main.sh.

    Structure:
    ```
    #Requires -Version 5.1
    # main.ps1 - Main orchestrator for Windows post-installation
    param(
        [string]$Profile = ''
    )
    ```

    - Import core modules:
      ```powershell
      $WindowsDir = $PSScriptRoot
      Import-Module "$WindowsDir/core/logging.psm1" -Force
      Import-Module "$WindowsDir/core/packages.psm1" -Force
      Import-Module "$WindowsDir/core/errors.psm1" -Force
      ```

    - `Show-Menu` function:
      - Print banner "Windows Post-Installation Script" (mirror Linux/macOS menu)
      - Print options: 1=Minimal, 2=Developer, 3=Full, 0=Exit
      - Use `Write-Host` for menu display (not Write-LogInfo)

    - `Install-Profile` function:
      - Takes `[string]$ProfileName` parameter
      - `Write-LogInfo "Profile: $ProfileName"`
      - Call `$ProfileData = Read-Profile $ProfileName`
      - If `$null -eq $ProfileData`: `Write-LogError "Profile not found: $ProfileName"` and return
      - Iterate `$ProfileData.Keys` (each key is a package file name like "winget.txt", "apt.txt"):
        ```powershell
        foreach ($pkgFile in $ProfileData.Keys) {
            switch ($pkgFile) {
                'winget.txt' {
                    Write-LogInfo "Installing WinGet packages..."
                    & "$WindowsDir/install/winget.ps1"
                }
                default {
                    # Non-Windows package files: skip silently
                    Write-LogDebug "Skipping $pkgFile (not a Windows package file)"
                }
            }
        }
        ```
      - The switch skips apt.txt, brew.txt, brew-cask.txt, cargo.txt, npm.txt, flatpak.txt, snap.txt, ai-tools.txt — they are Linux/macOS only. Log as debug, not warning (per macOS pattern).

    - Main section (dual-mode):
      - If `$Profile` is not empty (unattended mode from setup.ps1):
        - `Write-LogInfo "Running in unattended mode with profile: $Profile"`
        - `Install-Profile -ProfileName $Profile`
        - `exit 0`
      - Else (interactive mode):
        - `do { } while ($true)` loop:
          - Call `Show-Menu`
          - `$choice = Read-Host "Enter your choice (0-3)"`
          - Switch on `$choice`: 1->minimal, 2->developer, 3->full, 0->exit, default->Write-LogWarn "Invalid choice"
          - After each profile install, `Read-Host "Press Enter to continue..."` (mirror Bash behavior)
      - Always `exit 0`

    **Part B: Update profile files to include winget.txt**

    Add `winget.txt` to each profile file. Place it in a `# Windows` section, following the existing pattern of platform-specific comments.

    **minimal.txt** — Add after the macOS section:
    ```
    # Windows
    winget.txt
    ```

    **developer.txt** — Add after the macOS section (before Cross-platform):
    ```
    # Windows
    winget.txt
    ```

    **full.txt** — Add after the macOS section (before Cross-platform):
    ```
    # Windows
    winget.txt
    ```

    **CONSTRAINTS:**
    - Do NOT change existing lines in profile files — only ADD the Windows section
    - Place `# Windows` + `winget.txt` between macOS and Cross-platform sections
    - main.ps1: always `exit 0`
    - No PS7-only syntax
  </action>
  <verify>
    Verify main.ps1 exists with param block, Show-Menu, Install-Profile, dual-mode
    Verify main.ps1 dispatches winget.txt to winget.ps1
    Verify main.ps1 skips non-Windows package files (apt.txt, brew.txt, etc.)
    Verify all 3 profile files contain "winget.txt"
    Verify existing profile content is preserved (apt.txt, brew.txt, etc. still present)
    Run: `grep -c "winget.txt" data/packages/profiles/*.txt` — each should return 1
  </verify>
  <done>
    - main.ps1 exists with interactive menu + unattended mode
    - main.ps1 dispatches winget.txt to winget.ps1 installer
    - All 3 profiles (minimal, developer, full) include winget.txt
    - Existing profile content unchanged
    - Non-Windows files silently skipped
    - Always exit 0
  </done>
</task>

</tasks>

<verification>
1. Full pipeline check: setup.ps1 -> main.ps1 -> winget.ps1 -> winget.txt all linked
2. winget.ps1 uses `winget list --id --exact` for idempotent check
3. winget.ps1 uses `winget install --id --exact --accept-source-agreements --accept-package-agreements --silent --source winget`
4. main.ps1 has both interactive (menu) and unattended ($Profile param) modes
5. All 3 profile files contain "winget.txt" line
6. All .ps1 files start with `#Requires -Version 5.1`
7. No PS7-only syntax anywhere in PowerShell files
8. Legacy platforms/windows/win11.ps1 is NOT deleted (left for reference, not superseded in code)
</verification>

<success_criteria>
- Running `.\setup.ps1` would dispatch to main.ps1 which dispatches to winget.ps1
- winget.ps1 loads packages from data/packages/winget.txt via Read-PackageFile
- Each package is checked before install (idempotent)
- Failed packages tracked and shown in summary
- Profile selection works both interactively and via parameter
- All profile files include winget.txt for Windows package installation
</success_criteria>

<output>
After completion, create `.planning/phases/06-windows-foundation/06-02-SUMMARY.md`
</output>
