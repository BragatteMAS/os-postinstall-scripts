---
phase: 06-windows-foundation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/platforms/windows/install/winget.ps1
  - src/platforms/windows/main.ps1
  - data/packages/profiles/minimal.txt
  - data/packages/profiles/developer.txt
  - data/packages/profiles/full.txt
files_removed:
  - platforms/windows/win11.ps1
autonomous: true

must_haves:
  truths:
    - "WinGet installer reads winget.txt and installs each package idempotently"
    - "winget.ps1 detects WinGet availability and provides guidance if missing"
    - "Already-installed packages are skipped with debug log"
    - "Failed installations are tracked and shown in summary"
    - "Windows orchestrator reads profile file directly and dispatches to winget.ps1"
    - "User can select profile interactively or pass as parameter"
    - "Profile files list winget.txt so Windows gets packages"
    - "Legacy win11.ps1 is removed (superseded by data-driven winget.ps1)"
  artifacts:
    - path: "src/platforms/windows/install/winget.ps1"
      provides: "Data-driven WinGet package installer"
      contains: "winget install"
    - path: "src/platforms/windows/main.ps1"
      provides: "Windows orchestrator with profile dispatch and interactive menu"
      contains: "param"
    - path: "data/packages/profiles/minimal.txt"
      provides: "Updated minimal profile with winget.txt"
      contains: "winget.txt"
    - path: "data/packages/profiles/developer.txt"
      provides: "Updated developer profile with winget.txt"
      contains: "winget.txt"
    - path: "data/packages/profiles/full.txt"
      provides: "Updated full profile with winget.txt"
      contains: "winget.txt"
  key_links:
    - from: "src/platforms/windows/main.ps1"
      to: "src/platforms/windows/install/winget.ps1"
      via: "& $WingetScript invocation on winget.txt match"
      pattern: "winget\\.ps1"
    - from: "src/platforms/windows/install/winget.ps1"
      to: "data/packages/winget.txt"
      via: "Read-PackageFile 'winget.txt'"
      pattern: "Read-PackageFile.*winget"
    - from: "src/platforms/windows/main.ps1"
      to: "data/packages/profiles/"
      via: "Get-Content reads profile file directly (no Read-Profile abstraction)"
      pattern: "Get-Content.*profiles"
---

<objective>
Create the data-driven WinGet installer and the Windows orchestrator (main.ps1) with profile dispatch, completing the Windows Foundation phase.

Purpose: This plan wires the core modules from Plan 01 into a working installer pipeline. After this plan, running `.\setup.ps1` on Windows will install all packages from winget.txt via the selected profile.

Output: winget.ps1 installer + main.ps1 orchestrator + updated profile files
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-windows-foundation/06-RESEARCH.md
@.planning/phases/06-windows-foundation/06-01-SUMMARY.md

# Existing patterns to mirror
@src/platforms/linux/main.sh
@src/platforms/linux/install/apt.sh
@src/platforms/macos/main.sh
@data/packages/winget.txt
@data/packages/profiles/minimal.txt
@data/packages/profiles/developer.txt
@data/packages/profiles/full.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data-driven WinGet installer</name>
  <files>
    src/platforms/windows/install/winget.ps1
  </files>
  <action>
    Create the WinGet package installer, mirroring the apt.sh pattern.

    Structure:
    ```
    #Requires -Version 5.1
    # winget.ps1 - Install WinGet packages (data-driven)
    ```

    - `$ErrorActionPreference = 'Continue'` — explicit, first executable line
    - Import core modules at top (relative to script location):
      ```powershell
      Import-Module "$PSScriptRoot/../core/logging.psm1" -Force
      Import-Module "$PSScriptRoot/../core/packages.psm1" -Force
      Import-Module "$PSScriptRoot/../core/errors.psm1" -Force
      ```

    - `Test-WinGetInstalled` function:
      - Takes `[string]$PackageId` parameter
      - Runs `winget list --id $PackageId --exact --accept-source-agreements` and captures output
      - Check `$LASTEXITCODE -eq 0` AND output contains the package ID (winget list returns 0 even when no match on some versions, so check both)
      - Returns `$true` if installed, `$false` otherwise
      - Use `2>$null` to suppress stderr noise from winget

    - `Install-WinGetPackage` function:
      - Takes `[string]$PackageId` parameter
      - First call `Test-WinGetInstalled $PackageId` — if true, `Write-Log -Level DEBUG -Message "Already installed: $PackageId"` and return
      - `Write-Log -Level INFO -Message "Installing: $PackageId"`
      - Run: `winget install --id $PackageId --exact --accept-source-agreements --accept-package-agreements --silent --source winget 2>$null`
      - If `$LASTEXITCODE -eq 0`: `Write-Log -Level OK -Message "Installed: $PackageId"`
      - Else: `Write-Log -Level WARN -Message "Failed to install: $PackageId"` and `Add-FailedItem $PackageId`
      - Do NOT use `--force` (respect existing installations)

    - Main section (at bottom, outside functions):
      - `Write-Log -Level BANNER -Message "WinGet Package Installer"`
      - **WinGet availability check** (moved from setup.ps1 — each installer owns its tool detection):
        ```powershell
        if (-not (Get-Command winget -ErrorAction SilentlyContinue)) {
            Write-Log -Level ERROR -Message "WinGet not found"
            Write-Host ""
            Write-Host "  WinGet is required but not installed."
            Write-Host "  Install options:"
            Write-Host "    1. Update 'App Installer' from Microsoft Store"
            Write-Host "    2. Download from: https://aka.ms/getwinget"
            Write-Host "    3. Windows 11 includes WinGet by default"
            Write-Host ""
            exit 0
        }
        ```
      - Load packages: `$Packages = Read-PackageFile 'winget.txt'`
      - If `$Packages.Count -eq 0`: `Write-Log -Level WARN -Message "No packages to install"` and `exit 0`
      - `Write-Log -Level INFO -Message "Loaded $($Packages.Count) packages from winget.txt"`
      - Loop: `foreach ($pkg in $Packages) { Install-WinGetPackage -PackageId $pkg }`
      - `exit 0` (always exit 0 — failure summary is called by setup.ps1 or main.ps1)

    **CONSTRAINTS:**
    - Do NOT use `Microsoft.WinGet.Client` module (external dependency)
    - Do NOT use `try/catch` with `$ErrorActionPreference = 'Stop'` — handle errors via `$LASTEXITCODE`
    - WinGet flags: always `--id --exact` for precision, `--accept-source-agreements --accept-package-agreements` for non-interactive, `--silent` for quiet, `--source winget` for explicit source
    - Do NOT use `--force` flag
    - No PS7-only syntax
  </action>
  <verify>
    Verify winget.ps1 exists
    Verify it starts with `#Requires -Version 5.1`
    Verify it contains `$ErrorActionPreference = 'Continue'`
    Verify it contains `Get-Command winget` check with guidance if missing
    Verify it contains `winget install` with `--id` and `--exact` flags
    Verify it contains `winget list` for idempotent check
    Verify it imports all 3 core modules
    Verify it calls `Read-PackageFile 'winget.txt'`
    Verify it ends with `exit 0`
  </verify>
  <done>
    winget.ps1 exists in src/platforms/windows/install/ with:
    - $ErrorActionPreference = 'Continue' explicit
    - WinGet availability check with user guidance if missing
    - Idempotent check via `winget list --id --exact` before each install
    - Silent, non-interactive install flags
    - Failure tracking via Add-FailedItem
    - Data-driven from winget.txt via Read-PackageFile
    - Always exit 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Windows orchestrator and update profiles</name>
  <files>
    src/platforms/windows/main.ps1
    data/packages/profiles/minimal.txt
    data/packages/profiles/developer.txt
    data/packages/profiles/full.txt
  </files>
  <action>
    **Part A: Create main.ps1 — Windows orchestrator**

    Mirror the dual-mode pattern from src/platforms/linux/main.sh (especially the direct profile file reading at line 108).

    Structure:
    ```
    #Requires -Version 5.1
    # main.ps1 - Main orchestrator for Windows post-installation
    param(
        [string]$Profile = ''
    )
    $ErrorActionPreference = 'Continue'
    ```

    - Import core modules:
      ```powershell
      $WindowsDir = $PSScriptRoot
      Import-Module "$WindowsDir/core/logging.psm1" -Force
      Import-Module "$WindowsDir/core/packages.psm1" -Force
      Import-Module "$WindowsDir/core/errors.psm1" -Force
      ```

    - Resolve DataDir for profile file access:
      ```powershell
      $ProjectRoot = (Resolve-Path "$WindowsDir/../../..").Path
      $DataDir = Join-Path $ProjectRoot 'data'
      ```

    - `Show-Menu` function:
      - Print banner "Windows Post-Installation Script" (mirror Linux/macOS menu)
      - Print options: 1=Minimal, 2=Developer, 3=Full, 0=Exit
      - Use `Write-Host` for menu display (not Write-Log)

    - `Install-Profile` function:
      - Takes `[string]$ProfileName` parameter
      - `Write-Log -Level INFO -Message "Profile: $ProfileName"`
      - Read profile file DIRECTLY (matching Linux main.sh pattern — no Read-Profile abstraction):
        ```powershell
        $profileFile = Join-Path $DataDir 'packages' 'profiles' "$ProfileName.txt"
        if (-not (Test-Path $profileFile)) {
            Write-Log -Level ERROR -Message "Profile not found: $ProfileName"
            return
        }
        $entries = Get-Content -Path $profileFile -Encoding UTF8 |
            ForEach-Object { $_.Trim() } |
            Where-Object { $_ -ne '' -and -not $_.StartsWith('#') }
        ```
      - Dispatch based on file name (matching Linux main.sh case statement):
        ```powershell
        foreach ($pkgFile in $entries) {
            switch ($pkgFile) {
                'winget.txt' {
                    Write-Log -Level INFO -Message "Installing WinGet packages..."
                    & "$WindowsDir/install/winget.ps1"
                }
                default {
                    # Non-Windows package files (apt.txt, brew.txt, etc.): skip silently
                    Write-Log -Level DEBUG -Message "Skipping $pkgFile (not a Windows package file)"
                }
            }
        }
        ```
      - Each installer (winget.ps1) reads its own package file independently via `Read-PackageFile`.
      - The switch skips apt.txt, brew.txt, brew-cask.txt, cargo.txt, npm.txt, flatpak.txt, snap.txt, ai-tools.txt — they are Linux/macOS only. Log as debug, not warning (per macOS pattern).

    - Main section (dual-mode):
      - If `$Profile` is not empty (unattended mode from setup.ps1):
        - `Write-Log -Level INFO -Message "Running in unattended mode with profile: $Profile"`
        - `Install-Profile -ProfileName $Profile`
        - `exit 0`
      - Else (interactive mode):
        - `do { } while ($true)` loop:
          - Call `Show-Menu`
          - `$choice = Read-Host "Enter your choice (0-3)"`
          - Switch on `$choice`: 1->minimal, 2->developer, 3->full, 0->`Show-FailureSummary` then exit, default->`Write-Log -Level WARN "Invalid choice"`
          - After each profile install, `Read-Host "Press Enter to continue..."` (mirror Bash behavior)
      - When exiting interactive mode (choice 0): call `Show-FailureSummary` before `exit 0` (since setup.ps1 isn't in the call chain for direct interactive use)
      - Always `exit 0`

    **Part B: Update profile files to include winget.txt**

    Add `winget.txt` to each profile file. Place it in a `# Windows` section, following the existing pattern of platform-specific comments.

    **minimal.txt** — Add after the macOS section:
    ```
    # Windows
    winget.txt
    ```

    **developer.txt** — Add after the macOS section (before Cross-platform):
    ```
    # Windows
    winget.txt
    ```

    **full.txt** — Add after the macOS section (before Cross-platform):
    ```
    # Windows
    winget.txt
    ```

    **Part C: Remove legacy win11.ps1**

    Delete `platforms/windows/win11.ps1` — superseded by data-driven winget.ps1. All package IDs already extracted to `data/packages/winget.txt` in Phase 2.

    **CONSTRAINTS:**
    - Do NOT change existing lines in profile files — only ADD the Windows section
    - Place `# Windows` + `winget.txt` between macOS and Cross-platform sections
    - main.ps1: `$ErrorActionPreference = 'Continue'` explicit
    - main.ps1: always `exit 0`
    - No PS7-only syntax
  </action>
  <verify>
    Verify main.ps1 exists with param block, Show-Menu, Install-Profile, dual-mode
    Verify main.ps1 has `$ErrorActionPreference = 'Continue'`
    Verify main.ps1 reads profile file directly with Get-Content (NOT via Read-Profile function)
    Verify main.ps1 dispatches winget.txt to winget.ps1
    Verify main.ps1 skips non-Windows package files (apt.txt, brew.txt, etc.)
    Verify main.ps1 calls Show-FailureSummary when exiting interactive mode
    Verify all 3 profile files contain "winget.txt"
    Verify existing profile content is preserved (apt.txt, brew.txt, etc. still present)
    Verify platforms/windows/win11.ps1 is deleted
    Run: `grep -c "winget.txt" data/packages/profiles/*.txt` — each should return 1
  </verify>
  <done>
    - main.ps1 exists with interactive menu + unattended mode
    - main.ps1 reads profile file directly (no Read-Profile abstraction)
    - main.ps1 dispatches winget.txt to winget.ps1 installer
    - main.ps1 calls Show-FailureSummary in interactive exit path
    - All 3 profiles (minimal, developer, full) include winget.txt
    - Existing profile content unchanged
    - Non-Windows files silently skipped
    - Legacy win11.ps1 removed
    - Always exit 0
  </done>
</task>

</tasks>

<verification>
1. Full pipeline check: setup.ps1 -> main.ps1 -> winget.ps1 -> winget.txt all linked
2. winget.ps1 checks WinGet availability with guidance if missing
3. winget.ps1 uses `winget list --id --exact` for idempotent check
4. winget.ps1 uses `winget install --id --exact --accept-source-agreements --accept-package-agreements --silent --source winget`
5. main.ps1 reads profile file directly (no Read-Profile)
6. main.ps1 has both interactive (menu) and unattended ($Profile param) modes
7. main.ps1 calls Show-FailureSummary in interactive exit path
8. All 3 profile files contain "winget.txt" line
9. All .ps1 files start with `#Requires -Version 5.1`
10. All .ps1 files have `$ErrorActionPreference = 'Continue'` explicit
11. No PS7-only syntax anywhere in PowerShell files
12. Legacy platforms/windows/win11.ps1 is deleted
</verification>

<success_criteria>
- Running `.\setup.ps1` would dispatch to main.ps1 which dispatches to winget.ps1
- winget.ps1 detects WinGet and provides guidance if missing
- winget.ps1 loads packages from data/packages/winget.txt via Read-PackageFile
- Each package is checked before install (idempotent)
- Failed packages tracked and shown in summary
- Profile selection works both interactively and via parameter
- All profile files include winget.txt for Windows package installation
- Legacy win11.ps1 removed (data already in winget.txt)
</success_criteria>

<output>
After completion, create `.planning/phases/06-windows-foundation/06-02-SUMMARY.md`
</output>
