---
phase: 07-user-experience-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/progress.sh
  - src/platforms/linux/main.sh
  - src/platforms/macos/main.sh
autonomous: true

must_haves:
  truths:
    - "User sees [Step X/Y] prefix during profile installation showing current section"
    - "Step counter only counts platform-relevant files (no phantom brew steps on Linux, no apt steps on macOS)"
    - "DRY_RUN banner is displayed prominently when DRY_RUN=true before installation begins"
  artifacts:
    - path: "src/core/progress.sh"
      provides: "Step counter helpers and DRY_RUN banner"
      contains: "show_dry_run_banner"
    - path: "src/platforms/linux/main.sh"
      provides: "Step-counted Linux profile dispatch"
      contains: "Step.*/"
    - path: "src/platforms/macos/main.sh"
      provides: "Step-counted macOS profile dispatch"
      contains: "Step.*/"
  key_links:
    - from: "src/platforms/linux/main.sh"
      to: "src/core/progress.sh"
      via: "source"
      pattern: "source.*progress\\.sh"
    - from: "src/platforms/macos/main.sh"
      to: "src/core/progress.sh"
      via: "source"
      pattern: "source.*progress\\.sh"
---

<objective>
Add real-time progress feedback so users know where they are during installation.

Purpose: Users currently see individual package install logs but have no idea how far along the overall process is. Adding step counters to orchestrators and a DRY_RUN banner addresses UX-01 (progress feedback).

Output: New `src/core/progress.sh` module with step-counting helpers, updated Linux and macOS orchestrators with `[Step X/Y]` prefixed dispatch.
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-user-experience-polish/07-RESEARCH.md

@src/core/logging.sh
@src/core/errors.sh
@src/platforms/linux/main.sh
@src/platforms/macos/main.sh
@data/packages/profiles/developer.txt
@data/packages/profiles/full.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/core/progress.sh module</name>
  <files>src/core/progress.sh</files>
  <action>
Create `src/core/progress.sh` with:

1. **Source guard:** `[[ -n "${_PROGRESS_SOURCED:-}" ]] && return 0` + readonly

2. **show_dry_run_banner()** function:
   - If `[[ "${DRY_RUN:-}" == "true" ]]`, print a prominent banner using log_warn:
     ```
     log_warn "========================================="
     log_warn "  DRY RUN MODE - No changes will be made"
     log_warn "========================================="
     ```
   - If DRY_RUN is not true, do nothing (return 0)

3. **count_platform_steps()** function:
   - Args: `$1` = profile_file path, `$2` = platform ("linux" or "macos")
   - Reads the profile file, skips comments and empty lines
   - For each package file entry, checks if it's relevant to the platform:
     - Linux relevant: `apt*.txt`, `flatpak*.txt`, `snap*.txt`, `cargo.txt`, `ai-tools.txt`
     - macOS relevant: `brew.txt`, `brew-cask.txt`, `cargo.txt`, `ai-tools.txt`
     - Both platforms skip: files not matching their platform
   - Also counts dev-env and rust-cli as steps if profile is not "minimal" (for Linux -- these run before the dispatch loop)
   - Echoes the count (integer) to stdout for capture via `$(count_platform_steps ...)`
   - Uses case statement for platform filtering (matching the dispatch case in each main.sh)

4. **Export functions:** `export -f show_dry_run_banner count_platform_steps`

Pattern notes:
- Follow existing module pattern from logging.sh and errors.sh
- NO associative arrays (Bash 3.2 compat)
- `== "true"` for DRY_RUN check (locked decision [03-04])
- Source logging.sh if not already sourced (same guard pattern as errors.sh)
  </action>
  <verify>
Run: `bash -n src/core/progress.sh` (syntax check passes)
Run: `source src/core/progress.sh && type show_dry_run_banner && type count_platform_steps` (functions exist)
Run: `DRY_RUN=true source src/core/progress.sh && show_dry_run_banner` (shows banner)
Run: `DRY_RUN=false source src/core/progress.sh && show_dry_run_banner` (no output)
  </verify>
  <done>progress.sh exists with show_dry_run_banner and count_platform_steps, syntax-valid, Bash 3.2 compatible</done>
</task>

<task type="auto">
  <name>Task 2: Add step counting to Linux and macOS orchestrators</name>
  <files>src/platforms/linux/main.sh, src/platforms/macos/main.sh</files>
  <action>
**Linux main.sh changes:**

1. Source progress.sh after errors.sh:
   ```bash
   source "${LINUX_DIR}/../../core/progress.sh" || {
       log_error "Failed to load progress.sh"
       exit 1
   }
   ```

2. In `install_profile()`, BEFORE the dispatch loop, add step counting:
   - Call `show_dry_run_banner` at the start of install_profile
   - Count platform-relevant steps: use `count_platform_steps "$profile_file" "linux"`
   - If profile is not "minimal", add 2 to total (dev-env + rust-cli pre-dispatch steps)
   - Initialize `local current_step=0`

3. For the dev-env and rust-cli pre-dispatch block (the `if [[ "$profile_name" != "minimal" ]]` block):
   - Add step counter: `((current_step++))` before each, log with `[Step ${current_step}/${total_steps}]` prefix
   - Example: `log_info "[Step ${current_step}/${total_steps}] Setting up development environment..."`

4. In the `while` dispatch loop, add step counting:
   - For each PLATFORM-RELEVANT case (apt.txt, apt-post.txt, flatpak*.txt, snap*.txt, cargo.txt, ai-tools.txt): increment `((current_step++))` and add `[Step ${current_step}/${total_steps}]` prefix to the log_info message
   - For NON-platform cases (brew*.txt, winget.txt) and npm.txt: do NOT increment counter (they are already excluded from total)
   - For `*` default case: do NOT increment counter

**macOS main.sh changes:**

1. Source progress.sh after errors.sh (same pattern as Linux)

2. In `install_profile()`:
   - Call `show_dry_run_banner` at the start
   - Count steps: `count_platform_steps "$profile_file" "macos"`
   - Add 1 for Homebrew installation step (always runs first)
   - Initialize `local current_step=0`

3. Before `bash "${MACOS_DIR}/install/homebrew.sh"`:
   - `((current_step++))` and `log_info "[Step ${current_step}/${total_steps}] Ensuring Homebrew is installed..."`

4. In the `while` dispatch loop:
   - For brew.txt, brew-cask.txt, cargo.txt, ai-tools.txt: increment counter and prefix with `[Step ${current_step}/${total_steps}]`
   - For apt*.txt, flatpak*.txt, snap*.txt, winget.txt: no counter (already excluded from total)
   - For `*` default: no counter

Key patterns to preserve:
- `bash "script.sh"` sub-process pattern (do NOT change to source)
- Existing case structure and log messages
- LINUX_DIR / MACOS_DIR pattern (NOT SCRIPT_DIR)
- `|| [[ -n "$pkg_file" ]]` in while loop for last-line-without-newline
  </action>
  <verify>
Run: `bash -n src/platforms/linux/main.sh` (syntax check passes)
Run: `bash -n src/platforms/macos/main.sh` (syntax check passes)
Grep: `rg "Step.*/" src/platforms/linux/main.sh` (shows step counter lines)
Grep: `rg "Step.*/" src/platforms/macos/main.sh` (shows step counter lines)
Grep: `rg "progress.sh" src/platforms/linux/main.sh src/platforms/macos/main.sh` (both source it)
Grep: `rg "show_dry_run_banner" src/platforms/linux/main.sh src/platforms/macos/main.sh` (both call it)
  </verify>
  <done>Both orchestrators show [Step X/Y] progress for platform-relevant steps only, call show_dry_run_banner at profile start</done>
</task>

</tasks>

<verification>
1. `bash -n src/core/progress.sh` -- no syntax errors
2. `bash -n src/platforms/linux/main.sh` -- no syntax errors
3. `bash -n src/platforms/macos/main.sh` -- no syntax errors
4. `rg "Step" src/platforms/linux/main.sh | wc -l` -- multiple step-counted log lines
5. `rg "show_dry_run_banner" src/core/progress.sh src/platforms/linux/main.sh src/platforms/macos/main.sh` -- defined and called
6. No associative arrays (`rg "declare -A"` returns nothing in new/modified files)
</verification>

<success_criteria>
- progress.sh module exists with show_dry_run_banner() and count_platform_steps()
- Linux main.sh shows [Step X/Y] for platform-relevant sections
- macOS main.sh shows [Step X/Y] for platform-relevant sections
- Step count excludes non-platform package files (no phantom steps)
- DRY_RUN banner displayed when DRY_RUN=true
- All files pass bash -n syntax check
- No Bash 4+ features used (no associative arrays, no nameref)
</success_criteria>

<output>
After completion, create `.planning/phases/07-user-experience-polish/07-01-SUMMARY.md`
</output>
