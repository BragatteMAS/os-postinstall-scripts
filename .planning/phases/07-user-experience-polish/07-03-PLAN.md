---
phase: 07-user-experience-polish
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - src/core/progress.sh
  - setup.sh
autonomous: true

must_haves:
  truths:
    - "After setup completes, user sees a summary with profile, platform, duration, and section results"
    - "Summary shows count of completed sections and any failed sections"
    - "Duration is displayed in Xm Ys format using SECONDS builtin"
    - "./setup.sh with no args starts developer profile setup (sensible default)"
    - "DRY_RUN summary says 'Dry run complete' instead of 'Setup Complete'"
  artifacts:
    - path: "src/core/progress.sh"
      provides: "show_completion_summary function with duration and section tracking"
      contains: "show_completion_summary"
    - path: "setup.sh"
      provides: "SECONDS timer initialization and completion summary call"
      contains: "SECONDS"
  key_links:
    - from: "setup.sh"
      to: "src/core/progress.sh"
      via: "source and call show_completion_summary"
      pattern: "show_completion_summary"
    - from: "setup.sh"
      to: "src/core/errors.sh"
      via: "get_failure_count for summary integration"
      pattern: "get_failure_count"
---

<objective>
Add a rich completion summary and verify one-command setup works with sensible defaults.

Purpose: After installation completes, users need a clear picture of what happened (UX-03). Additionally, `./setup.sh` must work as a one-command setup with sensible defaults (UX-04). This plan adds `show_completion_summary()` with duration tracking and integrates it into setup.sh, replacing the bare `show_failure_summary` + `log_banner "Setup Complete"`.

Output: Enhanced progress.sh with completion summary, setup.sh with SECONDS timer and rich end-of-run output.
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-user-experience-polish/07-RESEARCH.md
@.planning/phases/07-user-experience-polish/07-01-SUMMARY.md
@.planning/phases/07-user-experience-polish/07-02-SUMMARY.md

@src/core/progress.sh
@src/core/errors.sh
@setup.sh
@config.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add show_completion_summary() to progress.sh</name>
  <files>src/core/progress.sh</files>
  <action>
Add `show_completion_summary()` function to the existing `src/core/progress.sh` (created in 07-01).

The function takes these arguments:
- `$1` = profile name (e.g., "developer")
- `$2` = platform (e.g., "linux", "macos")

Implementation:

```bash
show_completion_summary() {
    local profile="${1:-unknown}"
    local platform="${2:-unknown}"
    local elapsed=${SECONDS:-0}
    local mins=$((elapsed / 60))
    local secs=$((elapsed % 60))
    local fail_count
    fail_count=$(get_failure_count 2>/dev/null || echo 0)

    echo ""
    if [[ "${DRY_RUN:-}" == "true" ]]; then
        log_banner "Dry Run Complete"
    else
        log_banner "Setup Complete"
    fi

    log_info "Profile:  ${profile}"
    log_info "Platform: ${platform}"
    log_info "Duration: ${mins}m ${secs}s"
    echo ""

    if [[ "$fail_count" -gt 0 ]]; then
        log_warn "Completed with ${fail_count} failure(s)"
        show_failure_summary
    else
        log_ok "All sections completed successfully"
    fi

    echo ""
}
```

Key design decisions:
- Uses `SECONDS` builtin (set to 0 in setup.sh at start -- this function reads the accumulated value)
- Calls `get_failure_count()` from errors.sh (already sourced in setup.sh)
- Calls `show_failure_summary()` from errors.sh only if there are failures
- DRY_RUN-aware: says "Dry Run Complete" instead of "Setup Complete"
- NO installed/skipped per-package counters (user decision: orchestrator-level tracking only, not cross-process aggregation)
- Simple and clean output that matches existing log format

Export the function: `export -f show_completion_summary`
  </action>
  <verify>
Run: `bash -n src/core/progress.sh` (syntax check passes)
Run: `source src/core/progress.sh && type show_completion_summary` (function exists)
Grep: `rg "show_completion_summary" src/core/progress.sh` (function defined)
  </verify>
  <done>show_completion_summary exists in progress.sh with profile, platform, duration, and failure integration</done>
</task>

<task type="auto">
  <name>Task 2: Integrate completion summary into setup.sh</name>
  <files>setup.sh</files>
  <action>
Modify setup.sh (which already has flag parsing from 07-02) to:

1. **Source progress.sh** after sourcing errors.sh:
   ```bash
   source "${CORE_DIR}/progress.sh"
   ```

2. **Initialize SECONDS timer** at the very start of `main()`:
   ```bash
   SECONDS=0
   ```

3. **Replace the bare summary at the end of main():**
   Change:
   ```bash
   # Show summary
   show_failure_summary
   log_banner "Setup Complete"
   ```
   To:
   ```bash
   # Show completion summary
   show_completion_summary "$profile" "${DETECTED_OS:-unknown}"
   ```

4. **Update the cleanup trap in errors.sh interaction:**
   The cleanup() trap in errors.sh calls show_failure_summary(). However, setup.sh's own cleanup trap is set by `setup_error_handling`. Since sub-installers run in separate processes (bash "script.sh"), their cleanup traps are isolated. The main setup.sh cleanup trap might fire on early exit (Ctrl+C). This is fine -- the cleanup trap in errors.sh will show failures on abnormal exit, and the normal exit path shows the rich summary.

   To avoid double-summary on normal exit, the `show_completion_summary` call in main() should be followed by `clear_failures` so the cleanup trap's show_failure_summary sees zero items. Alternatively, since main() returns normally and the exit trap fires, we need to handle this:

   Add a flag before the summary:
   ```bash
   # Show completion summary (prevents duplicate from cleanup trap)
   show_completion_summary "$profile" "${DETECTED_OS:-unknown}"
   _SUMMARY_SHOWN=1
   ```

   Then in setup.sh, override the cleanup trap AFTER `setup_error_handling`:
   ```bash
   cleanup() {
       if [[ -z "${_SUMMARY_SHOWN:-}" ]]; then
           show_failure_summary
       fi
       cleanup_temp_dir
       exit 0
   }
   trap cleanup EXIT INT TERM
   ```

   This way: normal exit shows rich summary (from main), abnormal exit (Ctrl+C) shows failure summary (from cleanup). No duplicates.

5. **Verify one-command setup (UX-04):**
   setup.sh already defaults to "developer" profile via `DEFAULT_PROFILE` in config.sh. The flag parsing from 07-02 preserves this behavior. Verify that `./setup.sh` (no args) works: it should detect platform, use developer profile, and complete with summary.

   No changes needed for UX-04 -- it's already satisfied. Just verify the flow works end-to-end.
  </action>
  <verify>
Run: `bash -n setup.sh` (syntax check passes)
Grep: `rg "SECONDS" setup.sh` (timer initialized)
Grep: `rg "show_completion_summary" setup.sh` (called at end of main)
Grep: `rg "progress.sh" setup.sh` (sourced)
Run: `bash setup.sh --help` (shows all flags, profiles, and actions)
  </verify>
  <done>setup.sh initializes SECONDS timer, calls show_completion_summary with profile and platform, no duplicate summaries on normal exit</done>
</task>

</tasks>

<verification>
1. `bash -n setup.sh` -- no syntax errors
2. `bash -n src/core/progress.sh` -- no syntax errors
3. `rg "show_completion_summary" setup.sh src/core/progress.sh` -- defined in progress.sh, called in setup.sh
4. `rg "SECONDS" setup.sh` -- timer initialized
5. `bash setup.sh --help` -- complete help text with all flags
6. `rg "_SUMMARY_SHOWN" setup.sh` -- guard prevents duplicate summary
</verification>

<success_criteria>
- show_completion_summary() exists in progress.sh with profile, platform, duration, failure count
- setup.sh sources progress.sh and calls show_completion_summary at end
- SECONDS builtin used for duration (no external date math)
- DRY_RUN=true shows "Dry Run Complete" banner
- No duplicate failure summaries on normal exit
- ./setup.sh with no args defaults to developer profile (UX-04 verified)
- All modified files pass bash -n syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/07-user-experience-polish/07-03-SUMMARY.md`
</output>
