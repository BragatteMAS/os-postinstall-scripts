---
phase: 11-flag-boolean-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/logging.sh
  - config.sh
  - setup.sh
  - data/packages/winget.txt
  - .planning/codebase/ARCHITECTURE.md
  - .planning/codebase/CONVENTIONS.md
autonomous: true

must_haves:
  truths:
    - "VERBOSE=false ./setup.sh produces no timestamp prefixes and no debug output"
    - "./setup.sh -y propagates NONINTERACTIVE to all downstream scripts that check it"
    - "UNATTENDED=true ./setup.sh propagates NONINTERACTIVE to all downstream scripts that check it"
    - "winget.txt does not contain kite.kite"
    - "ARCHITECTURE.md error handling section matches ADR-001 (no set -e)"
  artifacts:
    - path: "src/core/logging.sh"
      provides: "Boolean-correct VERBOSE checks"
      contains: '== "true"'
    - path: "config.sh"
      provides: "NONINTERACTIVE bridge from UNATTENDED (env-var path)"
      contains: "NONINTERACTIVE"
    - path: "setup.sh"
      provides: "NONINTERACTIVE export in parse_flags -y branch (flag path)"
      contains: "NONINTERACTIVE"
    - path: "data/packages/winget.txt"
      provides: "Clean winget package list without stale entries"
    - path: ".planning/codebase/ARCHITECTURE.md"
      provides: "Accurate error handling documentation"
    - path: ".planning/codebase/CONVENTIONS.md"
      provides: "Accurate strict mode documentation"
  key_links:
    - from: "setup.sh (parse_flags -y branch)"
      to: "src/core/interactive.sh, src/platforms/linux/install/apt.sh, src/install/ai-tools.sh, src/install/dev-env.sh"
      via: "NONINTERACTIVE exported alongside UNATTENDED in parse_flags, inherited by bash subshells"
      pattern: 'export NONINTERACTIVE=true'
    - from: "config.sh"
      to: "src/core/interactive.sh, src/platforms/linux/install/apt.sh, src/install/ai-tools.sh, src/install/dev-env.sh"
      via: "NONINTERACTIVE bridge from UNATTENDED for env-var invocation path"
      pattern: 'NONINTERACTIVE.*UNATTENDED'
    - from: "src/core/logging.sh"
      to: "config.sh"
      via: "VERBOSE variable checked as string boolean"
      pattern: 'VERBOSE.*== "true"'
---

<objective>
Fix four independent flag/data/doc bugs: VERBOSE boolean semantics, NONINTERACTIVE propagation, stale winget entry, and ARCHITECTURE.md drift.

Purpose: Correct runtime behavior so flags work as documented, remove a discontinued package, and align documentation with ADR-001.
Output: Five files patched with ~16 line changes total. No new files.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/adrs/ADR-001-error-resilience.md

@src/core/logging.sh
@config.sh
@setup.sh
@data/packages/winget.txt
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix VERBOSE boolean checks and NONINTERACTIVE bridge</name>
  <files>src/core/logging.sh, config.sh, setup.sh</files>
  <action>
**FLAG-01 — logging.sh VERBOSE boolean fix (5 locations):**

In `src/core/logging.sh`, the VERBOSE check uses `-n "${VERBOSE:-}"` which evaluates true for any non-empty string including "false". Config.sh defaults VERBOSE to "false", so timestamps/debug always appear. Fix all 5 locations:

1. Line 99 (`log_ok`): Change `if [[ -n "${VERBOSE:-}" ]]` to `if [[ "${VERBOSE:-}" == "true" ]]`
2. Line 113 (`log_error`): Change `if [[ -n "${VERBOSE:-}" ]]` to `if [[ "${VERBOSE:-}" == "true" ]]`
3. Line 127 (`log_warn`): Change `if [[ -n "${VERBOSE:-}" ]]` to `if [[ "${VERBOSE:-}" == "true" ]]`
4. Line 141 (`log_info`): Change `if [[ -n "${VERBOSE:-}" ]]` to `if [[ "${VERBOSE:-}" == "true" ]]`
5. Line 153 (`log_debug`): Change `if [[ -z "${VERBOSE:-}" ]]` to `if [[ "${VERBOSE:-}" != "true" ]]`

**FLAG-02 — NONINTERACTIVE propagation (3 changes across 2 files):**

The NONINTERACTIVE bridge must work for BOTH invocation paths:
- **Env-var path:** `UNATTENDED=true ./setup.sh` — config.sh sources before parse_flags, bridge evaluates correctly
- **Flag path:** `./setup.sh -y` — parse_flags runs AFTER config.sh, so the bridge in config.sh evaluates UNATTENDED=false too early

**Execution order in setup.sh:**
1. Line 34: `source config.sh` — UNATTENDED defaults to "false", bridge would evaluate NONINTERACTIVE=false
2. Line 211: `parse_flags "$@"` — sets `export UNATTENDED=true` but NONINTERACTIVE is already "false"
3. Line 212: `main` → `bash "$linux_main"` — subshell inherits NONINTERACTIVE=false, UNATTENDED=true

**Fix — two-site approach:**

**(a) config.sh — bridge for env-var path (2 changes):**

Add bridge after line 28 (after `UNATTENDED="${UNATTENDED:-false}"`):

```bash
# Bridge: downstream scripts (apt.sh, interactive.sh, etc.) check NONINTERACTIVE
NONINTERACTIVE="${NONINTERACTIVE:-${UNATTENDED}}"
```

Add NONINTERACTIVE to the export line (line 54):

```bash
export DEFAULT_PROFILE DRY_RUN VERBOSE UNATTENDED NONINTERACTIVE
```

This handles `UNATTENDED=true ./setup.sh` — config.sh evaluates bridge with UNATTENDED already set to "true".

**(b) setup.sh — explicit export in parse_flags -y branch (1 change):**

In `setup.sh`, inside `parse_flags()`, add `export NONINTERACTIVE=true` to the `-y|--unattended` branch (after line 82 `export UNATTENDED=true`):

```bash
-y|--unattended)
    export UNATTENDED=true
    export NONINTERACTIVE=true
    shift
    ;;
```

This handles `./setup.sh -y` — parse_flags explicitly sets both variables, so when `bash "$linux_main"` spawns the subshell, NONINTERACTIVE=true is already in the environment.

Both paths now correctly propagate to all 6 callsites that check NONINTERACTIVE (apt.sh:80, apt.sh:125, interactive.sh:40, interactive.sh:70, ai-tools.sh:147, dev-env.sh:39).
  </action>
  <verify>
1. `grep -c '== "true"\|!= "true"' src/core/logging.sh` — returns 5 (4x `== "true"` for timestamp checks + 1x `!= "true"` for log_debug guard)
2. `grep -c '\-n "${VERBOSE\|\-z "${VERBOSE' src/core/logging.sh` — returns 0 (no old -n/-z patterns remain)
3. `grep 'NONINTERACTIVE' config.sh` — shows bridge line and export line (2 occurrences)
4. `grep 'NONINTERACTIVE' setup.sh` — shows `export NONINTERACTIVE=true` inside parse_flags -y branch
5. `grep -rn 'NONINTERACTIVE' src/` — all callsites already use `"${NONINTERACTIVE:-}"`, both paths now ensure they receive "true"
  </verify>
  <done>
VERBOSE=false produces no timestamps in log_ok/error/warn/info and suppresses log_debug entirely. NONINTERACTIVE is set correctly for both invocation paths: env-var (`UNATTENDED=true ./setup.sh`) via config.sh bridge, and flag (`./setup.sh -y`) via explicit export in parse_flags.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove stale winget entry and fix documentation drift</name>
  <files>data/packages/winget.txt, .planning/codebase/ARCHITECTURE.md, .planning/codebase/CONVENTIONS.md</files>
  <action>
**FLAG-03 — Remove kite.kite from winget.txt:**

In `data/packages/winget.txt`, delete line 44 (`kite.kite`). Kite AI shut down November 2022; the package ID is defunct in WinGet. Leave the `# Productivity - Data` comment and the line above it (`UniversityOfWaikato.Weka`) intact. If `kite.kite` is the only entry under a comment section, remove both the comment and the entry to avoid an orphaned section header (check: Weka is under the same `# Productivity - Data` heading, so the heading stays).

**FLAG-04 — Fix ARCHITECTURE.md error handling section:**

In `.planning/codebase/ARCHITECTURE.md`, replace line 75:
```
- `set -euo pipefail` at top of every script
```
with:
```
- No `set -e` or `set -u` (per ADR-001: continue-on-failure strategy)
- `set -o pipefail` only (catches pipe failures without aborting on first error)
```

Also update lines 72-73 to accurately describe the strategy:
```
**Strategy:** Continue on failure with tracking. No set -e anywhere (per ADR-001).
```
(replacing the current "Fail-fast with tracking" which contradicts the actual strategy)

**CONVENTIONS.md — Fix strict mode references (2 locations):**

In `.planning/codebase/CONVENTIONS.md`:

1. Line 31 — Replace `Every script starts with \`set -euo pipefail\`` with `Every script starts with \`set -o pipefail\` (no set -e, per ADR-001)`

2. Lines 37-38 — In the code example under Import Organization, replace `set -euo pipefail` with `set -o pipefail`

3. Lines 62 — Replace `\`set -euo pipefail\` at top of every script` with `\`set -o pipefail\` at top of every script (no set -e, per ADR-001)`
  </action>
  <verify>
1. `grep -n 'kite' data/packages/winget.txt` — returns nothing
2. `grep -n 'set -e' .planning/codebase/ARCHITECTURE.md` — shows "No `set -e`" (negation), not the old claim
3. `grep -n 'set -e' .planning/codebase/CONVENTIONS.md` — shows "no set -e" references, no `set -euo pipefail` remaining
4. `grep 'ADR-001' .planning/codebase/ARCHITECTURE.md` — confirms ADR reference present
  </verify>
  <done>
kite.kite removed from winget.txt. ARCHITECTURE.md and CONVENTIONS.md accurately describe the error handling strategy (no set -e, per ADR-001). Documentation matches actual codebase behavior.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify all four requirements:

1. **FLAG-01**: `grep -c '\-n "${VERBOSE' src/core/logging.sh` returns 0 (no old pattern)
2. **FLAG-01**: `grep -c '"true"' src/core/logging.sh` returns 5 (all checks use string comparison)
3. **FLAG-02**: `grep 'NONINTERACTIVE' config.sh | wc -l` returns 2 (bridge + export)
4. **FLAG-02**: `grep 'NONINTERACTIVE=true' setup.sh | wc -l` returns 1 (parse_flags -y branch)
5. **FLAG-03**: `grep -c 'kite' data/packages/winget.txt` returns 0
6. **FLAG-04**: `grep 'set -euo pipefail' .planning/codebase/ARCHITECTURE.md .planning/codebase/CONVENTIONS.md` returns nothing
</verification>

<success_criteria>
- VERBOSE=false suppresses timestamps in all log functions and silences log_debug
- NONINTERACTIVE bridges from UNATTENDED for both invocation paths (env-var and -y flag)
- winget.txt contains no reference to kite.kite
- ARCHITECTURE.md and CONVENTIONS.md error handling sections reference ADR-001 and describe "no set -e" strategy
</success_criteria>

<output>
After completion, create `.planning/phases/11-flag-boolean-fixes/11-01-SUMMARY.md`
</output>
