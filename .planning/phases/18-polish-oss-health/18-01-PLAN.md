---
phase: 18-polish-oss-health
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/pester/logging.Tests.ps1
  - tests/pester/errors.Tests.ps1
  - tests/pester/packages.Tests.ps1
  - tests/pester/progress.Tests.ps1
autonomous: true

must_haves:
  truths:
    - "Pester tests exist for logging.psm1 with tests for all 6 log levels (OK, ERROR, WARN, INFO, DEBUG, BANNER) -- 7 tests total including DEBUG suppression"
    - "Pester tests exist for errors.psm1 covering Add-FailedItem, Get-FailureCount, Clear-Failures, Get-ExitCode, Show-FailureSummary"
    - "Pester tests exist for packages.psm1 covering Read-PackageFile with comments, blank lines, whitespace, missing files, absolute paths"
    - "Pester tests exist for progress.psm1 covering Show-DryRunBanner, Get-PlatformStepCount, Show-CompletionSummary"
    - "All test files use Pester v5 syntax (Should -Be, Should -Invoke, BeforeAll/BeforeEach)"
    - "Tests use NO_COLOR=1 to simplify Write-Host mock assertions"
  artifacts:
    - path: "tests/pester/logging.Tests.ps1"
      provides: "Unit tests for Write-Log function across all 6 levels (7 tests)"
      min_lines: 50
    - path: "tests/pester/errors.Tests.ps1"
      provides: "Unit tests for failure tracking lifecycle (add, count, clear, exit code, summary)"
      min_lines: 60
    - path: "tests/pester/packages.Tests.ps1"
      provides: "Unit tests for Read-PackageFile with fixture files"
      min_lines: 40
    - path: "tests/pester/progress.Tests.ps1"
      provides: "Unit tests for dry-run banner, step count, completion summary"
      min_lines: 50
  key_links:
    - from: "tests/pester/logging.Tests.ps1"
      to: "src/platforms/windows/core/logging.psm1"
      via: "Import-Module in BeforeAll"
      pattern: "Import-Module.*logging\\.psm1.*-Force"
    - from: "tests/pester/errors.Tests.ps1"
      to: "src/platforms/windows/core/errors.psm1"
      via: "Import-Module in BeforeAll"
      pattern: "Import-Module.*errors\\.psm1.*-Force"
    - from: "tests/pester/packages.Tests.ps1"
      to: "src/platforms/windows/core/packages.psm1"
      via: "Import-Module in BeforeAll"
      pattern: "Import-Module.*packages\\.psm1.*-Force"
    - from: "tests/pester/progress.Tests.ps1"
      to: "src/platforms/windows/core/progress.psm1"
      via: "Import-Module in BeforeAll"
      pattern: "Import-Module.*progress\\.psm1.*-Force"
---

<objective>
Create Pester v5 unit tests for the four PowerShell core modules: logging.psm1, errors.psm1, packages.psm1, and progress.psm1. Target 18-22 tests total mirroring the behavioral contracts from tests/contracts/api-parity.txt.

Purpose: Complete TEST-10 requirement -- PowerShell modules currently have zero unit tests despite Bash equivalents having 42 bats-core tests. This closes the testing gap for the PS side.
Output: Four Pester test files in tests/pester/ directory, structurally valid and ready for execution on a Windows/pwsh environment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-polish-oss-health/18-RESEARCH.md
@tests/contracts/api-parity.txt
@src/platforms/windows/core/logging.psm1
@src/platforms/windows/core/errors.psm1
@src/platforms/windows/core/packages.psm1
@src/platforms/windows/core/progress.psm1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pester tests for logging.psm1 and errors.psm1</name>
  <files>tests/pester/logging.Tests.ps1, tests/pester/errors.Tests.ps1</files>
  <action>
Create `tests/pester/` directory.

**logging.Tests.ps1** (7 tests):
1. BeforeAll: `Import-Module "$PSScriptRoot/../../src/platforms/windows/core/logging.psm1" -Force`
2. BeforeEach: Set `$env:NO_COLOR = '1'` and `$env:VERBOSE = $null`; Mock Write-Host `{}`
3. AfterEach: Clear `$env:NO_COLOR` and `$env:VERBOSE`
4. Tests:
   - "Outputs [OK] tag for OK level" -- call `Write-Log -Level OK -Message 'test'`, assert `Should -Invoke Write-Host -ParameterFilter { $Object -match '\[OK\]' }`
   - "Outputs [ERROR] tag for ERROR level" -- same pattern with ERROR
   - "Outputs [WARN] tag for WARN level" -- same pattern with WARN
   - "Outputs [INFO] tag for INFO level" -- same pattern with INFO
   - "Outputs === border === format for BANNER level" -- call `Write-Log -Level BANNER -Message 'test'`, assert `Should -Invoke Write-Host -ParameterFilter { $Object -match '===' }`. Note: BANNER does NOT use [BANNER] tag format; it outputs `=== Message ===` directly via Write-Host (see logging.psm1 lines 47-54).
   - "Suppresses DEBUG when VERBOSE is not true" -- `$env:VERBOSE = $null`, call DEBUG, assert `Should -Invoke Write-Host -Times 0`
   - "Shows DEBUG when VERBOSE=true" -- `$env:VERBOSE = 'true'`, call DEBUG, assert `Should -Invoke Write-Host -Times 1 -Scope It`

Note: With `NO_COLOR=1`, Write-Log makes a single Write-Host call per log line using format `"[$Level] ${prefix}${Message}"` for standard levels. BANNER is special -- it outputs `"=== $Message ==="` without a level tag. The ParameterFilter should check `$Object -match '\[OK\]'` for standard levels and `$Object -match '==='` for BANNER.

**errors.Tests.ps1** (6 tests):
1. BeforeAll: `Import-Module "$PSScriptRoot/../../src/platforms/windows/core/errors.psm1" -Force`
2. BeforeEach: Call `Clear-Failures`; Mock Write-Host `{}`; Set `$env:FAILURE_LOG = $null` and `$env:NO_COLOR = '1'`
3. AfterEach: Clear `$env:FAILURE_LOG` and `$env:NO_COLOR`
4. Tests:
   - "Add-FailedItem increments failure count" -- add 1 item, assert `Get-FailureCount | Should -Be 1`
   - "Multiple failures increment correctly" -- add 3 items, assert count 3
   - "Clear-Failures resets count to zero" -- add 2 items, clear, assert count 0
   - "Get-ExitCode returns 0 when no failures" -- assert `Get-ExitCode | Should -Be 0`
   - "Get-ExitCode returns 1 when failures exist" -- add 1 item, assert `Get-ExitCode | Should -Be 1`
   - "Show-FailureSummary shows success when no failures" -- call Show-FailureSummary, assert `Should -Invoke Write-Host` was called (via Write-Log internally) -- specifically verify it doesn't error out

Note: errors.psm1 imports logging.psm1 internally via `$PSScriptRoot/logging.psm1`. This resolves correctly because the module files are in their actual location. No need to pre-import logging in the test file.

Note: The `$EXIT_SUCCESS`, `$EXIT_PARTIAL_FAILURE`, `$EXIT_CRITICAL` variables are exported. Optionally add a test confirming their values (0, 1, 2) but this is low priority.
  </action>
  <verify>
Validate file syntax with PowerShell parser (if pwsh available): `pwsh -Command "[System.Management.Automation.Language.Parser]::ParseFile('tests/pester/logging.Tests.ps1', [ref]$null, [ref]$null)"`. If pwsh is not available, verify files are valid by checking: (1) each file contains BeforeAll with Import-Module, (2) each file has Describe/It blocks, (3) each file uses Should assertions. Use grep to confirm structural elements.
  </verify>
  <done>
logging.Tests.ps1 exists with 7 tests covering all 6 log levels (OK, ERROR, WARN, INFO, BANNER, plus DEBUG suppression and DEBUG visibility). errors.Tests.ps1 exists with 6 tests covering the full failure tracking lifecycle. Both files use Pester v5 syntax with BeforeAll/BeforeEach/AfterEach and Mock Write-Host pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Pester tests for packages.psm1 and progress.psm1</name>
  <files>tests/pester/packages.Tests.ps1, tests/pester/progress.Tests.ps1</files>
  <action>
**packages.Tests.ps1** (4 tests):
1. BeforeAll: `Import-Module "$PSScriptRoot/../../src/platforms/windows/core/packages.psm1" -Force`
2. Tests using `$TestDrive` for temp fixture files:
   - "Reads packages from file skipping comments and blanks" -- create temp file with `@('pkg-a', '# comment', '', 'pkg-b', '  pkg-c  ') | Set-Content (Join-Path $TestDrive 'test.txt')`, call `Read-PackageFile -FileName (Join-Path $TestDrive 'test.txt')`, assert count 3 and contains pkg-a, pkg-b, pkg-c
   - "Returns empty array for missing file" -- call `Read-PackageFile -FileName (Join-Path $TestDrive 'nonexistent.txt')`, assert result count 0. Use `-WarningAction SilentlyContinue` to suppress the expected warning.
   - "Trims whitespace from package names" -- create file with `@('  spaced  ', '	tabbed	') | Set-Content`, assert trimmed values
   - "Handles file with only comments and blanks" -- create file with `@('# only comment', '', '  ') | Set-Content`, assert count 0

Note: Always pass absolute paths (via `$TestDrive`) to bypass relative path resolution. The module handles absolute paths correctly (line 39-40 checks `IsPathRooted`).

Note: Read-PackageFile uses `,` operator on return for array preservation. When the result is a single item, PowerShell would normally unwrap. The `,` prevents this. Tests should work correctly regardless -- `@($result).Count` is a safe way to count if needed.

**progress.Tests.ps1** (5 tests):
1. BeforeAll: `Import-Module "$PSScriptRoot/../../src/platforms/windows/core/progress.psm1" -Force`
2. BeforeEach: Set `$env:DRY_RUN = $null`, `$env:FAILURE_LOG = $null`, `$env:NO_COLOR = '1'`; Mock Write-Host `{}`
3. AfterEach: Clear `$env:DRY_RUN`, `$env:FAILURE_LOG`, `$env:NO_COLOR`
4. Tests:
   - "Show-DryRunBanner is no-op when DRY_RUN is not true" -- `$env:DRY_RUN = $null`, call Show-DryRunBanner, assert `Should -Invoke Write-Host -Times 0`
   - "Show-DryRunBanner displays banner when DRY_RUN=true" -- `$env:DRY_RUN = 'true'`, call Show-DryRunBanner, assert `Should -Invoke Write-Host -Times 3 -Scope It` (3 lines: border, message, border -- each Write-Log call results in 1 Write-Host call with NO_COLOR=1)
   - "Get-PlatformStepCount returns 0 for missing file" -- call with nonexistent path, assert result 0
   - "Get-PlatformStepCount counts Windows-relevant entries" -- create temp profile with `@('winget.txt', 'apt.txt', 'cargo.txt', 'npm.txt', '# comment', '', 'ai-tools.txt', 'brew.txt') | Set-Content (Join-Path $TestDrive 'test-profile.txt')`, call `Get-PlatformStepCount -ProfileFile (Join-Path $TestDrive 'test-profile.txt')`, assert result 4 (winget + cargo + npm + ai-tools)
   - "Show-CompletionSummary shows success with no failures" -- `$env:FAILURE_LOG = (Join-Path $TestDrive 'empty-failures.log')`, do NOT create the file (so no failures), call `Show-CompletionSummary -Profile 'test' -Platform 'Test' -StartTime (Get-Date).AddSeconds(-5)`, assert Write-Host was invoked (at least 4 times for banner + profile + platform + duration + success line)

Note: Show-DryRunBanner calls Write-Log 3 times, and with NO_COLOR=1 each Write-Log call makes exactly 1 Write-Host call. So the assertion is `-Times 3`.

Note: progress.psm1 imports logging.psm1 internally. The import resolves correctly from the real file location.
  </action>
  <verify>
Same syntax validation as Task 1. Also verify total test count across all 4 files: grep for 'It ' in tests/pester/*.Tests.ps1 and confirm 18-22 tests total.
  </verify>
  <done>
packages.Tests.ps1 exists with 4 tests covering comment filtering, missing files, whitespace trimming, and empty files. progress.Tests.ps1 exists with 5 tests covering dry-run banner toggle, step counting, and completion summary. Total across all 4 test files: 22 tests (7+6+4+5).
  </done>
</task>

</tasks>

<verification>
1. Directory `tests/pester/` exists with exactly 4 `.Tests.ps1` files
2. Each file has `BeforeAll` with `Import-Module ... -Force`
3. Each file uses Pester v5 syntax (`Should -Be`, `Should -Invoke`, `Describe`, `It`)
4. Total test count (grep 'It ' across files) is 18-22
5. No InModuleScope usage (all functions are exported)
6. No hardcoded paths (uses $PSScriptRoot relative paths and $TestDrive)
7. If pwsh is available: `Invoke-Pester tests/pester/*.Tests.ps1` exits 0
8. If pwsh is not available: structural validation via grep confirms all elements present
</verification>

<success_criteria>
- 4 Pester test files exist in tests/pester/
- 22 total tests across all files (7 logging + 6 errors + 4 packages + 5 progress)
- All tests mirror behavioral contracts from tests/contracts/api-parity.txt
- BANNER level has dedicated test asserting === border === format
- Files use Pester v5 patterns: BeforeAll Import-Module -Force, Mock Write-Host, Should -Invoke
- Environment isolation: BeforeEach sets env vars, AfterEach clears them
- errors.Tests.ps1 calls Clear-Failures in BeforeEach to prevent state leakage
</success_criteria>

<output>
After completion, create `.planning/phases/18-polish-oss-health/18-01-SUMMARY.md`
</output>
