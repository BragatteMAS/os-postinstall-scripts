---
phase: 08.2-audit-remediation
plan: 02
subsystem: infra
tags: [exit-code, failure-tracking, orchestrator, homebrew, powershell, cross-process]

# Dependency graph
requires:
  - phase: 01-core-infrastructure
    provides: errors.sh record_failure() and FAILURE_LOG pattern
  - phase: 04-macos-platform
    provides: homebrew.sh installer and macOS main.sh orchestrator
  - phase: 05-linux-enhancements
    provides: Linux main.sh orchestrator
  - phase: 06-windows-foundation
    provides: errors.psm1 and setup.ps1
provides:
  - Exit code propagation for hard prerequisite failures (homebrew.sh)
  - Cross-process failure aggregation in macOS/Linux orchestrators via FAILURE_LOG
  - PowerShell cross-process failure tracking via $env:FAILURE_LOG file
  - Complete Windows FAILURE_LOG lifecycle (create, write, read, cleanup)
affects: []

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Hard prerequisite exit 1 exception to always-exit-0 rule"
    - "FAILURE_LOG cross-process aggregation in orchestrator cleanup"
    - "PowerShell $env:FAILURE_LOG file-based cross-process tracking"

key-files:
  created: []
  modified:
    - src/platforms/macos/install/homebrew.sh
    - src/platforms/macos/main.sh
    - src/platforms/linux/main.sh
    - src/platforms/windows/core/errors.psm1
    - setup.ps1

key-decisions:
  - "homebrew.sh exits 1 on failure (exception to always-exit-0 for hard prerequisites)"
  - "FAILURE_LOG write in homebrew.sh guarded by [[ -n FAILURE_LOG ]]"
  - "Orchestrator cleanup reads FAILURE_LOG only if file exists and is non-empty"
  - "PS Add-FailedItem writes to FAILURE_LOG with Split-Path parent dir check"
  - "setup.ps1 creates FAILURE_LOG using $PID for unique temp file name"

patterns-established:
  - "Hard prerequisite exit pattern: exit 1 + FAILURE_LOG write for must-have dependencies"
  - "Orchestrator FAILURE_LOG aggregation: cleanup() reads shared log and reports child failures"
  - "PS FAILURE_LOG lifecycle: setup.ps1 creates -> errors.psm1 writes -> setup.ps1 reads + removes"

# Metrics
duration: 1min
completed: 2026-02-08
---

# Phase 8.2 Plan 02: Homebrew Exit Code and Failure Aggregation Summary

**homebrew.sh exit 1 on failure with FAILURE_LOG write, plus cross-process failure aggregation in all three platform orchestrators**

## Performance

- **Duration:** 1 min
- **Started:** 2026-02-08T21:14:27Z
- **Completed:** 2026-02-08T21:15:51Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- homebrew.sh now exits 1 on Homebrew install failure (exception to always-exit-0 for hard prerequisites)
- macOS and Linux orchestrators aggregate child process failures via FAILURE_LOG in cleanup
- PowerShell Add-FailedItem writes to $env:FAILURE_LOG for cross-process tracking
- setup.ps1 has complete FAILURE_LOG lifecycle: create temp file, read at exit, clean up

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix homebrew.sh exit code propagation** - `02fb990` (fix)
2. **Task 2: Add failure aggregation to orchestrator cleanup functions** - `9f7f7a6` (feat)

**Plan metadata:** (pending) (docs: complete plan)

## Files Created/Modified
- `src/platforms/macos/install/homebrew.sh` - Exit 1 on failure + FAILURE_LOG write
- `src/platforms/macos/main.sh` - Cleanup reads FAILURE_LOG and reports child failures
- `src/platforms/linux/main.sh` - Cleanup reads FAILURE_LOG and reports child failures
- `src/platforms/windows/core/errors.psm1` - Add-FailedItem writes to $env:FAILURE_LOG file
- `setup.ps1` - FAILURE_LOG lifecycle: create, read at exit, remove temp file

## Decisions Made
- homebrew.sh exit 1 is the ONLY exception to always-exit-0 rule because Homebrew is a hard prerequisite for all macOS installs
- FAILURE_LOG write in homebrew.sh is guarded by `[[ -n "${FAILURE_LOG:-}" ]]` for standalone execution safety
- Orchestrator cleanup checks `-f` and `-s` (exists and non-empty) before reading FAILURE_LOG
- PowerShell Add-FailedItem uses `Split-Path` to verify parent directory exists before writing
- setup.ps1 uses `$PID` in temp filename for uniqueness across concurrent runs

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- FAILURE_LOG pattern now works end-to-end across all three platforms
- macOS main.sh `bash homebrew.sh || return 1` check now actually triggers on failure
- Ready for remaining audit remediation plans

---
*Phase: 08.2-audit-remediation*
*Completed: 2026-02-08*
