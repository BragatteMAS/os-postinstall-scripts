---
phase: 08.2-audit-remediation
plan: 04
type: execute
wave: 2
depends_on: [08.2-02, 08.2-03]
files_modified:
  - tests/test-macos.sh
  - tests/test-windows.ps1
autonomous: true

must_haves:
  truths:
    - "test-macos.sh validates syntax and content patterns for all macOS scripts"
    - "test-windows.ps1 validates file existence and content patterns for all Windows scripts"
    - "test-macos.sh checks for FAILURE_LOG in macOS orchestrator (added in Plan 02)"
    - "test-windows.ps1 checks for FAILURE_LOG in errors.psm1 (added in Plan 02)"
    - "test-macos.sh checks for exit 1 in homebrew.sh (added in Plan 02)"
  artifacts:
    - path: "tests/test-macos.sh"
      provides: "macOS platform static test suite"
      contains: "assert_pass"
    - path: "tests/test-windows.ps1"
      provides: "Windows platform static test suite"
      contains: "Assert-Pass"
  key_links:
    - from: "tests/test-macos.sh"
      to: "src/platforms/macos/"
      via: "bash -n syntax checks and grep content checks"
      pattern: "bash -n src/platforms/macos"
    - from: "tests/test-windows.ps1"
      to: "src/platforms/windows/"
      via: "Test-Path and Select-String content checks"
      pattern: "Test-Path.*src/platforms/windows"
---

<objective>
Create static test suites for macOS and Windows platforms.

Purpose: The codebase has test-linux.sh (24 tests) and test-dotfiles.sh but no equivalent for macOS or Windows. Test suites follow the established assert_pass/assert_fail pattern from test-linux.sh.
Output: test-macos.sh and test-windows.ps1 in tests/ directory
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/test-linux.sh
@src/platforms/macos/install/homebrew.sh
@src/platforms/macos/install/brew.sh
@src/platforms/macos/install/brew-cask.sh
@src/platforms/macos/main.sh
@src/platforms/windows/main.ps1
@src/platforms/windows/core/logging.psm1
@src/platforms/windows/core/packages.psm1
@src/platforms/windows/core/errors.psm1
@src/platforms/windows/install/winget.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test-macos.sh static test suite</name>
  <files>tests/test-macos.sh</files>
  <action>
Create `tests/test-macos.sh` following the exact pattern from `tests/test-linux.sh`.

Structure:
1. Same header comment block (Script: test-macos.sh, Description: Tests for macOS platform scripts)
2. Same test runner setup (TESTS_PASSED, TESTS_FAILED, TESTS_TOTAL, assert_pass, assert_fail functions) -- copy verbatim from test-linux.sh lines 11-38
3. Banner: "macOS Platform Tests"

**Syntax checks** (bash -n):
- `src/platforms/macos/install/homebrew.sh`
- `src/platforms/macos/install/brew.sh`
- `src/platforms/macos/install/brew-cask.sh`
- `src/platforms/macos/main.sh`

**Content checks** (grep -q):
- `MACOS_DIR` used in main.sh (not SCRIPT_DIR)
- `get_brew_prefix` in homebrew.sh (architecture detection)
- `is_brew_installed` in brew.sh (idempotent check)
- `_is_cask_installed` in brew-cask.sh (cask-specific check)
- `DRY_RUN` guard in homebrew.sh
- `FAILURE_LOG` in homebrew.sh (exit code fix from Plan 02)
- `exit 1` in homebrew.sh (hard prerequisite exception from Plan 02)
- `FAILURE_LOG` in main.sh (failure aggregation from Plan 02)
- `show_dry_run_banner` in main.sh (DRY_RUN banner)

**Anti-pattern checks** (assert_fail):
- No `set -e` in homebrew.sh
- No `set -e` in brew.sh
- No `SCRIPT_DIR=` assignment at start of main.sh (should use MACOS_DIR)

**Summary section** (same format as test-linux.sh):
```
echo "========================================="
echo "Results: $TESTS_PASSED passed, $TESTS_FAILED failed, $TESTS_TOTAL total"
echo "========================================="
[[ $TESTS_FAILED -eq 0 ]] && exit 0 || exit 1
```

Make the file executable: `chmod +x tests/test-macos.sh`

Total: approximately 16-20 tests.
  </action>
  <verify>
Run: `bash -n tests/test-macos.sh` (syntax valid)
Run: `bash tests/test-macos.sh` (all tests should pass)
Run: `grep -c "assert_pass\|assert_fail" tests/test-macos.sh` (should be >= 15)
  </verify>
  <done>test-macos.sh exists with 15+ static tests covering syntax, content patterns, and anti-patterns for all macOS scripts. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create test-windows.ps1 static test suite</name>
  <files>tests/test-windows.ps1</files>
  <action>
Create `tests/test-windows.ps1` following the PowerShell test pattern from the research document.

Structure:
1. `#Requires -Version 5.1` header
2. Comment block (Script: test-windows.ps1, Description: Tests for Windows platform scripts)
3. Test runner setup ($Passed, $Failed, $Total variables)
4. Helper functions: Assert-Pass, Assert-Contains, Assert-NotContains (from research Example 2)
5. Banner: "Windows Platform Tests"

**Assert-Pass helper:**
```powershell
function Assert-Pass {
    param([string]$Name, [scriptblock]$Test)
    $script:Total++
    try {
        $null = & $Test 2>$null
        $script:Passed++
        Write-Host "[PASS] $Name"
    } catch {
        $script:Failed++
        Write-Host "[FAIL] $Name"
    }
}
```

**Assert-Contains helper:**
```powershell
function Assert-Contains {
    param([string]$Name, [string]$Path, [string]$Pattern)
    $script:Total++
    if (Select-String -Path $Path -Pattern $Pattern -Quiet) {
        $script:Passed++
        Write-Host "[PASS] $Name"
    } else {
        $script:Failed++
        Write-Host "[FAIL] $Name"
    }
}
```

**Assert-NotContains helper:**
```powershell
function Assert-NotContains {
    param([string]$Name, [string]$Path, [string]$Pattern)
    $script:Total++
    if (-not (Select-String -Path $Path -Pattern $Pattern -Quiet)) {
        $script:Passed++
        Write-Host "[PASS] $Name"
    } else {
        $script:Failed++
        Write-Host "[FAIL] $Name"
    }
}
```

**File existence checks** (Assert-Pass with Test-Path):
- `src/platforms/windows/main.ps1`
- `src/platforms/windows/install/winget.ps1`
- `src/platforms/windows/core/logging.psm1`
- `src/platforms/windows/core/packages.psm1`
- `src/platforms/windows/core/errors.psm1`
- `setup.ps1`

**Content checks** (Assert-Contains):
- `Write-Log` in main.ps1 (logging used)
- `winget list` in winget.ps1 (idempotent check)
- `ErrorActionPreference` in main.ps1 (error handling)
- `Export-ModuleMember` in errors.psm1 (proper module export)
- `NO_COLOR` in logging.psm1 (CI compat)
- `FAILURE_LOG` in errors.psm1 (cross-process tracking write from Plan 02)
- `FAILURE_LOG` in setup.ps1 (cross-process tracking lifecycle from Plan 02)
- `WARN` in main.ps1 (cross-platform dispatch warnings from Plan 03)
- `cargo.txt` in main.ps1 (explicit handling from Plan 03)
- `Requires -Version 5.1` in main.ps1 (version guard)

**Anti-pattern checks** (Assert-NotContains):
- No `Write-Error` in logging.psm1 (uses Write-Log, not Write-Error)
- No `$ErrorActionPreference = 'Stop'` in main.ps1 (should be Continue)

**Summary section:**
```powershell
Write-Host "========================================="
Write-Host "Results: $Passed passed, $Failed failed, $Total total"
Write-Host "========================================="
if ($Failed -eq 0) { exit 0 } else { exit 1 }
```

Total: approximately 17-20 tests.

NOTE: This test file can be run on any platform since it only checks file existence and content patterns (no Windows-specific runtime). The Select-String cmdlet is available in PowerShell Core on macOS/Linux too.
  </action>
  <verify>
Run: `test -f tests/test-windows.ps1 && echo "EXISTS" || echo "MISSING"`
Run: `grep -c "Assert-Pass\|Assert-Contains\|Assert-NotContains" tests/test-windows.ps1` (should be >= 15)
If PowerShell is available: `pwsh tests/test-windows.ps1` (all tests should pass)
  </verify>
  <done>test-windows.ps1 exists with 15+ static tests covering file existence, content patterns, and anti-patterns for all Windows scripts. Tests validate Plan 02 and Plan 03 changes.</done>
</task>

</tasks>

<verification>
1. `bash -n tests/test-macos.sh` passes
2. `bash tests/test-macos.sh` passes (all tests green)
3. `test -f tests/test-windows.ps1` passes
4. If pwsh available: `pwsh tests/test-windows.ps1` passes (all tests green)
5. `grep -c "assert_pass\|assert_fail" tests/test-macos.sh` >= 15
6. `grep -c "Assert-Pass\|Assert-Contains\|Assert-NotContains" tests/test-windows.ps1` >= 15
</verification>

<success_criteria>
- test-macos.sh validates all macOS platform scripts (syntax + content + anti-patterns)
- test-windows.ps1 validates all Windows platform scripts (existence + content + anti-patterns)
- Both test suites validate changes from Plans 02 and 03
- test-macos.sh passes when run from project root
</success_criteria>

<output>
After completion, create `.planning/phases/08.2-audit-remediation/08.2-04-SUMMARY.md`
</output>
