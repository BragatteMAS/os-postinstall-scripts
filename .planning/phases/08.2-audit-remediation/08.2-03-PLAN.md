---
phase: 08.2-audit-remediation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - examples/terminal-setup.sh
  - src/platforms/windows/main.ps1
autonomous: true

must_haves:
  truths:
    - "terminal-setup.sh curl|sh pipelines are guarded by DRY_RUN check"
    - "Windows main.ps1 logs WARN for cargo.txt, npm.txt, and ai-tools.txt instead of silent skip"
  artifacts:
    - path: "examples/terminal-setup.sh"
      provides: "Dry-run safe curl|sh calls"
      contains: "DRY_RUN"
    - path: "src/platforms/windows/main.ps1"
      provides: "WARN logging for unimplemented cross-platform dispatchers"
      contains: "WARN"
  key_links:
    - from: "examples/terminal-setup.sh"
      to: "DRY_RUN variable"
      via: "conditional check before curl|sh pipeline"
      pattern: "DRY_RUN.*curl"
---

<objective>
Fix terminal-setup.sh dry-run bypass for curl|sh pipelines and add WARN logging to Windows main.ps1 for cross-platform package files.

Purpose: Two curl|sh calls in terminal-setup.sh bypass dry-run mode because `run()` only guards the left side of the pipe. Windows main.ps1 silently skips cargo.txt, npm.txt, and ai-tools.txt when they appear in profiles, making the gap invisible.
Output: Safe dry-run behavior in terminal-setup.sh, visible WARN logging in Windows main.ps1
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@examples/terminal-setup.sh
@src/platforms/windows/main.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix terminal-setup.sh dry-run bypass for curl|sh</name>
  <files>examples/terminal-setup.sh</files>
  <action>
Fix the two `curl | sh` pipelines in `examples/terminal-setup.sh` that bypass DRY_RUN mode.

**Problem:** `run()` only guards the left side of a pipe. In dry-run, `run curl ... | sh` suppresses curl but `sh` still executes (on empty input).

**Fix line 181** (zoxide install):
Replace:
```bash
            run curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
```
With:
```bash
            if [[ "${DRY_RUN:-}" == "true" ]]; then
                log_dry "install zoxide via curl|sh"
            else
                curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
            fi
```

**Fix line 188** (starship install):
Replace:
```bash
            run curl -sS https://starship.rs/install.sh | sh -s -- -y
```
With:
```bash
            if [[ "${DRY_RUN:-}" == "true" ]]; then
                log_dry "install starship via curl|sh"
            else
                curl -sS https://starship.rs/install.sh | sh -s -- -y
            fi
```

`log_dry` is already defined at line 47 of terminal-setup.sh:
```bash
log_dry()   { echo -e "${YELLOW}[DRY]${NC}  Would: $*"; }
```
Use it directly. No new function needed.

Do NOT change any other lines. Only the two `curl | sh` pipelines need fixing.
  </action>
  <verify>
Run: `bash -n examples/terminal-setup.sh` (syntax valid)
Run: `grep -c "DRY_RUN" examples/terminal-setup.sh` (should increase by at least 2)
Verify: Neither of the two `run curl ... | sh` patterns remain (they should be replaced)
Run: `grep -c "run curl.*|.*sh" examples/terminal-setup.sh` (should return 0)
  </verify>
  <done>Both curl|sh pipelines are guarded by DRY_RUN check. Dry-run mode no longer executes shell pipelines.</done>
</task>

<task type="auto">
  <name>Task 2: Add WARN logging for cross-platform files in Windows main.ps1</name>
  <files>src/platforms/windows/main.ps1</files>
  <action>
Expand the `switch ($pkgFile)` block in `Install-Profile` function (lines 74-84) to explicitly handle cargo.txt, npm.txt, and ai-tools.txt with WARN-level logging instead of falling through to the silent DEBUG default case.

Replace the switch block:
```powershell
        switch ($pkgFile) {
            'winget.txt' {
                Write-Log -Level INFO -Message 'Installing WinGet packages...'
                & "$WindowsDir/install/winget.ps1"
            }
            default {
                # Non-Windows package files (apt.txt, brew.txt, etc.): skip silently
                Write-Log -Level DEBUG -Message "Skipping $pkgFile (not a Windows package file)"
            }
        }
```

With:
```powershell
        switch ($pkgFile) {
            'winget.txt' {
                Write-Log -Level INFO -Message 'Installing WinGet packages...'
                & "$WindowsDir/install/winget.ps1"
            }
            'cargo.txt' {
                Write-Log -Level WARN -Message 'cargo.txt: Windows Cargo installer not yet implemented (skipping)'
            }
            'npm.txt' {
                Write-Log -Level WARN -Message 'npm.txt: Windows npm installer not yet implemented (skipping)'
            }
            'ai-tools.txt' {
                Write-Log -Level WARN -Message 'ai-tools.txt: Windows AI tools installer not yet implemented (skipping)'
            }
            default {
                # Non-Windows package files (apt.txt, brew.txt, etc.): skip silently
                Write-Log -Level DEBUG -Message "Skipping $pkgFile (not a Windows package file)"
            }
        }
```

The WARN level makes these gaps visible to users. The default case still handles truly unrelated files (apt.txt, brew.txt, etc.) with DEBUG.

Do NOT create PowerShell installer scripts for cargo/npm/ai-tools. This is WARN logging only -- the explicit user decision.
  </action>
  <verify>
Run: `grep -c "WARN" src/platforms/windows/main.ps1` (should return >= 3)
Run: `grep -q "cargo.txt" src/platforms/windows/main.ps1` (cargo.txt case exists)
Run: `grep -q "npm.txt" src/platforms/windows/main.ps1` (npm.txt case exists)
Run: `grep -q "ai-tools.txt" src/platforms/windows/main.ps1` (ai-tools.txt case exists)
  </verify>
  <done>Windows main.ps1 logs WARN for cargo.txt, npm.txt, and ai-tools.txt. Non-Windows files (apt.txt, brew.txt) still DEBUG-skipped.</done>
</task>

</tasks>

<verification>
1. `bash -n examples/terminal-setup.sh` passes
2. `grep -c "run curl.*|.*sh" examples/terminal-setup.sh` returns 0 (no unguarded curl|sh)
3. `grep -c "WARN" src/platforms/windows/main.ps1` >= 3
4. `grep -q "cargo.txt" src/platforms/windows/main.ps1` passes
5. `grep -q "npm.txt" src/platforms/windows/main.ps1` passes
6. `grep -q "ai-tools.txt" src/platforms/windows/main.ps1` passes
</verification>

<success_criteria>
- terminal-setup.sh dry-run mode skips curl|sh pipelines entirely
- Windows main.ps1 WARN-logs for cargo.txt, npm.txt, ai-tools.txt (not silent skip)
- Both files pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/08.2-audit-remediation/08.2-03-SUMMARY.md`
</output>
