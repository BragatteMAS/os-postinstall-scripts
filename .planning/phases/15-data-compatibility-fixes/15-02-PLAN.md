---
phase: 15-data-compatibility-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/platform.sh
  - src/platforms/linux/main.sh
  - src/platforms/macos/main.sh
  - src/platforms/linux/install/apt.sh
  - src/platforms/linux/install/flatpak.sh
  - src/platforms/linux/install/snap.sh
  - src/platforms/linux/install/cargo.sh
  - src/platforms/macos/install/homebrew.sh
  - src/platforms/macos/install/brew.sh
  - src/platforms/macos/install/brew-cask.sh
  - src/install/dev-env.sh
  - src/install/rust-cli.sh
  - src/install/ai-tools.sh
  - setup.ps1
  - src/platforms/windows/main.ps1
  - src/platforms/windows/core/idempotent.psm1
  - data/packages/brew.txt
autonomous: true

must_haves:
  truths:
    - "verify_bash_version() warns but does NOT block on macOS with Bash 3.2"
    - "set -o pipefail present in all 12 scripts executed as subshell"
    - "PS -Profile parameter uses ValidateSet in setup.ps1 and main.ps1"
    - "Test-CargoInstalled is multiline-safe in idempotent.psm1"
    - "node removed from brew.txt (conflicts with fnm)"
    - "fzf added to brew.txt"
  artifacts:
    - path: "src/core/platform.sh"
      provides: "verify_bash_version() with macOS warn-not-block"
      contains: "return 0"
    - path: "setup.ps1"
      provides: "ValidateSet for -Profile parameter"
      contains: "ValidateSet"
    - path: "src/platforms/windows/main.ps1"
      provides: "ValidateSet for -Profile parameter (includes empty string for interactive)"
      contains: "ValidateSet"
    - path: "src/platforms/windows/core/idempotent.psm1"
      provides: "Multiline-safe Test-CargoInstalled function"
      contains: "-join"
    - path: "data/packages/brew.txt"
      provides: "Corrected brew formula list"
      contains: "fzf"
  key_links:
    - from: "src/core/platform.sh"
      to: "setup.sh"
      via: "verify_all() calls verify_bash_version()"
      pattern: "verify_bash_version"
    - from: "setup.ps1"
      to: "src/platforms/windows/main.ps1"
      via: "setup.ps1 dispatches to main.ps1 with -Profile"
      pattern: "Profile"
    - from: "data/packages/brew.txt"
      to: "src/platforms/macos/install/brew.sh"
      via: "load_packages reads brew.txt"
      pattern: "brew.txt"
---

<objective>
Fix Bash 3.2 chicken-and-egg on macOS, add pipefail to all subshell scripts, and apply convergent quality fixes to PowerShell and brew data.

Purpose: (1) macOS ships Bash 3.2 but verify_bash_version() blocks setup.sh before Homebrew can install Bash 5.x -- fix to warn-not-block since the codebase uses zero Bash 4+ features. (2) CONVENTIONS.md mandates `set -o pipefail` in every script but only setup.sh has it -- subshell scripts do not inherit parent shell options. (3) PS parameter validation and brew.txt corrections are low-risk convergent fixes.

Output: 17 files updated with compatibility and quality improvements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-data-compatibility-fixes/15-RESEARCH.md
@src/core/platform.sh
@setup.ps1
@src/platforms/windows/main.ps1
@src/platforms/windows/core/idempotent.psm1
@data/packages/brew.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix verify_bash_version() macOS warn-not-block and add pipefail to all subshell scripts</name>
  <files>
    src/core/platform.sh
    src/platforms/linux/main.sh
    src/platforms/macos/main.sh
    src/platforms/linux/install/apt.sh
    src/platforms/linux/install/flatpak.sh
    src/platforms/linux/install/snap.sh
    src/platforms/linux/install/cargo.sh
    src/platforms/macos/install/homebrew.sh
    src/platforms/macos/install/brew.sh
    src/platforms/macos/install/brew-cask.sh
    src/install/dev-env.sh
    src/install/rust-cli.sh
    src/install/ai-tools.sh
  </files>
  <action>
**COMPAT-01: verify_bash_version() warn-not-block on macOS**

In `src/core/platform.sh`, modify `verify_bash_version()` (lines 115-136). Insert a macOS-specific branch BEFORE the existing `log_error` call. When `DETECTED_OS == "macos"` and Bash < 4, log a warning and return 0 instead of 1.

Replace the entire `if [[ "$major" -lt 4 ]]; then` block with:

```bash
if [[ "$major" -lt 4 ]]; then
    if [[ "${DETECTED_OS:-}" == "macos" ]]; then
        log_warn "Bash ${DETECTED_BASH} detected (version 4.0+ recommended)"
        log_warn "Homebrew will install Bash 5.x. Upgrade after setup:"
        echo "  brew install bash"
        echo "  sudo sh -c 'echo /opt/homebrew/bin/bash >> /etc/shells'"
        echo "  chsh -s /opt/homebrew/bin/bash"
        return 0
    fi
    log_error "Bash version $DETECTED_BASH is too old. Version 4.0+ is required."
    echo ""
    echo "Upgrade instructions:"
    if [[ "${DETECTED_OS:-}" == "linux" ]]; then
        echo "  sudo apt update && sudo apt install bash"
    else
        echo "  Please upgrade Bash to version 4.0 or later"
    fi
    echo ""
    return 1
fi
```

Also update the function's header comment from "Exits with instructions if Bash version < 4.0" to "Warns on macOS if Bash < 4.0, blocks on other platforms".

Use `${DETECTED_OS:-}` with empty-string fallback (not bare `$DETECTED_OS`) for the macOS check to be safe if called before detect_platform. Note: `verify_all()` already calls `detect_platform` first, so DETECTED_OS is always set in normal flow, but the defensive pattern is correct.

**QUAL-01: Add `set -o pipefail` to 12 subshell scripts**

Add `set -o pipefail` as line 2 (immediately after the `#!/usr/bin/env bash` shebang) to each of these 12 files:

1. `src/platforms/linux/main.sh`
2. `src/platforms/macos/main.sh`
3. `src/platforms/linux/install/apt.sh`
4. `src/platforms/linux/install/flatpak.sh`
5. `src/platforms/linux/install/snap.sh`
6. `src/platforms/linux/install/cargo.sh`
7. `src/platforms/macos/install/homebrew.sh`
8. `src/platforms/macos/install/brew.sh`
9. `src/platforms/macos/install/brew-cask.sh`
10. `src/install/dev-env.sh`
11. `src/install/rust-cli.sh`
12. `src/install/ai-tools.sh`

Do NOT touch:
- `setup.sh` (already has pipefail on line 27)
- `tools/lint.sh` (uses stricter `set -euo pipefail` intentionally)
- `src/platforms/linux/post_install.sh` (deprecated stub)
- `src/core/*.sh` files (sourced, not subshells)
- `src/install/fnm.sh`, `src/install/uv.sh` (primarily sourced)
- `config.sh` (sourced)
- `tests/*.sh` (test harnesses, out of scope)

Placement: After shebang, before the `#######################################` header comment block.

`set -o pipefail` is available since Bash 3.0 -- safe on all targets including macOS Bash 3.2.
  </action>
  <verify>
```bash
# COMPAT-01: verify_bash_version contains macOS warn path
grep -A3 'DETECTED_OS.*macos' src/core/platform.sh | grep 'return 0'

# QUAL-01: All 12 subshell scripts have pipefail
for f in src/platforms/linux/main.sh src/platforms/macos/main.sh \
         src/platforms/linux/install/apt.sh src/platforms/linux/install/flatpak.sh \
         src/platforms/linux/install/snap.sh src/platforms/linux/install/cargo.sh \
         src/platforms/macos/install/homebrew.sh src/platforms/macos/install/brew.sh \
         src/platforms/macos/install/brew-cask.sh \
         src/install/dev-env.sh src/install/rust-cli.sh src/install/ai-tools.sh; do
    head -3 "$f" | grep -q 'set -o pipefail' || echo "MISSING: $f"
done
# Expected: no output (all present)
```
  </verify>
  <done>verify_bash_version() returns 0 with log_warn on macOS when Bash < 4. All 12 subshell scripts have `set -o pipefail` on line 2.</done>
</task>

<task type="auto">
  <name>Task 2: Apply PowerShell ValidateSet, multiline-safe cargo check, and brew.txt corrections</name>
  <files>
    setup.ps1
    src/platforms/windows/main.ps1
    src/platforms/windows/core/idempotent.psm1
    data/packages/brew.txt
  </files>
  <action>
**QUAL-02a: ValidateSet for -Profile parameter**

In `setup.ps1`, change line 20 from:
```powershell
[string]$Profile = 'developer',
```
to:
```powershell
[ValidateSet('minimal', 'developer', 'full')]
[string]$Profile = 'developer',
```

In `src/platforms/windows/main.ps1`, change line 14 from:
```powershell
[string]$Profile = ''
```
to:
```powershell
[ValidateSet('', 'minimal', 'developer', 'full')]
[string]$Profile = ''
```

Note: main.ps1 includes empty string `''` in the ValidateSet because `$Profile = ''` is the "no profile = show interactive menu" signal. Omitting it would break interactive mode.

**QUAL-02b: Test-CargoInstalled multiline-safe**

In `src/platforms/windows/core/idempotent.psm1`, replace the body of `Test-CargoInstalled` (lines 69-72) from:
```powershell
$output = cargo install --list 2>$null
if ($output -match "^$([regex]::Escape($PackageName)) ") {
    return $true
}
```
to:
```powershell
$output = (cargo install --list 2>$null) -join "`n"
if ($output -match "(?m)^$([regex]::Escape($PackageName)) ") {
    return $true
}
```

This joins the multiline array output into a single string and uses `(?m)` multiline regex flag so `^` anchors correctly at each line start.

**QUAL-02c: Remove `node` from brew.txt**

In `data/packages/brew.txt`, remove the line `node` (line 35 under "Development - Languages") and add a comment explaining why:
```
# node  -- managed by fnm (src/install/fnm.sh), Homebrew node conflicts with fnm
```

**QUAL-02d: Add `fzf` to brew.txt**

In `data/packages/brew.txt`, add `fzf` under a new section after "Terminal - Rust Tools" and before "# Dotfiles Manager". Use a dedicated section since fzf is written in Go, not Rust:
```
# Terminal - Fuzzy Finder
fzf
```
  </action>
  <verify>
```bash
# QUAL-02a: ValidateSet present in both PS files
grep 'ValidateSet' setup.ps1
grep 'ValidateSet' src/platforms/windows/main.ps1

# QUAL-02b: multiline-safe join in Test-CargoInstalled
grep '\-join' src/platforms/windows/core/idempotent.psm1

# QUAL-02c: node removed from brew.txt
grep '^node$' data/packages/brew.txt | wc -l  # Expected: 0

# QUAL-02d: fzf added to brew.txt
grep '^fzf$' data/packages/brew.txt  # Expected: match
```
  </verify>
  <done>setup.ps1 and main.ps1 have ValidateSet on -Profile. Test-CargoInstalled uses `-join` + `(?m)` multiline matching. `node` removed from brew.txt with explanatory comment. `fzf` added to brew.txt.</done>
</task>

</tasks>

<verification>
Run full code-fix verification:

```bash
echo "=== COMPAT-01: Bash 3.2 warn-not-block ==="
grep -c 'return 0' src/core/platform.sh  # Should have the new return 0 for macOS
grep 'DETECTED_OS.*macos' src/core/platform.sh | head -1

echo ""
echo "=== QUAL-01: pipefail in all subshell scripts ==="
MISSING=0
for f in src/platforms/linux/main.sh src/platforms/macos/main.sh \
         src/platforms/linux/install/apt.sh src/platforms/linux/install/flatpak.sh \
         src/platforms/linux/install/snap.sh src/platforms/linux/install/cargo.sh \
         src/platforms/macos/install/homebrew.sh src/platforms/macos/install/brew.sh \
         src/platforms/macos/install/brew-cask.sh \
         src/install/dev-env.sh src/install/rust-cli.sh src/install/ai-tools.sh; do
    head -3 "$f" | grep -q 'set -o pipefail' || { echo "MISSING: $f"; MISSING=$((MISSING+1)); }
done
echo "Missing pipefail: $MISSING (expect 0)"

echo ""
echo "=== QUAL-02: PS + brew fixes ==="
grep -c 'ValidateSet' setup.ps1
grep -c 'ValidateSet' src/platforms/windows/main.ps1
grep -c '\-join' src/platforms/windows/core/idempotent.psm1
echo "node in brew.txt: $(grep -c '^node$' data/packages/brew.txt) (expect 0)"
echo "fzf in brew.txt: $(grep -c '^fzf$' data/packages/brew.txt) (expect 1)"
```
</verification>

<success_criteria>
1. `verify_bash_version()` contains `return 0` path for macOS Bash < 4 with `log_warn`
2. All 12 subshell scripts contain `set -o pipefail` within first 3 lines
3. `setup.ps1` has `[ValidateSet('minimal', 'developer', 'full')]` on -Profile
4. `main.ps1` has `[ValidateSet('', 'minimal', 'developer', 'full')]` on -Profile
5. `Test-CargoInstalled` uses `(cargo install --list 2>$null) -join` and `(?m)` multiline regex
6. `grep '^node$' data/packages/brew.txt` returns no match
7. `grep '^fzf$' data/packages/brew.txt` returns a match
</success_criteria>

<output>
After completion, create `.planning/phases/15-data-compatibility-fixes/15-02-SUMMARY.md`
</output>
