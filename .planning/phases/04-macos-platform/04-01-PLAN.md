---
phase: 04-macos-platform
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platforms/macos/install/homebrew.sh
autonomous: true

must_haves:
  truths:
    - "Running homebrew.sh on fresh macOS installs Homebrew automatically"
    - "Running homebrew.sh on Mac with Homebrew already installed skips installation"
    - "After installation, brew command is available in the same session"
    - "Shell profile is configured with brew shellenv for future sessions"
    - "DRY_RUN=true shows what would be done without installing or modifying files"
  artifacts:
    - path: "src/platforms/macos/install/homebrew.sh"
      provides: "Homebrew installation with idempotency"
      exports: ["install_homebrew", "configure_shell_path"]
  key_links:
    - from: "src/platforms/macos/install/homebrew.sh"
      to: "src/core/logging.sh"
      via: "source at top"
      pattern: "source.*logging.sh"
    - from: "src/platforms/macos/install/homebrew.sh"
      to: "src/core/idempotent.sh"
      via: "source at top"
      pattern: "source.*idempotent.sh"
---

<objective>
Create the Homebrew installation script for macOS that installs Homebrew if not present and configures PATH.

Purpose: Foundation for all macOS package installation - Homebrew must exist before brew.sh and brew-cask.sh can work.
Output: `src/platforms/macos/install/homebrew.sh` - idempotent Homebrew installer
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-macos-platform/04-RESEARCH.md

# Reference existing patterns
@src/platforms/linux/install/apt.sh
@src/core/idempotent.sh
@src/core/logging.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create homebrew.sh installer</name>
  <files>src/platforms/macos/install/homebrew.sh</files>
  <action>
Create `src/platforms/macos/install/homebrew.sh` following the apt.sh pattern:

1. Header and source guards (NO set -e per Phase 1 decision)
2. Source core utilities relative to script location:
   ```bash
   source "${SCRIPT_DIR}/../../../core/logging.sh"
   source "${SCRIPT_DIR}/../../../core/idempotent.sh"
   ```

3. `install_homebrew()` function:
   - Check if brew already installed: `command -v brew &>/dev/null`
   - If installed, log_ok and return 0
   - **DRY_RUN check** before any mutation:
     ```bash
     if [[ "${DRY_RUN:-}" == "true" ]]; then
         log_info "[DRY_RUN] Would install Homebrew via official installer"
         log_info "[DRY_RUN] Would configure shell PATH for brew"
         return 0
     fi
     ```
   - Check Xcode CLI tools: `xcode-select -p &>/dev/null`
   - If missing, run `xcode-select --install` and wait for GUI completion (read -r)
   - Install Homebrew with NONINTERACTIVE=1:
     ```bash
     NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
     ```
   - Configure PATH for current session (eval brew shellenv)
   - Verify brew command works after install

4. `configure_shell_path()` function:
   - Detect shell: zsh -> ~/.zprofile, bash -> ~/.bash_profile
   - Check if already configured: `grep -q "brew shellenv" "$rc_file"`
   - **DRY_RUN check** before modifying shell profile:
     ```bash
     if [[ "${DRY_RUN:-}" == "true" ]]; then
         log_info "[DRY_RUN] Would add brew shellenv to $rc_file"
         return 0
     fi
     ```
   - If not configured, use `ensure_line_in_file` from idempotent.sh
   - Detect architecture for correct brew path (/opt/homebrew vs /usr/local)

**CRITICAL:** DRY_RUN check uses `== "true"` (not `-n`) because config.sh sets DRY_RUN=false.
Per Phase 3 decision [03-04] in STATE.md.

5. Make executable: chmod +x

Key details from research:
- NONINTERACTIVE=1 skips y/n prompts
- Must eval brew shellenv immediately after install for current session
- Apple Silicon: /opt/homebrew, Intel: /usr/local
- Never use sudo with brew commands
  </action>
  <verify>
Test on macOS (can be manual verification):
1. `bash src/platforms/macos/install/homebrew.sh` runs without error
2. Running twice shows "Homebrew already installed" message
3. `brew --version` works after script completes
  </verify>
  <done>
homebrew.sh exists with install_homebrew() and configure_shell_path() functions, sources core utilities, uses NONINTERACTIVE=1 for non-interactive installation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create install directory structure</name>
  <files>src/platforms/macos/install/.gitkeep</files>
  <action>
Create the directory structure if it doesn't exist:
```bash
mkdir -p src/platforms/macos/install
```

The directory may already exist (src/platforms/macos/ was created in Phase 2), but install/ subdirectory needs to be created for the homebrew.sh file.
  </action>
  <verify>
`ls -la src/platforms/macos/install/` shows the directory exists
  </verify>
  <done>
Directory structure exists for macOS installers
  </done>
</task>

</tasks>

<verification>
1. File exists: `test -f src/platforms/macos/install/homebrew.sh`
2. File is executable: `test -x src/platforms/macos/install/homebrew.sh`
3. Shellcheck passes: `shellcheck src/platforms/macos/install/homebrew.sh`
4. Sources core utilities (grep for source.*core)
5. Contains idempotency check (grep for "command -v brew")
6. Contains NONINTERACTIVE pattern (grep for NONINTERACTIVE=1)
7. Contains DRY_RUN checks (grep for 'DRY_RUN.*==.*true')
</verification>

<success_criteria>
- homebrew.sh created with correct structure
- Script sources logging.sh and idempotent.sh
- install_homebrew() function handles both fresh and existing installations
- configure_shell_path() uses ensure_line_in_file for idempotency
- No sudo used with brew commands
- Handles both Apple Silicon (/opt/homebrew) and Intel (/usr/local)
- DRY_RUN=true previews without installing or modifying files (uses == "true" check)
</success_criteria>

<output>
After completion, create `.planning/phases/04-macos-platform/04-01-SUMMARY.md`
</output>
