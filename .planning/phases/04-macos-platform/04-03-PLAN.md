---
phase: 04-macos-platform
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - src/platforms/macos/main.sh
  - data/packages/profiles/minimal.txt
  - data/packages/profiles/developer.txt
  - data/packages/profiles/full.txt
autonomous: true

must_haves:
  truths:
    - "User sees profile selection menu when running main.sh directly (no args)"
    - "User can select minimal, developer, or full profile from interactive menu"
    - "setup.sh passes profile as $1 to main.sh for unattended mode"
    - "main.sh with $1 arg runs install_profile() directly, no menu"
    - "Selected profile installs corresponding brew and brew-cask packages"
    - "Script checks Bash version and provides upgrade instructions if < 4.0"
    - "Profile files list all platforms; main.sh filters to macOS-relevant files"
  artifacts:
    - path: "src/platforms/macos/main.sh"
      provides: "Main orchestrator with profile menu and installation"
      exports: ["show_menu", "install_profile"]
    - path: "data/packages/profiles/minimal.txt"
      provides: "Minimal profile package list for macOS"
      contains: "brew.txt"
    - path: "data/packages/profiles/developer.txt"
      provides: "Developer profile package list for macOS"
      contains: "brew.txt"
    - path: "data/packages/profiles/full.txt"
      provides: "Full profile package list for macOS"
      contains: "brew.txt"
  key_links:
    - from: "src/platforms/macos/main.sh"
      to: "src/platforms/macos/install/homebrew.sh"
      via: "bash call in install_profile()"
      pattern: "bash.*homebrew.sh"
    - from: "src/platforms/macos/main.sh"
      to: "src/platforms/macos/install/brew.sh"
      via: "case dispatch in install_profile() loop"
      pattern: "brew\\.txt\\).*brew\\.sh"
    - from: "src/platforms/macos/main.sh"
      to: "src/platforms/macos/install/brew-cask.sh"
      via: "case dispatch in install_profile() loop"
      pattern: "brew-cask\\.txt\\).*brew-cask\\.sh"
    - from: "src/platforms/macos/main.sh"
      to: "data/packages/profiles/*.txt"
      via: "read profile file in install_profile()"
      pattern: "profile_file.*profiles.*\\.txt"
    - from: "setup.sh"
      to: "src/platforms/macos/main.sh"
      via: "case macos dispatch with $profile arg"
      pattern: "bash.*macos_main.*\\$profile"
---

<objective>
Create the macOS main orchestrator with profile selection menu and update profiles to include brew packages.

Purpose: Provide the interactive entry point for macOS setup matching Linux experience, with profile-based installation.
Output: `src/platforms/macos/main.sh` with profile menu and working profile definitions
</objective>

<execution_context>
@/Users/bragatte/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bragatte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-macos-platform/04-RESEARCH.md

# Reference existing patterns
@src/platforms/linux/main.sh
@src/core/platform.sh
@src/core/packages.sh
@setup.sh
@data/packages/profiles/minimal.txt
@data/packages/profiles/developer.txt
@data/packages/profiles/full.txt

# From Plan 01 and 02
@src/platforms/macos/install/homebrew.sh
@src/platforms/macos/install/brew.sh
@src/platforms/macos/install/brew-cask.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create macOS main.sh orchestrator</name>
  <files>src/platforms/macos/main.sh</files>
  <action>
Create `src/platforms/macos/main.sh` following linux/main.sh pattern:

1. Header with script description
2. NO set -e
3. SCRIPT_DIR detection
4. Source core utilities:
   ```bash
   source "${SCRIPT_DIR}/../../core/logging.sh"
   source "${SCRIPT_DIR}/../../core/platform.sh"
   source "${SCRIPT_DIR}/../../core/packages.sh"
   source "${SCRIPT_DIR}/../../core/errors.sh"
   ```

5. Cleanup trap

6. `check_bash_upgrade()` function:
   - Check DETECTED_BASH or BASH_VERSINFO
   - If < 4.0, log_error and show upgrade instructions:
     ```
     brew install bash
     sudo sh -c 'echo /opt/homebrew/bin/bash >> /etc/shells'
     chsh -s /opt/homebrew/bin/bash
     ```
   - If non-interactive, warn but continue
   - If interactive, exit with clear instructions

7. `show_menu()` function:
   - Display macOS-themed banner (use Apple icon if UTF-8 available)
   - Show profile options:
     1. Minimal (essential tools only)
     2. Developer (system + dev tools)
     3. Full (everything + AI tools)
     0. Exit

8. `install_profile()` function (the core logic):
   - Takes profile name as argument
   - First, ensure Homebrew is installed:
     ```bash
     bash "${SCRIPT_DIR}/install/homebrew.sh"
     ```
   - Read profile file directly and dispatch to appropriate installers:
     ```bash
     install_profile() {
         local profile_name="$1"
         local profile_file="${DATA_DIR}/packages/profiles/${profile_name}.txt"

         # Validate profile exists
         if [[ ! -f "$profile_file" ]]; then
             log_error "Profile not found: $profile_name"
             return 1
         fi

         log_info "Profile: $profile_name"

         # Ensure Homebrew is installed first
         # Note: homebrew.sh has its own DRY_RUN check internally
         bash "${SCRIPT_DIR}/install/homebrew.sh" || return 1

         # Read profile and dispatch to macOS-relevant installers
         # Note: each installer has its own DRY_RUN check — no gate here
         while IFS= read -r pkg_file || [[ -n "$pkg_file" ]]; do
             # Skip comments and empty lines
             pkg_file="${pkg_file#"${pkg_file%%[![:space:]]*}"}"
             [[ -z "$pkg_file" || "$pkg_file" == \#* ]] && continue

             # Dispatch based on package file type (PLATFORM FILTERING)
             case "$pkg_file" in
                 brew.txt)
                     log_info "Installing brew packages..."
                     bash "${SCRIPT_DIR}/install/brew.sh"
                     ;;
                 brew-cask.txt)
                     log_info "Installing brew cask packages..."
                     bash "${SCRIPT_DIR}/install/brew-cask.sh"
                     ;;
                 apt.txt)
                     # Linux-only - skip silently on macOS
                     log_debug "Skipping apt.txt (Linux only)"
                     ;;
                 cargo.txt|npm.txt)
                     log_info "Skipping $pkg_file (requires Phase 5)"
                     ;;
                 ai-tools.txt)
                     log_info "Skipping ai-tools.txt (requires Phase 5)"
                     ;;
                 *)
                     log_warn "Unknown package file: $pkg_file"
                     ;;
             esac
         done < "$profile_file"
     }
     ```

**DRY_RUN design:** DRY_RUN is NOT checked in main.sh itself — each sub-script
(homebrew.sh, brew.sh, brew-cask.sh) checks DRY_RUN at the point of mutation.
This ensures `DRY_RUN=true bash brew.sh` also works when called directly.

9. **Dual-mode operation (PROF-04 requirement):**
   ```bash
   # Check for command-line argument FIRST
   if [[ -n "${1:-}" ]]; then
       # UNATTENDED MODE: profile passed from setup.sh
       local profile="$1"
       log_info "Running in unattended mode with profile: $profile"
       install_profile "$profile"
       exit $?
   fi

   # INTERACTIVE MODE: no argument, show menu
   while true; do
       show_menu
       read -p "Enter your choice (0-3): " choice

       case $choice in
           1) install_profile "minimal" ;;
           2) install_profile "developer" ;;
           3) install_profile "full" ;;
           0) log_info "Exiting..."; exit 0 ;;
           *) log_warn "Invalid choice" ;;
       esac

       read -p "Press Enter to continue..."
   done
   ```

10. Make executable: chmod +x

Important details:
- Bash 3.2 limitation means we can't use select builtin reliably on fresh macOS. Use simple read/case instead.
- **Design asymmetry note:** Linux main.sh currently uses direct menu options (APT, Cargo, etc.), NOT profile-based dispatch. macOS main.sh uses profile dispatch (better design). Linux main.sh should be updated to same pattern in Phase 5. This is intentional for Phase 4 scope.
  </action>
  <verify>
1. `shellcheck src/platforms/macos/main.sh` passes
2. `grep -q "install/homebrew.sh" src/platforms/macos/main.sh` succeeds
3. `grep -q "install/brew.sh" src/platforms/macos/main.sh` succeeds
4. File is executable
  </verify>
  <done>
main.sh created with profile selection menu, Homebrew installation call, and profile-based package installation
  </done>
</task>

<task type="auto">
  <name>Task 2: Update profiles to include brew packages</name>
  <files>
    data/packages/profiles/minimal.txt
    data/packages/profiles/developer.txt
    data/packages/profiles/full.txt
  </files>
  <action>
Update profile files to include macOS-specific package files. The profiles are PLATFORM-AGNOSTIC - each platform's main.sh filters to only process relevant files.

**Design decision:** Single profile files listing ALL platforms (simpler than platform-specific profiles). Each platform's main.sh contains a case statement that:
- Processes its own package files (brew.txt, apt.txt, etc.)
- Silently skips other platform's files (no warnings on every install)

**minimal.txt:**
```
# Minimal profile - essential system packages only
# Platform-agnostic: each main.sh filters to relevant files

# Linux
apt.txt

# macOS
brew.txt
```

**developer.txt:**
```
# Developer profile - system + development tools
# Platform-agnostic: each main.sh filters to relevant files

# Linux
apt.txt

# macOS
brew.txt
brew-cask.txt

# Cross-platform (Phase 5)
cargo.txt
npm.txt
```

**full.txt:**
```
# Full profile - all packages including AI tools
# Platform-agnostic: each main.sh filters to relevant files

# Linux
apt.txt

# macOS
brew.txt
brew-cask.txt

# Cross-platform (Phase 5)
cargo.txt
npm.txt
ai-tools.txt
```

**Why this design:**
- SSoT: One profile definition per tier (minimal/developer/full)
- No duplication: Avoids minimal-macos.txt, minimal-linux.txt variants
- Platform filtering: Handled in main.sh dispatch logic (see Task 1)
- Silent skip: apt.txt skipped silently on macOS (no warning spam)
  </action>
  <verify>
1. `grep -q "brew.txt" data/packages/profiles/minimal.txt` succeeds
2. `grep -q "brew-cask.txt" data/packages/profiles/developer.txt` succeeds
3. `grep -q "brew-cask.txt" data/packages/profiles/full.txt` succeeds
  </verify>
  <done>
Profile files updated to include brew.txt and brew-cask.txt for macOS support
  </done>
</task>

</tasks>

<verification>
1. main.sh exists and is executable
2. main.sh shellcheck clean
3. main.sh sources core utilities
4. main.sh calls homebrew.sh, brew.sh, brew-cask.sh
5. main.sh has profile menu with minimal/developer/full options
6. main.sh checks Bash version and provides upgrade path
7. Profiles include brew.txt and brew-cask.txt
8. setup.sh dispatch to macos/main.sh now works (file exists)
</verification>

<success_criteria>
- INTERACTIVE: `./src/platforms/macos/main.sh` (no args) shows profile menu
- INTERACTIVE: Menu selection (1/2/3) triggers install_profile() for that profile
- UNATTENDED: `./setup.sh developer` passes "developer" to main.sh as $1
- UNATTENDED: main.sh with $1 runs install_profile("$1") directly, no menu
- DUAL-MODE: Same main.sh handles both modes via $1 check
- Homebrew is installed first (via homebrew.sh)
- Bash version check provides clear upgrade instructions if needed
- PLATFORM-FILTER: apt.txt skipped silently on macOS, brew.txt processed
- DRY_RUN: Handled by sub-scripts (homebrew.sh, brew.sh, brew-cask.sh), not in main.sh
- All 5 Phase 4 success criteria from ROADMAP are achievable after this plan
- Known asymmetry: Linux main.sh not yet profile-based (deferred to Phase 5)
</success_criteria>

<output>
After completion, create `.planning/phases/04-macos-platform/04-03-SUMMARY.md`
</output>
